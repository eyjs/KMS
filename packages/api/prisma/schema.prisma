generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// 사용자
// ============================================================

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  name         String   @db.VarChar(100)
  role         String   @default("EDITOR") @db.VarChar(20)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  createdDocuments   Document[]          @relation("CreatedBy")
  updatedDocuments   Document[]          @relation("UpdatedBy")
  createdRelations   Relation[]          @relation("RelationCreatedBy")
  documentHistory    DocumentHistory[]
  feedbacks          Feedback[]
  placedDocuments    DocumentPlacement[] @relation("PlacedBy")
  uploadedVersions   DocumentVersion[]   @relation("VersionUploadedBy")
  groupMemberships   UserGroupMembership[]

  @@map("users")
}

// ============================================================
// 도메인 마스터
// ============================================================

model DomainMaster {
  code          String   @id @db.VarChar(20)
  displayName   String   @map("display_name") @db.VarChar(100)
  parentCode    String?  @map("parent_code") @db.VarChar(20)
  description   String?  @db.VarChar(500)
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")

  parent          DomainMaster?       @relation("DomainTree", fields: [parentCode], references: [code])
  children        DomainMaster[]      @relation("DomainTree")
  categories      DomainCategory[]
  placements      DocumentPlacement[]
  relations       Relation[]          @relation("RelationDomain")

  @@index([parentCode])
  @@map("domain_master")
}

// ============================================================
// 도메인 카테고리 (폴더 구조)
// ============================================================

model DomainCategory {
  id             Int      @id @default(autoincrement())
  code           String   @unique @db.VarChar(50)                    // 불변 코드 (자동 채번, 예: GA-F01)
  domainCode     String   @map("domain_code") @db.VarChar(20)
  parentId       Int?     @map("parent_id")
  name           String   @db.VarChar(100)                           // 표시명 (변경 가능)
  sortOrder      Int      @default(0) @map("sort_order")
  accessLevel    String   @default("INHERIT") @map("access_level") @db.VarChar(20)  // INHERIT, RESTRICTED, PUBLIC
  allowedRoles   String[] @default([]) @map("allowed_roles")         // RESTRICTED 시 허용 역할
  allowedUserIds String[] @default([]) @map("allowed_user_ids") @db.Uuid  // RESTRICTED 시 허용 사용자 ID
  createdAt      DateTime @default(now()) @map("created_at")

  domain      DomainMaster        @relation(fields: [domainCode], references: [code], onDelete: Cascade)
  parent      DomainCategory?     @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children    DomainCategory[]    @relation("CategoryTree")
  placements  DocumentPlacement[]
  groupAccess GroupFolderAccess[]

  @@unique([domainCode, parentId, name])
  @@index([domainCode])
  @@index([parentId])
  @@map("domain_categories")
}

// ============================================================
// 문서-도메인 배치 (바로가기, M:N)
// ============================================================

model DocumentPlacement {
  id            String   @id @default(uuid()) @db.Uuid
  documentId    String   @map("document_id") @db.Uuid
  domainCode    String   @map("domain_code") @db.VarChar(20)
  categoryId    Int?     @map("category_id")
  placementCode String?  @unique @map("placement_code") @db.VarChar(100)  // 경로 기반 배치 코드 (예: GA-F01/DOC-001)
  placedBy      String?  @map("placed_by") @db.Uuid
  placedAt      DateTime @default(now()) @map("placed_at")
  alias         String?  @db.VarChar(200)
  note          String?  @db.VarChar(500)

  document Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  domain   DomainMaster    @relation(fields: [domainCode], references: [code], onDelete: Cascade)
  category DomainCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  user     User?           @relation("PlacedBy", fields: [placedBy], references: [id], onDelete: SetNull)

  @@unique([documentId, domainCode])
  @@index([documentId])
  @@index([domainCode])
  @@index([categoryId])
  @@map("document_placements")
}

// ============================================================
// 문서
// ============================================================

model Document {
  id                 String   @id @default(uuid()) @db.Uuid
  docCode            String?  @unique @map("doc_code") @db.VarChar(30)
  lifecycle          String   @default("DRAFT") @db.VarChar(20)
  securityLevel      String   @default("INTERNAL") @map("security_level") @db.VarChar(20)
  filePath           String?  @map("file_path")
  fileName           String?  @map("file_name")
  fileType           String?  @map("file_type") @db.VarChar(10)
  fileSize           BigInt?  @map("file_size")
  fileHash           String?  @map("file_hash") @db.VarChar(64)
  versionMajor       Int      @default(1) @map("version_major")
  versionMinor       Int      @default(0) @map("version_minor")
  reviewedAt         DateTime? @map("reviewed_at")
  validUntil         DateTime? @map("valid_until")
  createdById        String?  @map("created_by") @db.Uuid
  updatedById        String?  @map("updated_by") @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at")
  isDeleted          Boolean  @default(false) @map("is_deleted")
  rowVersion         Int      @default(1) @map("row_version")

  createdBy       User?             @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy       User?             @relation("UpdatedBy", fields: [updatedById], references: [id])
  sourceRelations Relation[]        @relation("SourceDoc")
  targetRelations Relation[]        @relation("TargetDoc")
  history         DocumentHistory[]
  placements      DocumentPlacement[]
  versions        DocumentVersion[]

  @@index([lifecycle])
  @@index([securityLevel])
  @@index([isDeleted])
  @@index([fileHash])
  @@index([fileName])
  @@map("documents")
}

// ============================================================
// 관계
// ============================================================

model Relation {
  id           String   @id @default(uuid()) @db.Uuid
  sourceId     String   @map("source_id") @db.Uuid
  targetId     String   @map("target_id") @db.Uuid
  relationType String   @map("relation_type") @db.VarChar(20)
  domainCode   String?  @map("domain_code") @db.VarChar(20)
  createdById  String?  @map("created_by") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  source    Document      @relation("SourceDoc", fields: [sourceId], references: [id], onDelete: Cascade)
  target    Document      @relation("TargetDoc", fields: [targetId], references: [id], onDelete: Cascade)
  createdBy User?         @relation("RelationCreatedBy", fields: [createdById], references: [id])
  domain    DomainMaster? @relation("RelationDomain", fields: [domainCode], references: [code], onDelete: Cascade)

  // 유니크 제약은 마이그레이션 SQL에서 partial index로 처리
  @@index([sourceId])
  @@index([targetId])
  @@index([domainCode])
  @@map("relations")
}

// ============================================================
// 문서 이력
// ============================================================

model DocumentHistory {
  id         String   @id @default(uuid()) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  action     String   @db.VarChar(20)
  changes    Json?
  userId     String?  @map("user_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id])

  @@index([documentId])
  @@index([createdAt])
  @@index([action, createdAt])
  @@map("document_history")
}

// ============================================================
// API 키
// ============================================================

model ApiKey {
  id         Int       @id @default(autoincrement())
  keyHash    String    @unique @map("key_hash") @db.VarChar(64)
  keyPrefix  String    @map("key_prefix") @db.VarChar(8)
  name       String    @db.VarChar(100)
  role       String    @default("VIEWER") @db.VarChar(20)
  expiresAt  DateTime? @map("expires_at")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  groupMemberships ApiKeyGroupMembership[]

  @@index([keyHash])
  @@map("api_keys")
}

// ============================================================
// API Key-그룹 멤버십 (M:N)
// ============================================================

model ApiKeyGroupMembership {
  id        String   @id @default(uuid()) @db.Uuid
  apiKeyId  Int      @map("api_key_id")
  groupId   String   @map("group_id") @db.Uuid
  joinedAt  DateTime @default(now()) @map("joined_at")

  apiKey ApiKey          @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  group  PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([apiKeyId, groupId])
  @@index([apiKeyId])
  @@index([groupId])
  @@map("api_key_group_memberships")
}

// ============================================================
// 문서 버전 이력
// ============================================================

model DocumentVersion {
  id            String   @id @default(uuid()) @db.Uuid
  documentId    String   @map("document_id") @db.Uuid
  versionMajor  Int      @map("version_major")
  versionMinor  Int      @map("version_minor")
  filePath      String   @map("file_path")
  fileName      String   @map("file_name")
  fileType      String   @map("file_type") @db.VarChar(10)
  fileSize      BigInt   @map("file_size")
  fileHash      String   @map("file_hash") @db.VarChar(64)
  uploadedById  String?  @map("uploaded_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy User?    @relation("VersionUploadedBy", fields: [uploadedById], references: [id])

  @@index([documentId])
  @@map("document_versions")
}

// ============================================================
// 피드백
// ============================================================

model Feedback {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  category  String   @db.VarChar(20)
  title     String   @db.VarChar(200)
  content   String   @db.Text
  status    String   @default("OPEN") @db.VarChar(20)
  adminNote String?  @map("admin_note") @db.Text
  pageUrl   String?  @map("page_url") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("feedback")
}

// ============================================================
// 권한 그룹
// ============================================================

model PermissionGroup {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  description String?  @db.VarChar(500)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  memberships       UserGroupMembership[]
  folderAccess      GroupFolderAccess[]
  apiKeyMemberships ApiKeyGroupMembership[]

  @@map("permission_groups")
}

// ============================================================
// 사용자-그룹 멤버십 (M:N)
// ============================================================

model UserGroupMembership {
  id       String   @id @default(uuid()) @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  groupId  String   @map("group_id") @db.Uuid
  joinedAt DateTime @default(now()) @map("joined_at")

  user  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  group PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("user_group_memberships")
}

// ============================================================
// 그룹-폴더 권한 (M:N, 권한 수준 포함)
// ============================================================

model GroupFolderAccess {
  id              String   @id @default(uuid()) @db.Uuid
  groupId         String   @map("group_id") @db.Uuid
  categoryId      Int      @map("category_id")
  accessType      String   @map("access_type") @db.VarChar(10) // READ | WRITE
  includeChildren Boolean  @default(true) @map("include_children")
  grantedAt       DateTime @default(now()) @map("granted_at")

  group    PermissionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  category DomainCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([groupId, categoryId])
  @@index([groupId])
  @@index([categoryId])
  @@map("group_folder_access")
}

// ============================================================
// Webhook (외부 시스템 알림)
// ============================================================

model Webhook {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(100)
  url         String   @db.VarChar(500)
  secret      String?  @db.VarChar(100)             // HMAC 서명용 시크릿
  events      String[] @default([])                 // 구독할 이벤트 목록
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  lastCalledAt DateTime? @map("last_called_at")
  failCount    Int     @default(0) @map("fail_count")

  deliveries WebhookDelivery[]

  @@index([isActive])
  @@map("webhooks")
}

// ============================================================
// Webhook 전송 이력
// ============================================================

model WebhookDelivery {
  id           String   @id @default(uuid()) @db.Uuid
  webhookId    String   @map("webhook_id") @db.Uuid
  event        String   @db.VarChar(50)
  payload      Json
  statusCode   Int?     @map("status_code")
  responseBody String?  @map("response_body") @db.Text
  duration     Int?                                  // 응답 시간 (ms)
  success      Boolean  @default(false)
  errorMessage String?  @map("error_message") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_deliveries")
}
