generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// 사용자
// ============================================================

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  name         String   @db.VarChar(100)
  role         String   @default("EDITOR") @db.VarChar(20)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  createdDocuments   Document[]          @relation("CreatedBy")
  updatedDocuments   Document[]          @relation("UpdatedBy")
  createdRelations   Relation[]          @relation("RelationCreatedBy")
  documentHistory    DocumentHistory[]
  feedbacks          Feedback[]
  placedDocuments    DocumentPlacement[] @relation("PlacedBy")

  @@map("users")
}

// ============================================================
// 도메인 마스터
// ============================================================

model DomainMaster {
  code          String   @id @db.VarChar(20)
  displayName   String   @map("display_name") @db.VarChar(100)
  parentCode    String?  @map("parent_code") @db.VarChar(20)
  description   String?  @db.VarChar(500)
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")

  parent          DomainMaster?       @relation("DomainTree", fields: [parentCode], references: [code])
  children        DomainMaster[]      @relation("DomainTree")
  categories      DomainCategory[]
  placements      DocumentPlacement[]
  relations       Relation[]          @relation("RelationDomain")

  @@index([parentCode])
  @@map("domain_master")
}

// ============================================================
// 도메인 카테고리 (폴더 구조)
// ============================================================

model DomainCategory {
  id         Int      @id @default(autoincrement())
  domainCode String   @map("domain_code") @db.VarChar(20)
  parentId   Int?     @map("parent_id")
  name       String   @db.VarChar(100)
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  domain     DomainMaster       @relation(fields: [domainCode], references: [code], onDelete: Cascade)
  parent     DomainCategory?    @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children   DomainCategory[]   @relation("CategoryTree")
  placements DocumentPlacement[]

  @@unique([domainCode, parentId, name])
  @@index([domainCode])
  @@index([parentId])
  @@map("domain_categories")
}

// ============================================================
// 문서-도메인 배치 (바로가기, M:N)
// ============================================================

model DocumentPlacement {
  id         String   @id @default(uuid()) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  domainCode String   @map("domain_code") @db.VarChar(20)
  categoryId Int?     @map("category_id")
  placedBy   String?  @map("placed_by") @db.Uuid
  placedAt   DateTime @default(now()) @map("placed_at")
  alias      String?  @db.VarChar(200)
  note       String?  @db.VarChar(500)

  document Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  domain   DomainMaster    @relation(fields: [domainCode], references: [code], onDelete: Cascade)
  category DomainCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  user     User?           @relation("PlacedBy", fields: [placedBy], references: [id], onDelete: SetNull)

  @@unique([documentId, domainCode])
  @@index([documentId])
  @@index([domainCode])
  @@index([categoryId])
  @@map("document_placements")
}

// ============================================================
// 문서
// ============================================================

model Document {
  id                 String   @id @default(uuid()) @db.Uuid
  docCode            String?  @unique @map("doc_code") @db.VarChar(30)
  lifecycle          String   @default("DRAFT") @db.VarChar(20)
  securityLevel      String   @default("INTERNAL") @map("security_level") @db.VarChar(20)
  filePath           String?  @map("file_path")
  fileName           String?  @map("file_name")
  fileType           String?  @map("file_type") @db.VarChar(10)
  fileSize           BigInt?  @map("file_size")
  fileHash           String?  @unique @map("file_hash") @db.VarChar(64)
  versionMajor       Int      @default(1) @map("version_major")
  versionMinor       Int      @default(0) @map("version_minor")
  reviewedAt         DateTime? @map("reviewed_at")
  validUntil         DateTime? @map("valid_until")
  createdById        String?  @map("created_by") @db.Uuid
  updatedById        String?  @map("updated_by") @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at")
  isDeleted          Boolean  @default(false) @map("is_deleted")
  rowVersion         Int      @default(1) @map("row_version")

  createdBy       User?             @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy       User?             @relation("UpdatedBy", fields: [updatedById], references: [id])
  sourceRelations Relation[]        @relation("SourceDoc")
  targetRelations Relation[]        @relation("TargetDoc")
  history         DocumentHistory[]
  placements      DocumentPlacement[]

  @@index([lifecycle])
  @@index([securityLevel])
  @@index([isDeleted])
  @@index([fileHash])
  @@map("documents")
}

// ============================================================
// 관계
// ============================================================

model Relation {
  id           String   @id @default(uuid()) @db.Uuid
  sourceId     String   @map("source_id") @db.Uuid
  targetId     String   @map("target_id") @db.Uuid
  relationType String   @map("relation_type") @db.VarChar(20)
  domainCode   String?  @map("domain_code") @db.VarChar(20)
  createdById  String?  @map("created_by") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  source    Document      @relation("SourceDoc", fields: [sourceId], references: [id], onDelete: Cascade)
  target    Document      @relation("TargetDoc", fields: [targetId], references: [id], onDelete: Cascade)
  createdBy User?         @relation("RelationCreatedBy", fields: [createdById], references: [id])
  domain    DomainMaster? @relation("RelationDomain", fields: [domainCode], references: [code], onDelete: Cascade)

  // 유니크 제약은 마이그레이션 SQL에서 partial index로 처리
  @@index([sourceId])
  @@index([targetId])
  @@index([domainCode])
  @@map("relations")
}

// ============================================================
// 문서 이력
// ============================================================

model DocumentHistory {
  id         String   @id @default(uuid()) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  action     String   @db.VarChar(20)
  changes    Json?
  userId     String?  @map("user_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id])

  @@index([documentId])
  @@index([createdAt])
  @@map("document_history")
}

// ============================================================
// API 키
// ============================================================

model ApiKey {
  id         Int       @id @default(autoincrement())
  keyHash    String    @unique @map("key_hash") @db.VarChar(64)
  keyPrefix  String    @map("key_prefix") @db.VarChar(8)
  name       String    @db.VarChar(100)
  role       String    @default("VIEWER") @db.VarChar(20)
  expiresAt  DateTime? @map("expires_at")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  @@index([keyHash])
  @@map("api_keys")
}

// ============================================================
// 피드백
// ============================================================

model Feedback {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  category  String   @db.VarChar(20)
  title     String   @db.VarChar(200)
  content   String   @db.Text
  status    String   @default("OPEN") @db.VarChar(20)
  adminNote String?  @map("admin_note") @db.Text
  pageUrl   String?  @map("page_url") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("feedback")
}
