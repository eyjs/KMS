<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMS Admin - ì§€ì‹ê´€ë¦¬ì²´ê³„ ê²€ì¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        #network { width: 100%; height: 100%; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">

<div id="app" class="flex h-full">

    <!-- Toast ì•Œë¦¼ -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
        <div v-for="(toast, idx) in toasts" :key="idx"
            :class="toast.type === 'error' ? 'bg-red-500' : toast.type === 'warning' ? 'bg-yellow-500' : 'bg-green-500'"
            class="toast text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 max-w-sm">
            <span>{{ toast.message }}</span>
            <button @click="removeToast(idx)" class="ml-2 hover:opacity-70">&times;</button>
        </div>
    </div>

    <!-- LEFT SIDEBAR -->
    <aside class="w-72 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-100">
            <h1 class="text-lg font-bold text-gray-800">KMS Admin</h1>
            <p class="text-xs text-gray-500">ë¬¸ì„œì²´ê³„ ê²€ì¦ ë„êµ¬</p>
        </div>

        <!-- Taxonomy Tabs -->
        <div class="flex-1 overflow-y-auto scrollbar-thin p-3">
            <div class="flex gap-1 mb-3">
                <button @click="activeTab = 'carriers'"
                    :class="activeTab === 'carriers' ? 'bg-purple-100 text-purple-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ë³´í—˜ì‚¬</button>
                <button @click="activeTab = 'products'"
                    :class="activeTab === 'products' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ìƒí’ˆ</button>
                <button @click="activeTab = 'docTypes'"
                    :class="activeTab === 'docTypes' ? 'bg-green-100 text-green-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ë¬¸ì„œìœ í˜•</button>
            </div>

            <!-- Carriers -->
            <div v-if="activeTab === 'carriers'" class="space-y-2">
                <div v-for="(carrier, id) in store.taxonomy.carriers" :key="id"
                    @click="selectTaxonomy('carrier', id)"
                    :class="selectedTaxonomy.type === 'carrier' && selectedTaxonomy.id === id ? 'ring-2 ring-purple-400' : ''"
                    class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">{{ carrier.name }}</span>
                        <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded">{{ getDocCountByCarrier(id) }}ê±´</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">ë³„ì¹­: {{ carrier.alias?.join(', ') || '-' }}</div>
                </div>
                <button @click="showAddModal('carrier')"
                    class="w-full p-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm hover:border-purple-400 hover:text-purple-600 transition">
                    + ë³´í—˜ì‚¬ ì¶”ê°€
                </button>
            </div>

            <!-- Products -->
            <div v-if="activeTab === 'products'" class="space-y-2">
                <div v-for="(product, id) in store.taxonomy.products" :key="id"
                    @click="selectTaxonomy('product', id)"
                    :class="selectedTaxonomy.type === 'product' && selectedTaxonomy.id === id ? 'ring-2 ring-blue-400' : ''"
                    class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">{{ product.name }}</span>
                        <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">{{ product.category }}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
                    <div v-if="product.supersedes" class="text-xs text-orange-600 mt-1">
                        ê°œí¸: {{ getProductName(product.supersedes) }}
                    </div>
                </div>
                <button @click="showAddModal('product')"
                    class="w-full p-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm hover:border-blue-400 hover:text-blue-600 transition">
                    + ìƒí’ˆ ì¶”ê°€
                </button>
            </div>

            <!-- DocTypes -->
            <div v-if="activeTab === 'docTypes'" class="space-y-2">
                <div v-for="(docType, id) in store.taxonomy.docTypes" :key="id"
                    class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">{{ docType.name }}</span>
                        <span :class="getTierClass(docType.tier)" class="text-xs px-2 py-0.5 rounded">{{ docType.tier }}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
                    <div class="text-xs text-gray-400 mt-1">í‚¤ì›Œë“œ: {{ docType.keywords?.join(', ') || '-' }}</div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="p-3 border-t border-gray-100">
            <label class="block w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
                <span class="text-sm text-gray-600">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ (ìë™ ë¶„ë¥˜)</span>
                <input type="file" accept=".md,.pdf,.hwp,.docx" @change="handleFileUpload" class="hidden">
            </label>
        </div>

        <!-- Data Actions -->
        <div class="p-3 border-t border-gray-100 flex gap-2">
            <button @click="exportData" class="flex-1 py-2 px-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-medium transition">
                ë‚´ë³´ë‚´ê¸°
            </button>
            <label class="flex-1 py-2 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-medium text-center cursor-pointer transition">
                ê°€ì ¸ì˜¤ê¸°
                <input type="file" accept=".json" @change="importData" class="hidden">
            </label>
        </div>
    </aside>

    <!-- CENTER AREA -->
    <main class="flex-1 flex flex-col">
        <!-- Toolbar -->
        <div class="h-12 bg-white border-b border-gray-200 flex items-center px-4 gap-4">
            <div class="flex items-center gap-2">
                <button @click="viewMode = 'graph'"
                    :class="viewMode === 'graph' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                    class="p-2 rounded-lg transition" title="ê·¸ë˜í”„ ë·°">ğŸ“Š</button>
                <button @click="viewMode = 'list'"
                    :class="viewMode === 'list' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                    class="p-2 rounded-lg transition" title="ëª©ë¡ ë·°">ğŸ“‹</button>
                <button @click="viewMode = 'validation'"
                    :class="viewMode === 'validation' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                    class="p-2 rounded-lg transition" title="ê²€ì¦ ë·°">âœ…</button>
            </div>
            <div class="h-6 w-px bg-gray-200"></div>
            <input type="text" v-model="searchQuery" placeholder="ë¬¸ì„œ ê²€ìƒ‰..."
                class="flex-1 px-3 py-1.5 bg-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
            <button @click="showAddDocModal" class="px-4 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition">
                + ë¬¸ì„œ ìƒì„±
            </button>
        </div>

        <!-- Graph View -->
        <div v-show="viewMode === 'graph'" class="flex-1 relative">
            <div id="network" class="w-full h-full bg-gray-50"></div>
            <div class="absolute top-4 left-4 bg-white/90 backdrop-blur rounded-lg p-3 shadow-lg text-xs">
                <div class="font-bold mb-2">ë²”ë¡€</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-purple-500"></span> ë³´í—˜ì‚¬</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span> ìƒí’ˆ</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> HOT</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-yellow-500"></span> WARM</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-400"></span> COLD</div>
            </div>
            <div class="absolute bottom-4 right-4 flex gap-2">
                <button @click="fitGraph" class="px-4 py-2 bg-white shadow-lg rounded-lg text-sm hover:bg-gray-50 transition">
                    ì „ì²´ ë³´ê¸°
                </button>
                <button v-if="selectedDocId" @click="highlightRelatedDocs" class="px-4 py-2 bg-blue-500 text-white shadow-lg rounded-lg text-sm hover:bg-blue-600 transition">
                    ì—°ê´€ ë¬¸ì„œ ì „íŒŒ
                </button>
            </div>
        </div>

        <!-- List View -->
        <div v-show="viewMode === 'list'" class="flex-1 overflow-auto p-4">
            <!-- Document Content View (when selected) -->
            <div v-if="selectedDocId && selectedDoc" class="h-full flex flex-col">
                <!-- Header with back button -->
                <div class="flex items-center gap-3 mb-4">
                    <button @click="selectedDocId = null" class="p-2 hover:bg-gray-100 rounded-lg transition">
                        <span class="text-gray-600">â† ëª©ë¡</span>
                    </button>
                    <div class="flex-1">
                        <h2 class="text-lg font-bold text-gray-800">{{ selectedDoc.name }}</h2>
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <span>{{ getCarrierName(selectedDoc.carrier) }}</span>
                            <span>â€º</span>
                            <span>{{ getProductName(selectedDoc.product) }}</span>
                            <span>â€º</span>
                            <span>{{ getDocTypeName(selectedDoc.docType) }}</span>
                            <span :class="getTierClass(selectedDoc.tier)" class="text-xs px-2 py-0.5 rounded ml-2">{{ selectedDoc.tier }}</span>
                        </div>
                    </div>
                </div>

                <!-- Document Content Area -->
                <div class="flex-1 bg-white rounded-lg shadow-sm overflow-hidden flex flex-col">
                    <!-- Content Toolbar -->
                    <div class="flex items-center justify-between px-4 py-2 bg-gray-50 border-b">
                        <span class="text-sm font-medium text-gray-600">ë¬¸ì„œ ë‚´ìš©</span>
                        <div class="flex gap-1">
                            <button @click="contentViewMode = 'edit'"
                                :class="contentViewMode === 'edit' ? 'bg-white shadow-sm' : 'hover:bg-gray-100'"
                                class="px-3 py-1 text-xs rounded transition">í¸ì§‘</button>
                            <button @click="contentViewMode = 'preview'"
                                :class="contentViewMode === 'preview' ? 'bg-white shadow-sm' : 'hover:bg-gray-100'"
                                class="px-3 py-1 text-xs rounded transition">ë¯¸ë¦¬ë³´ê¸°</button>
                        </div>
                    </div>

                    <!-- Edit Mode -->
                    <div v-if="contentViewMode === 'edit'" class="flex-1 p-4">
                        <textarea v-model="selectedDoc.content" @change="saveStore"
                            placeholder="ë¬¸ì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... (Markdown ì§€ì›)"
                            class="w-full h-full px-4 py-3 border border-gray-200 rounded-lg text-sm font-mono resize-none focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                    </div>

                    <!-- Preview Mode -->
                    <div v-else class="flex-1 p-4 overflow-auto">
                        <div v-if="selectedDoc.content"
                            class="prose prose-sm max-w-none px-4 py-3"
                            v-html="renderMarkdown(selectedDoc.content)">
                        </div>
                        <div v-else class="h-full flex items-center justify-center text-gray-400">
                            ë¬¸ì„œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. í¸ì§‘ ëª¨ë“œì—ì„œ ë‚´ìš©ì„ ì¶”ê°€í•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document List (when no selection) -->
            <table v-else class="w-full bg-white rounded-lg shadow-sm overflow-hidden">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë¬¸ì„œëª…</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë³´í—˜ì‚¬</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒí’ˆ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìœ í˜•</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tier</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê´€ê³„</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="(doc, id) in filteredDocuments" :key="id"
                        @click="selectDocument(id)"
                        :class="[highlightedDocs.includes(id) ? 'ring-2 ring-blue-400' : '']"
                        class="cursor-pointer hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm font-medium text-gray-800">{{ doc.name }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getCarrierName(doc.carrier) }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getProductName(doc.product) }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getDocTypeName(doc.docType) }}</td>
                        <td class="px-4 py-3">
                            <span :class="getTierClass(doc.tier)" class="text-xs px-2 py-0.5 rounded">{{ doc.tier }}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">{{ getRelationCount(doc) }}</td>
                        <td class="px-4 py-3">
                            <button @click.stop="deleteDocument(id)" class="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Validation View -->
        <div v-show="viewMode === 'validation'" class="flex-1 overflow-auto p-4">
            <div class="grid grid-cols-2 gap-4">
                <!-- ìœ ë‹ˆí¬ ê²€ì¦ -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ğŸ”‘ ìœ ë‹ˆí¬ ê²€ì¦
                    </h3>
                    <div v-if="duplicateGroups.length === 0" class="text-green-600 text-sm flex items-center gap-2">
                        âœ… ëª¨ë“  ë¬¸ì„œê°€ ìœ ë‹ˆí¬í•©ë‹ˆë‹¤
                    </div>
                    <div v-else class="space-y-2">
                        <div v-for="group in duplicateGroups" :key="group.key" class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-sm font-medium text-red-700">{{ group.key }}</div>
                            <div class="text-xs text-red-600 mt-1">{{ group.docs.length }}ê°œ ì¤‘ë³µ</div>
                        </div>
                    </div>
                </div>

                <!-- ì „íŒŒ ê²€ì¦ -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ğŸ”— ì „íŒŒ ê²€ì¦
                    </h3>
                    <div class="text-sm text-gray-600 mb-3">ë¬¸ì„œë¥¼ ì„ íƒí•˜ê³  "ì—°ê´€ ë¬¸ì„œ ì „íŒŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    <div v-if="selectedDocId" class="space-y-2">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="font-medium text-sm">{{ selectedDoc?.name }}</div>
                            <div class="text-xs text-gray-500 mt-2">ì—°ê´€ ë¬¸ì„œ ({{ getRelatedDocIds(selectedDocId).length }}ê°œ):</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                <span v-for="relId in getRelatedDocIds(selectedDocId)" :key="relId"
                                    class="text-xs px-2 py-1 bg-white rounded border">
                                    {{ getDocName(relId) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê´€ê³„ ê·œì¹™ -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ğŸ“ ê´€ê³„ ê·œì¹™
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div v-for="(targets, source) in store.taxonomy.relationRules" :key="source" class="flex items-center gap-2">
                            <span class="font-medium">{{ getDocTypeName(source) }}</span>
                            <span class="text-gray-400">â†’</span>
                            <span class="text-gray-600">{{ targets.map(t => getDocTypeName(t)).join(', ') }}</span>
                        </div>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ğŸ“Š í†µê³„
                    </h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="p-3 bg-gray-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">{{ Object.keys(store.taxonomy.carriers).length }}</div>
                            <div class="text-xs text-gray-500">ë³´í—˜ì‚¬</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">{{ Object.keys(store.taxonomy.products).length }}</div>
                            <div class="text-xs text-gray-500">ìƒí’ˆ</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">{{ Object.keys(store.documents).length }}</div>
                            <div class="text-xs text-gray-500">ë¬¸ì„œ</div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600">{{ getTotalRelations() }}</div>
                            <div class="text-xs text-gray-500">ê´€ê³„</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="h-8 bg-gray-100 border-t border-gray-200 flex items-center px-4 text-xs text-gray-600">
            <span>ë¬¸ì„œ: {{ Object.keys(store.documents).length }}ê°œ</span>
            <span class="mx-2">|</span>
            <span :class="duplicateGroups.length > 0 ? 'text-red-600 font-medium' : 'text-green-600'">
                ì¤‘ë³µ: {{ duplicateGroups.length }}ê±´
            </span>
            <span class="mx-2">|</span>
            <span v-if="highlightedDocs.length > 0" class="text-blue-600">
                ì „íŒŒëœ ë¬¸ì„œ: {{ highlightedDocs.length }}ê°œ
            </span>
            <span class="ml-auto text-gray-400">v{{ store.version }} | {{ formatDate(store.lastModified) }}</span>
        </div>
    </main>

    <!-- RIGHT PANEL -->
    <aside v-show="selectedDocId || selectedTaxonomy.type || uploadPreview.show" class="w-80 bg-white border-l border-gray-200 flex flex-col">
        <!-- Upload Preview -->
        <div v-if="uploadPreview.show" class="flex-1 overflow-y-auto scrollbar-thin p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold text-gray-800">íŒŒì¼ ìë™ ë¶„ë¥˜</h2>
                <button @click="uploadPreview.show = false" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <div class="p-3 bg-blue-50 rounded-lg mb-4">
                <div class="text-xs text-gray-500">íŒŒì¼ëª…</div>
                <div class="text-sm font-medium">{{ uploadPreview.filename }}</div>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬ (ìë™ ê°ì§€)</label>
                    <select v-model="uploadPreview.data.carrier"
                        class="w-full mt-1 px-3 py-2 border rounded-lg text-sm"
                        :class="uploadPreview.confidence.carrier > 0.7 ? 'border-green-400 bg-green-50' : 'border-gray-200'">
                        <option value="">ì„ íƒ</option>
                        <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ìƒí’ˆ (ìë™ ê°ì§€)</label>
                    <select v-model="uploadPreview.data.product"
                        class="w-full mt-1 px-3 py-2 border rounded-lg text-sm"
                        :class="uploadPreview.confidence.product > 0.7 ? 'border-green-400 bg-green-50' : 'border-gray-200'">
                        <option value="">ì„ íƒ</option>
                        <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜• (ìë™ ê°ì§€)</label>
                    <select v-model="uploadPreview.data.docType"
                        class="w-full mt-1 px-3 py-2 border rounded-lg text-sm"
                        :class="uploadPreview.confidence.docType > 0.7 ? 'border-green-400 bg-green-50' : 'border-gray-200'">
                        <option value="">ì„ íƒ</option>
                        <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œëª…</label>
                    <input type="text" v-model="uploadPreview.data.name"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <!-- ì¤‘ë³µ ê²½ê³  -->
                <div v-if="uploadPreview.duplicateWarning" class="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div class="text-sm font-medium text-red-700">âš ï¸ ì¤‘ë³µ ë¬¸ì„œ ê°ì§€!</div>
                    <div class="text-xs text-red-600 mt-1">{{ uploadPreview.duplicateWarning }}</div>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button @click="uploadPreview.show = false" class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">ì·¨ì†Œ</button>
                <button @click="confirmUpload" :disabled="uploadPreview.duplicateWarning"
                    :class="uploadPreview.duplicateWarning ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'"
                    class="flex-1 py-2 text-white rounded-lg text-sm font-medium">ë“±ë¡</button>
            </div>
        </div>

        <!-- Carrier Detail -->
        <div v-else-if="selectedTaxonomy.type === 'carrier'" class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-bold text-gray-800">ë³´í—˜ì‚¬ ìƒì„¸</h2>
                <button @click="selectedTaxonomy.type = null; selectedTaxonomy.id = null" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <div v-if="store.taxonomy.carriers[selectedTaxonomy.id]" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">ID</label>
                    <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬ëª…</label>
                    <input type="text" v-model="store.taxonomy.carriers[selectedTaxonomy.id].name" @change="saveStore"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë³„ì¹­</label>
                    <div class="flex flex-wrap gap-1 mt-1">
                        <span v-for="(alias, idx) in store.taxonomy.carriers[selectedTaxonomy.id].alias" :key="idx"
                            class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">
                            {{ alias }}
                            <button @click="removeCarrierAlias(idx)" class="hover:text-red-500">&times;</button>
                        </span>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <input type="text" v-model="newCarrierAlias" placeholder="ë³„ì¹­ ì¶”ê°€"
                            @keyup.enter="addCarrierAlias"
                            class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <button @click="addCarrierAlias" class="px-3 py-2 bg-purple-500 text-white rounded-lg text-sm">ì¶”ê°€</button>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">ê´€ë ¨ ë¬¸ì„œ</label>
                    <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                        <div v-for="(doc, docId) in getDocsByCarrier(selectedTaxonomy.id)" :key="docId"
                            @click="selectDocument(docId)"
                            class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-purple-50 transition text-sm">
                            {{ doc.name }}
                        </div>
                        <div v-if="Object.keys(getDocsByCarrier(selectedTaxonomy.id)).length === 0" class="text-sm text-gray-400 py-2">
                            ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">í†µê³„</label>
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div class="p-2 bg-purple-50 rounded text-center">
                            <div class="text-lg font-bold text-purple-600">{{ getDocCountByCarrier(selectedTaxonomy.id) }}</div>
                            <div class="text-xs text-gray-500">ë¬¸ì„œ</div>
                        </div>
                        <div class="p-2 bg-red-50 rounded text-center">
                            <div class="text-lg font-bold text-red-600">{{ getDocCountByCarrierTier(selectedTaxonomy.id, 'HOT') }}</div>
                            <div class="text-xs text-gray-500">HOT</div>
                        </div>
                        <div class="p-2 bg-yellow-50 rounded text-center">
                            <div class="text-lg font-bold text-yellow-600">{{ getDocCountByCarrierTier(selectedTaxonomy.id, 'WARM') }}</div>
                            <div class="text-xs text-gray-500">WARM</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Detail -->
        <div v-else-if="selectedTaxonomy.type === 'product'" class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-bold text-gray-800">ìƒí’ˆ ìƒì„¸</h2>
                <button @click="selectedTaxonomy.type = null; selectedTaxonomy.id = null" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <div v-if="store.taxonomy.products[selectedTaxonomy.id]" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">ID</label>
                    <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ìƒí’ˆëª…</label>
                    <input type="text" v-model="store.taxonomy.products[selectedTaxonomy.id].name" @change="saveStore"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ì¹´í…Œê³ ë¦¬</label>
                    <input type="text" v-model="store.taxonomy.products[selectedTaxonomy.id].category" @change="saveStore"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë³„ì¹­</label>
                    <div class="flex flex-wrap gap-1 mt-1">
                        <span v-for="(alias, idx) in store.taxonomy.products[selectedTaxonomy.id].alias" :key="idx"
                            class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                            {{ alias }}
                            <button @click="removeProductAlias(idx)" class="hover:text-red-500">&times;</button>
                        </span>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <input type="text" v-model="newProductAlias" placeholder="ë³„ì¹­ ì¶”ê°€"
                            @keyup.enter="addProductAlias"
                            class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <button @click="addProductAlias" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm">ì¶”ê°€</button>
                    </div>
                </div>

                <!-- Supersedes ê´€ê³„ -->
                <div v-if="store.taxonomy.products[selectedTaxonomy.id].supersedes" class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">ê°œí¸ ì´ì „ ìƒí’ˆ (supersedes)</label>
                    <div class="mt-2 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                        <div class="text-sm font-medium text-orange-800">
                            {{ getProductName(store.taxonomy.products[selectedTaxonomy.id].supersedes) }}
                        </div>
                        <div class="text-xs text-orange-600 mt-1">
                            {{ store.taxonomy.products[selectedTaxonomy.id].supersedes }}
                        </div>
                    </div>
                </div>

                <!-- ì´ ìƒí’ˆì„ supersedeí•˜ëŠ” ìƒí’ˆë“¤ -->
                <div v-if="getSupersededByProducts(selectedTaxonomy.id).length > 0" class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">ê°œí¸ ì´í›„ ìƒí’ˆ (superseded by)</label>
                    <div class="mt-2 space-y-1">
                        <div v-for="prd in getSupersededByProducts(selectedTaxonomy.id)" :key="prd.id"
                            @click="selectTaxonomy('product', prd.id)"
                            class="p-2 bg-green-50 border border-green-200 rounded cursor-pointer hover:bg-green-100 transition text-sm">
                            {{ prd.name }}
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">ê´€ë ¨ ë¬¸ì„œ</label>
                    <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                        <div v-for="(doc, docId) in getDocsByProduct(selectedTaxonomy.id)" :key="docId"
                            @click="selectDocument(docId)"
                            class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-blue-50 transition text-sm flex justify-between">
                            <span>{{ doc.name }}</span>
                            <span :class="getTierClass(doc.tier)" class="text-xs px-1.5 py-0.5 rounded">{{ doc.tier }}</span>
                        </div>
                        <div v-if="Object.keys(getDocsByProduct(selectedTaxonomy.id)).length === 0" class="text-sm text-gray-400 py-2">
                            ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Detail -->
        <div v-else-if="selectedDocId" class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-bold text-gray-800">ë¬¸ì„œ ìƒì„¸</h2>
                <button @click="selectedDocId = null; highlightedDocs = []" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <div v-if="selectedDoc" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œ ID</label>
                    <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1 break-all">{{ selectedDocId }}</div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œëª…</label>
                    <input type="text" v-model="selectedDoc.name" @change="saveStore"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬</label>
                        <select v-model="selectedDoc.carrier" @change="onDocMetaChange"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500">ìƒí’ˆ</label>
                        <select v-model="selectedDoc.product" @change="onDocMetaChange"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•</label>
                    <select v-model="selectedDoc.docType" @change="onDocMetaChange"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">Tier</label>
                    <div :class="getTierClass(selectedDoc.tier)" class="mt-1 px-3 py-2 rounded-lg text-sm text-center font-medium">
                        {{ selectedDoc.tier }}
                    </div>
                </div>

                <!-- Relations -->
                <div class="border-t border-gray-100 pt-4">
                    <h3 class="text-sm font-bold text-gray-700 mb-3">ê´€ê³„ ì„¤ì •</h3>

                    <!-- Siblings -->
                    <div class="mb-3">
                        <label class="text-xs font-medium text-gray-500">í˜•ì œ ë¬¸ì„œ (ì–‘ë°©í–¥)</label>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-for="sibId in selectedDoc.relations.siblings" :key="sibId"
                                @click="selectDocument(sibId)"
                                class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded text-xs cursor-pointer hover:bg-green-200">
                                {{ getDocName(sibId) }}
                                <button @click.stop="removeSiblingRelation(sibId)" class="hover:text-red-500">&times;</button>
                            </span>
                        </div>
                        <select @change="addSiblingRelation($event)"
                            class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">+ í˜•ì œ ì¶”ê°€</option>
                            <option v-for="(doc, id) in availableSiblings" :key="id" :value="id">{{ doc.name }}</option>
                        </select>
                    </div>

                    <!-- References -->
                    <div>
                        <label class="text-xs font-medium text-gray-500">ì°¸ì¡° ë¬¸ì„œ (ë‹¨ë°©í–¥)</label>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-for="refId in selectedDoc.relations.references" :key="refId"
                                @click="selectDocument(refId)"
                                class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs cursor-pointer hover:bg-gray-200">
                                {{ getDocName(refId) }}
                                <button @click.stop="removeReference(refId)" class="hover:text-red-500">&times;</button>
                            </span>
                        </div>
                        <select @change="addReference($event)"
                            class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">+ ì°¸ì¡° ì¶”ê°€</option>
                            <option v-for="(doc, id) in otherDocuments" :key="id" :value="id">{{ doc.name }}</option>
                        </select>
                    </div>
                </div>

                <!-- Document Content (ëª©ë¡ë·°ì—ì„œë§Œ ì¤‘ì•™ì— í‘œì‹œ) -->
                <div v-if="viewMode === 'graph'" class="border-t border-gray-100 pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-gray-700">ë¬¸ì„œ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</h3>
                    </div>
                    <div class="prose prose-sm max-w-none">
                        <div v-if="selectedDoc.content"
                            class="w-full max-h-48 overflow-y-auto px-3 py-2 bg-gray-50 rounded-lg text-sm border border-gray-100"
                            v-html="renderMarkdown(selectedDoc.content)">
                        </div>
                        <div v-else class="w-full h-24 px-3 py-2 bg-gray-50 rounded-lg text-sm text-gray-400 flex items-center justify-center border border-gray-100">
                            ë¬¸ì„œ ë‚´ìš© ì—†ìŒ
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-400">ì „ì²´ í¸ì§‘ì€ ëª©ë¡ ë·°ì—ì„œ ê°€ëŠ¥</div>
                </div>

                <!-- ëª©ë¡ë·°ì—ì„œëŠ” ë‚´ìš©ì´ ì¤‘ì•™ì— í‘œì‹œë˜ë¯€ë¡œ ì•ˆë‚´ ë¬¸êµ¬ë§Œ -->
                <div v-else class="border-t border-gray-100 pt-4">
                    <div class="p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                        â† ì¤‘ì•™ ì˜ì—­ì—ì„œ ë¬¸ì„œ ë‚´ìš©ì„ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>
            </div>

            <div class="p-3 border-t border-gray-100 flex gap-2">
                <button @click="highlightRelatedDocs" class="flex-1 py-2 px-3 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-medium">
                    ì „íŒŒ í™•ì¸
                </button>
                <button @click="deleteDocument(selectedDocId)" class="py-2 px-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-medium">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </aside>

    <!-- Add Taxonomy Modal -->
    <div v-if="modal.show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="modal.show = false">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
            <h3 class="text-lg font-bold mb-4">{{ modal.title }}</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-medium text-gray-500">ID</label>
                    <input type="text" v-model="modal.data.id" :placeholder="modal.type === 'carrier' ? 'ì˜ˆ: INS-KB' : 'ì˜ˆ: PRD-CHILD-NEW'"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ì´ë¦„</label>
                    <input type="text" v-model="modal.data.name" :placeholder="modal.type === 'carrier' ? 'ì˜ˆ: KBì†í•´ë³´í—˜' : 'ì˜ˆ: ë“ ë“  ì–´ë¦°ì´ë³´í—˜ ë¦¬ë‰´ì–¼(2026-02)'"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <div v-if="modal.type === 'carrier'">
                    <label class="text-xs font-medium text-gray-500">ë³„ì¹­ (ì‰¼í‘œ êµ¬ë¶„)</label>
                    <input type="text" v-model="modal.data.alias" placeholder="ì˜ˆ: KB, ì¼€ì´ë¹„, KBì†ë³´"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <div v-if="modal.type === 'product'">
                    <label class="text-xs font-medium text-gray-500">ì¹´í…Œê³ ë¦¬</label>
                    <input type="text" v-model="modal.data.category" placeholder="ì˜ˆ: ì–´ë¦°ì´/íƒœì•„"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <div v-if="modal.type === 'product'">
                    <label class="text-xs font-medium text-gray-500">ê°œí¸ ì´ì „ ìƒí’ˆ (ì„ íƒ)</label>
                    <select v-model="modal.data.supersedes"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">ì—†ìŒ (ì‹ ê·œ ìƒí’ˆ)</option>
                        <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="modal.show = false" class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">ì·¨ì†Œ</button>
                <button @click="addTaxonomy" class="flex-1 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- Add Document Modal -->
    <div v-if="docModal.show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="docModal.show = false">
        <div class="bg-white rounded-xl shadow-2xl w-[500px] p-6">
            <h3 class="text-lg font-bold mb-4">ìƒˆ ë¬¸ì„œ ìƒì„±</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬</label>
                    <select v-model="docModal.data.carrier" @change="checkDocModalDuplicate"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">ì„ íƒ</option>
                        <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ìƒí’ˆ</label>
                    <select v-model="docModal.data.product" @change="checkDocModalDuplicate"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">ì„ íƒ</option>
                        <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•</label>
                    <select v-model="docModal.data.docType" @change="checkDocModalDuplicate"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">ì„ íƒ</option>
                        <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œëª… (ì„ íƒ)</label>
                    <input type="text" v-model="docModal.data.name" placeholder="ìë™ ìƒì„±ë¨"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <!-- ì¤‘ë³µ ê²½ê³  -->
                <div v-if="docModal.duplicateWarning" class="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div class="text-sm font-medium text-red-700">âš ï¸ ì¤‘ë³µ ë¬¸ì„œ ì¡´ì¬!</div>
                    <div class="text-xs text-red-600 mt-1">{{ docModal.duplicateWarning }}</div>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="docModal.show = false" class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">ì·¨ì†Œ</button>
                <button @click="createDocument" :disabled="docModal.duplicateWarning"
                    :class="docModal.duplicateWarning ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'"
                    class="flex-1 py-2 text-white rounded-lg text-sm font-medium">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

// ê¸°ë³¸ ë°ì´í„° êµ¬ì¡°
const DEFAULT_DATA = {
    version: "1.1",
    lastModified: new Date().toISOString(),
    taxonomy: {
        carriers: {
            "INS-SAMSUNG": { name: "ì‚¼ì„±ìƒëª…", alias: ["ì‚¼ì„±", "ì‚¼ì„±ìƒëª…", "SL", "SAMSUNG"], active: true },
            "INS-HANWHA": { name: "í•œí™”ìƒëª…", alias: ["í•œí™”", "í•œí™”ìƒëª…", "HL", "HANWHA"], active: true },
            "INS-KYOBO": { name: "êµë³´ìƒëª…", alias: ["êµë³´", "êµë³´ìƒëª…", "KL", "KYOBO"], active: true },
            "INS-KB": { name: "KBì†í•´ë³´í—˜", alias: ["KB", "ì¼€ì´ë¹„", "KBì†ë³´", "KBì†í•´"], active: true }
        },
        products: {
            "PRD-LIFE-WHOLE": { name: "ì¢…ì‹ ë³´í—˜", category: "ìƒëª…", alias: ["ì¢…ì‹ ", "whole life"], active: true },
            "PRD-CHILD": { name: "ì–´ë¦°ì´ë³´í—˜", category: "ì–´ë¦°ì´/íƒœì•„", alias: ["ì–´ë¦°ì´", "íƒœì•„", "ìë…€"], active: true },
            "PRD-CHILD-DENDEN": { name: "ë“ ë“  ì–´ë¦°ì´ë³´í—˜", category: "ì–´ë¦°ì´/íƒœì•„", alias: ["ë“ ë“ ", "ë“ ë“ ì–´ë¦°ì´"], active: true }
        },
        docTypes: {
            "DOC-TERMS": { name: "ì•½ê´€", tier: "COLD", keywords: ["ì•½ê´€", "ë³´í†µì•½ê´€", "íŠ¹ë³„ì•½ê´€", "terms"], active: true },
            "DOC-GUIDE": { name: "ìƒí’ˆì„¤ëª…ì„œ", tier: "WARM", keywords: ["ì„¤ëª…ì„œ", "ì•ˆë‚´", "ê°€ì´ë“œ", "guide"], active: true },
            "DOC-SCRIPT": { name: "íŒë§¤ìŠ¤í¬ë¦½íŠ¸", tier: "WARM", keywords: ["ìŠ¤í¬ë¦½íŠ¸", "í™”ë²•", "script", "ë©˜íŠ¸"], active: true },
            "DOC-INCENTIVE": { name: "ì‹œì±…", tier: "HOT", keywords: ["ì‹œì±…", "ì¸ì„¼í‹°ë¸Œ", "incentive", "í”„ë¡œëª¨ì…˜"], active: true },
            "DOC-COMMISSION": { name: "ìˆ˜ìˆ˜ë£Œ", tier: "HOT", keywords: ["ìˆ˜ìˆ˜ë£Œ", "ì»¤ë¯¸ì…˜", "commission"], active: true },
            "DOC-TRAINING": { name: "êµìœ¡ìë£Œ", tier: "COLD", keywords: ["êµìœ¡", "ê°•ì˜", "training", "ì—°ìˆ˜"], active: true },
            "DOC-SUMMARY": { name: "ìƒí’ˆìš”ì•½ë³¸", tier: "WARM", keywords: ["ìš”ì•½", "ìš”ì•½ë³¸", "summary"], active: true }
        },
        relationRules: {
            "DOC-GUIDE": ["DOC-TERMS", "DOC-SCRIPT"],
            "DOC-SCRIPT": ["DOC-GUIDE", "DOC-INCENTIVE"],
            "DOC-INCENTIVE": ["DOC-COMMISSION"],
            "DOC-TRAINING": ["DOC-TERMS", "DOC-GUIDE"]
        }
    },
    documents: {}
};

// ë§ˆì´ê·¸ë ˆì´ì…˜ í•¨ìˆ˜
function migrateFromKnowledgeGraph(graphData) {
    const data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    const nodes = graphData.graph_data?.nodes || [];
    const edges = graphData.graph_data?.edges || [];

    const relatedTo = {};
    edges.forEach(e => {
        if (e.relationship === 'RELATED_TO') {
            if (!relatedTo[e.source]) relatedTo[e.source] = [];
            relatedTo[e.source].push(e.target);
        }
    });

    nodes.forEach(n => {
        if (!n.labels.includes('Document')) return;
        const props = n.properties;
        const docType = n.labels.find(l => l.startsWith('DOC-'));
        const tier = n.labels.find(l => ['HOT', 'WARM', 'COLD'].includes(l)) || 'COLD';

        data.documents[n.id] = {
            id: n.id,
            name: props.name,
            carrier: props.carrier,
            product: props.product,
            docType: docType,
            tier: tier,
            status: "ACTIVE",
            version: "1.0",
            content: "",
            relations: { parent: null, children: [], siblings: relatedTo[n.id] || [], references: [] },
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
    });

    return data;
}

createApp({
    setup() {
        let network = null;

        const store = reactive(JSON.parse(JSON.stringify(DEFAULT_DATA)));
        const activeTab = ref('carriers');
        const viewMode = ref('graph');
        const searchQuery = ref('');
        const selectedDocId = ref(null);
        const selectedTaxonomy = reactive({ type: null, id: null });
        const modal = reactive({ show: false, type: '', title: '', data: {} });
        const docModal = reactive({ show: false, data: {}, duplicateWarning: null });
        const uploadPreview = reactive({ show: false, filename: '', data: {}, confidence: {}, duplicateWarning: null, suggestNewProduct: false });
        const highlightedDocs = ref([]);
        const toasts = ref([]);
        const newCarrierAlias = ref('');
        const newProductAlias = ref('');
        const contentViewMode = ref('edit');

        const selectedDoc = computed(() => selectedDocId.value ? store.documents[selectedDocId.value] : null);

        const filteredDocuments = computed(() => {
            const q = searchQuery.value.toLowerCase();
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (!q || doc.name.toLowerCase().includes(q) || id.toLowerCase().includes(q)) {
                    docs[id] = doc;
                }
            });
            return docs;
        });

        const otherDocuments = computed(() => {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (id !== selectedDocId.value) docs[id] = doc;
            });
            return docs;
        });

        const availableSiblings = computed(() => {
            if (!selectedDoc.value) return {};
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (id !== selectedDocId.value && !selectedDoc.value.relations.siblings.includes(id)) {
                    docs[id] = doc;
                }
            });
            return docs;
        });

        const duplicateGroups = computed(() => {
            const groups = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                const key = `${doc.carrier}|${doc.product}|${doc.docType}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push({ id, name: doc.name });
            });
            return Object.entries(groups)
                .filter(([_, docs]) => docs.length > 1)
                .map(([key, docs]) => {
                    const [carrier, product, docType] = key.split('|');
                    return {
                        key: `${getCarrierName(carrier)} > ${getProductName(product)} > ${getDocTypeName(docType)}`,
                        docs
                    };
                });
        });

        // ì´ˆê¸°í™”
        onMounted(() => {
            loadStore();
            nextTick(() => {
                initGraph();
            });
        });

        function loadStore() {
            const saved = localStorage.getItem('kms_data');
            if (saved) {
                Object.assign(store, JSON.parse(saved));
            } else {
                fetch('./knowledge_graph.json')
                    .then(res => res.json())
                    .then(data => {
                        Object.assign(store, migrateFromKnowledgeGraph(data));
                        saveStore();
                        rebuildGraph();
                    })
                    .catch(() => {
                        Object.assign(store, JSON.parse(JSON.stringify(DEFAULT_DATA)));
                        saveStore();
                    });
            }
        }

        function saveStore() {
            store.lastModified = new Date().toISOString();
            localStorage.setItem('kms_data', JSON.stringify(store));
            rebuildGraph();
        }

        function showToast(message, type = 'success') {
            toasts.value.push({ message, type });
            setTimeout(() => toasts.value.shift(), 3000);
        }

        function removeToast(idx) {
            toasts.value.splice(idx, 1);
        }

        function initGraph() {
            const container = document.getElementById('network');
            if (!container) return;

            const options = {
                layout: {
                    hierarchical: { enabled: true, direction: 'LR', sortMethod: 'directed', nodeSpacing: 80, levelSeparation: 200 }
                },
                physics: { enabled: false },
                interaction: { hover: true, selectConnectedEdges: true },
                nodes: { font: { size: 12 } },
                edges: { arrows: { to: { enabled: true, scaleFactor: 0.5 } }, smooth: { type: 'cubicBezier', forceDirection: 'horizontal' } }
            };

            network = new vis.Network(container, { nodes: [], edges: [] }, options);
            network.on('click', (params) => {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    // ë¬¸ì„œ ë…¸ë“œ
                    if (store.documents[nodeId]) {
                        selectedTaxonomy.type = null;
                        selectedTaxonomy.id = null;
                        selectDocument(nodeId);
                    }
                    // ë³´í—˜ì‚¬ ë…¸ë“œ
                    else if (store.taxonomy.carriers[nodeId]) {
                        selectedDocId.value = null;
                        highlightedDocs.value = [];
                        selectTaxonomy('carrier', nodeId);
                    }
                    // ìƒí’ˆ ë…¸ë“œ (carrier-product í˜•íƒœ)
                    else if (nodeId.includes('-PRD-') || nodeId.startsWith('INS-')) {
                        const parts = nodeId.split('-');
                        // INS-SAMSUNG-PRD-LIFE-WHOLE ê°™ì€ í˜•íƒœ
                        const carrierIdx = parts.findIndex(p => p === 'INS');
                        const productIdx = parts.findIndex(p => p === 'PRD');
                        if (productIdx > 0) {
                            const productId = parts.slice(productIdx).join('-');
                            if (store.taxonomy.products[productId]) {
                                selectedDocId.value = null;
                                highlightedDocs.value = [];
                                selectTaxonomy('product', productId);
                            }
                        }
                    }
                }
            });

            rebuildGraph();
        }

        function rebuildGraph() {
            if (!network) return;

            const nodes = [];
            const edges = [];

            nodes.push({ id: 'ROOT', label: 'KMS', level: 0, color: '#2c3e50', shape: 'dot', size: 30, font: { color: '#fff' } });

            Object.entries(store.taxonomy.carriers).forEach(([id, c]) => {
                nodes.push({ id, label: c.name, level: 1, color: '#8e44ad', shape: 'dot', size: 25, font: { color: '#fff' } });
                edges.push({ from: 'ROOT', to: id, color: '#bdc3c7' });
            });

            Object.entries(store.taxonomy.carriers).forEach(([carrierId]) => {
                Object.entries(store.taxonomy.products).forEach(([prodId, p]) => {
                    const nodeId = `${carrierId}-${prodId}`;
                    nodes.push({ id: nodeId, label: p.name, level: 2, color: '#3498db', shape: 'dot', size: 20 });
                    edges.push({ from: carrierId, to: nodeId, color: '#bdc3c7' });
                });
            });

            Object.entries(store.documents).forEach(([id, doc]) => {
                const tierColors = { HOT: '#e74c3c', WARM: '#f39c12', COLD: '#95a5a6' };
                const parentId = `${doc.carrier}-${doc.product}`;
                const isHighlighted = highlightedDocs.value.includes(id);

                nodes.push({
                    id,
                    label: getDocTypeName(doc.docType),
                    level: 3,
                    color: isHighlighted ? '#3b82f6' : (tierColors[doc.tier] || '#95a5a6'),
                    shape: 'dot',
                    size: isHighlighted ? 20 : 15,
                    borderWidth: isHighlighted ? 3 : 1
                });

                edges.push({ from: parentId, to: id, color: '#bdc3c7' });

                doc.relations?.siblings?.forEach(sibId => {
                    if (store.documents[sibId]) {
                        edges.push({ from: id, to: sibId, color: '#27ae60', dashes: true });
                    }
                });

                doc.relations?.references?.forEach(refId => {
                    if (store.documents[refId]) {
                        edges.push({ from: id, to: refId, color: '#9b59b6', dashes: [5, 5] });
                    }
                });
            });

            network.setData({ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) });
        }

        function fitGraph() {
            network?.fit({ animation: true });
        }

        function highlightRelatedDocs() {
            if (!selectedDocId.value) return;
            const relatedIds = getRelatedDocIds(selectedDocId.value);
            highlightedDocs.value = [selectedDocId.value, ...relatedIds];
            rebuildGraph();
            showToast(`${relatedIds.length}ê°œ ì—°ê´€ ë¬¸ì„œ ì „íŒŒë¨`, 'success');
        }

        function getRelatedDocIds(docId, visited = new Set()) {
            if (visited.has(docId)) return [];
            visited.add(docId);

            const doc = store.documents[docId];
            if (!doc) return [];

            let related = [];

            (doc.relations.siblings || []).forEach(sibId => {
                if (!visited.has(sibId)) {
                    related.push(sibId);
                    related = related.concat(getRelatedDocIds(sibId, visited));
                }
            });

            (doc.relations.references || []).forEach(refId => {
                if (!visited.has(refId)) {
                    related.push(refId);
                }
            });

            if (doc.relations.parent && !visited.has(doc.relations.parent)) {
                related.push(doc.relations.parent);
            }
            (doc.relations.children || []).forEach(childId => {
                if (!visited.has(childId)) {
                    related.push(childId);
                }
            });

            return [...new Set(related)];
        }

        function selectDocument(id) {
            selectedTaxonomy.type = null;
            selectedTaxonomy.id = null;
            selectedDocId.value = id;
            highlightedDocs.value = [];
            network?.selectNodes([id]);
            network?.focus(id, { scale: 1.2, animation: true });
        }

        function selectTaxonomy(type, id) {
            selectedDocId.value = null;
            highlightedDocs.value = [];
            selectedTaxonomy.type = type;
            selectedTaxonomy.id = id;
        }

        function checkDuplicate(carrier, product, docType, excludeId = null) {
            const found = Object.entries(store.documents).find(([id, doc]) => {
                if (excludeId && id === excludeId) return false;
                return doc.carrier === carrier && doc.product === product && doc.docType === docType;
            });
            return found ? found[1] : null;
        }

        function checkDocModalDuplicate() {
            const { carrier, product, docType } = docModal.data;
            if (!carrier || !product || !docType) {
                docModal.duplicateWarning = null;
                return;
            }
            const dup = checkDuplicate(carrier, product, docType);
            docModal.duplicateWarning = dup ? `ì´ë¯¸ ì¡´ì¬: ${dup.name}` : null;
        }

        function onDocMetaChange() {
            if (!selectedDoc.value) return;
            const dup = checkDuplicate(
                selectedDoc.value.carrier,
                selectedDoc.value.product,
                selectedDoc.value.docType,
                selectedDocId.value
            );
            if (dup) {
                showToast(`ì¤‘ë³µ ê²½ê³ : ${dup.name}ê³¼ ë™ì¼í•œ ë¶„ë¥˜`, 'warning');
            }
            updateDocTier();
            saveStore();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const filename = file.name;
            const classification = autoClassifyFilename(filename);

            uploadPreview.show = true;
            uploadPreview.filename = filename;
            uploadPreview.data = {
                carrier: classification.carrier,
                product: classification.product,
                docType: classification.docType,
                name: filename.replace(/\.[^/.]+$/, ''),
                content: ''
            };
            uploadPreview.confidence = classification.confidence;
            uploadPreview.duplicateWarning = null;
            uploadPreview.suggestNewProduct = classification.suggestNewProduct;

            if (classification.carrier && classification.product && classification.docType) {
                const dup = checkDuplicate(classification.carrier, classification.product, classification.docType);
                if (dup) {
                    uploadPreview.duplicateWarning = `ì´ë¯¸ ì¡´ì¬: ${dup.name}`;
                }
            }

            if (filename.endsWith('.md')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadPreview.data.content = e.target.result;
                };
                reader.readAsText(file);
            }

            event.target.value = '';
        }

        function autoClassifyFilename(filename) {
            const result = { carrier: '', product: '', docType: '', confidence: { carrier: 0, product: 0, docType: 0 }, suggestNewProduct: false };
            const lowerFilename = filename.toLowerCase().replace(/[_\-\.]/g, ' ');

            for (const [id, carrier] of Object.entries(store.taxonomy.carriers)) {
                const allNames = [carrier.name.toLowerCase(), ...(carrier.alias || []).map(a => a.toLowerCase())];
                for (const name of allNames) {
                    if (lowerFilename.includes(name)) {
                        result.carrier = id;
                        result.confidence.carrier = name.length > 2 ? 0.9 : 0.7;
                        break;
                    }
                }
                if (result.carrier) break;
            }

            let bestProductMatch = { id: '', score: 0 };
            for (const [id, product] of Object.entries(store.taxonomy.products)) {
                const allNames = [product.name.toLowerCase(), ...(product.alias || []).map(a => a.toLowerCase())];
                for (const name of allNames) {
                    if (lowerFilename.includes(name)) {
                        const score = name.length / lowerFilename.length;
                        if (score > bestProductMatch.score) {
                            bestProductMatch = { id, score };
                        }
                    }
                }
            }
            if (bestProductMatch.id) {
                result.product = bestProductMatch.id;
                result.confidence.product = Math.min(bestProductMatch.score * 2, 0.9);
            } else {
                result.suggestNewProduct = true;
            }

            for (const [id, docType] of Object.entries(store.taxonomy.docTypes)) {
                const keywords = docType.keywords || [];
                for (const kw of keywords) {
                    if (lowerFilename.includes(kw.toLowerCase())) {
                        result.docType = id;
                        result.confidence.docType = 0.85;
                        break;
                    }
                }
                if (result.docType) break;
            }

            return result;
        }

        function confirmUpload() {
            const { carrier, product, docType, name, content } = uploadPreview.data;
            if (!carrier || !product || !docType) {
                showToast('ë³´í—˜ì‚¬, ìƒí’ˆ, ë¬¸ì„œìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
                return;
            }

            const dup = checkDuplicate(carrier, product, docType);
            if (dup) {
                showToast('ì¤‘ë³µ ë¬¸ì„œê°€ ì¡´ì¬í•©ë‹ˆë‹¤', 'error');
                return;
            }

            createDocumentInternal(carrier, product, docType, name, content);
            uploadPreview.show = false;
            showToast('ë¬¸ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function showAddModal(type) {
            const titles = { carrier: 'ë³´í—˜ì‚¬ ì¶”ê°€', product: 'ìƒí’ˆ ì¶”ê°€' };
            modal.show = true;
            modal.type = type;
            modal.title = titles[type];
            modal.data = { id: '', name: '', alias: '', category: '', supersedes: '' };
        }

        function addTaxonomy() {
            const { type, data } = modal;
            if (!data.id || !data.name) return showToast('IDì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

            if (type === 'carrier') {
                store.taxonomy.carriers[data.id] = {
                    name: data.name,
                    alias: data.alias ? data.alias.split(',').map(s => s.trim()) : [],
                    active: true
                };
            } else if (type === 'product') {
                store.taxonomy.products[data.id] = {
                    name: data.name,
                    category: data.category || '',
                    alias: [],
                    supersedes: data.supersedes || null,
                    active: true
                };
            }

            saveStore();
            modal.show = false;
            showToast(`${type === 'carrier' ? 'ë³´í—˜ì‚¬' : 'ìƒí’ˆ'}ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        }

        function showAddDocModal() {
            docModal.show = true;
            docModal.data = { carrier: '', product: '', docType: '', name: '', content: '' };
            docModal.duplicateWarning = null;
        }

        function createDocument() {
            const { carrier, product, docType, name, content } = docModal.data;
            if (!carrier || !product || !docType) {
                return showToast('ë³´í—˜ì‚¬, ìƒí’ˆ, ë¬¸ì„œìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
            }

            if (docModal.duplicateWarning) {
                return showToast('ì¤‘ë³µ ë¬¸ì„œê°€ ì¡´ì¬í•©ë‹ˆë‹¤', 'error');
            }

            createDocumentInternal(carrier, product, docType, name, content);
            docModal.show = false;
            showToast('ë¬¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function createDocumentInternal(carrier, product, docType, name, content) {
            const count = Object.keys(store.documents).filter(id =>
                id.includes(carrier) && id.includes(product) && id.includes(docType)
            ).length + 1;

            const id = `${docType}-${carrier}-${product}-${String(count).padStart(3, '0')}`;
            const docTypeObj = store.taxonomy.docTypes[docType];
            const carrierObj = store.taxonomy.carriers[carrier];
            const productObj = store.taxonomy.products[product];

            const docName = name || `${carrierObj.name} ${productObj.name} ${docTypeObj.name}`;

            store.documents[id] = {
                id,
                name: docName,
                carrier,
                product,
                docType,
                tier: docTypeObj.tier,
                status: "ACTIVE",
                version: "1.0",
                content: content || `# ${docName}\n\n`,
                relations: { parent: null, children: [], siblings: [], references: [] },
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            saveStore();
            selectDocument(id);
        }

        function deleteDocument(id) {
            if (!confirm(`"${store.documents[id]?.name}" ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            Object.values(store.documents).forEach(doc => {
                if (doc.relations.parent === id) doc.relations.parent = null;
                doc.relations.children = doc.relations.children.filter(c => c !== id);
                doc.relations.siblings = doc.relations.siblings.filter(s => s !== id);
                doc.relations.references = doc.relations.references.filter(r => r !== id);
            });

            delete store.documents[id];
            if (selectedDocId.value === id) {
                selectedDocId.value = null;
                highlightedDocs.value = [];
            }
            saveStore();
            showToast('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function addSiblingRelation(event) {
            const sibId = event.target.value;
            if (!sibId || !selectedDoc.value) return;

            if (!selectedDoc.value.relations.siblings.includes(sibId)) {
                selectedDoc.value.relations.siblings.push(sibId);
            }
            if (store.documents[sibId] && !store.documents[sibId].relations.siblings.includes(selectedDocId.value)) {
                store.documents[sibId].relations.siblings.push(selectedDocId.value);
            }

            event.target.value = '';
            saveStore();
            showToast('í˜•ì œ ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (ì–‘ë°©í–¥)', 'success');
        }

        function removeSiblingRelation(sibId) {
            if (!selectedDoc.value) return;
            selectedDoc.value.relations.siblings = selectedDoc.value.relations.siblings.filter(s => s !== sibId);

            if (store.documents[sibId]) {
                store.documents[sibId].relations.siblings =
                    store.documents[sibId].relations.siblings.filter(s => s !== selectedDocId.value);
            }

            saveStore();
        }

        function addReference(event) {
            const refId = event.target.value;
            if (!refId || !selectedDoc.value) return;

            if (!selectedDoc.value.relations.references.includes(refId)) {
                selectedDoc.value.relations.references.push(refId);
            }

            event.target.value = '';
            saveStore();
            showToast('ì°¸ì¡° ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¨ë°©í–¥)', 'success');
        }

        function removeReference(refId) {
            if (!selectedDoc.value) return;
            selectedDoc.value.relations.references = selectedDoc.value.relations.references.filter(r => r !== refId);
            saveStore();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kms_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.taxonomy || !data.documents) {
                        if (data.graph_data) {
                            Object.assign(store, migrateFromKnowledgeGraph(data));
                        } else {
                            throw new Error('Invalid format');
                        }
                    } else {
                        Object.assign(store, data);
                    }
                    saveStore();
                    showToast('ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
                } catch (err) {
                    showToast('ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function getCarrierName(id) {
            return store.taxonomy.carriers[id]?.name || id;
        }

        function getProductName(id) {
            return store.taxonomy.products[id]?.name || id;
        }

        function getDocTypeName(id) {
            return store.taxonomy.docTypes[id]?.name || id;
        }

        function getDocName(id) {
            return store.documents[id]?.name || id;
        }

        function getDocCountByCarrier(carrierId) {
            return Object.values(store.documents).filter(d => d.carrier === carrierId).length;
        }

        function getDocCountByCarrierTier(carrierId, tier) {
            return Object.values(store.documents).filter(d => d.carrier === carrierId && d.tier === tier).length;
        }

        function getDocsByCarrier(carrierId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (doc.carrier === carrierId) docs[id] = doc;
            });
            return docs;
        }

        function getDocsByProduct(productId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (doc.product === productId) docs[id] = doc;
            });
            return docs;
        }

        function getSupersededByProducts(productId) {
            const result = [];
            Object.entries(store.taxonomy.products).forEach(([id, product]) => {
                if (product.supersedes === productId) {
                    result.push({ id, name: product.name });
                }
            });
            return result;
        }

        function addCarrierAlias() {
            if (!newCarrierAlias.value.trim() || !selectedTaxonomy.id) return;
            const carrier = store.taxonomy.carriers[selectedTaxonomy.id];
            if (!carrier.alias) carrier.alias = [];
            carrier.alias.push(newCarrierAlias.value.trim());
            newCarrierAlias.value = '';
            saveStore();
        }

        function removeCarrierAlias(idx) {
            if (!selectedTaxonomy.id) return;
            store.taxonomy.carriers[selectedTaxonomy.id].alias.splice(idx, 1);
            saveStore();
        }

        function addProductAlias() {
            if (!newProductAlias.value.trim() || !selectedTaxonomy.id) return;
            const product = store.taxonomy.products[selectedTaxonomy.id];
            if (!product.alias) product.alias = [];
            product.alias.push(newProductAlias.value.trim());
            newProductAlias.value = '';
            saveStore();
        }

        function removeProductAlias(idx) {
            if (!selectedTaxonomy.id) return;
            store.taxonomy.products[selectedTaxonomy.id].alias.splice(idx, 1);
            saveStore();
        }

        function getRelationCount(doc) {
            const r = doc.relations || {};
            return (r.parent ? 1 : 0) + (r.children?.length || 0) + (r.siblings?.length || 0) + (r.references?.length || 0);
        }

        function getTotalRelations() {
            let count = 0;
            Object.values(store.documents).forEach(doc => {
                count += getRelationCount(doc);
            });
            return count;
        }

        function getTierClass(tier) {
            const classes = { HOT: 'bg-red-100 text-red-700', WARM: 'bg-yellow-100 text-yellow-700', COLD: 'bg-gray-100 text-gray-700' };
            return classes[tier] || 'bg-gray-100 text-gray-600';
        }

        function updateDocTier() {
            if (!selectedDoc.value) return;
            const docType = store.taxonomy.docTypes[selectedDoc.value.docType];
            if (docType) {
                selectedDoc.value.tier = docType.tier;
            }
        }

        function formatDate(isoString) {
            if (!isoString) return '-';
            return new Date(isoString).toLocaleString('ko-KR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // ê°„ë‹¨í•œ Markdown ë Œë”ëŸ¬
        function renderMarkdown(text) {
            if (!text) return '';
            return text
                // ì½”ë“œ ë¸”ë¡
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="bg-gray-800 text-green-400 p-3 rounded-lg overflow-x-auto text-xs"><code>$2</code></pre>')
                // ì¸ë¼ì¸ ì½”ë“œ
                .replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 rounded text-sm">$1</code>')
                // í—¤ë”
                .replace(/^### (.+)$/gm, '<h3 class="text-base font-bold mt-4 mb-2">$1</h3>')
                .replace(/^## (.+)$/gm, '<h2 class="text-lg font-bold mt-4 mb-2">$1</h2>')
                .replace(/^# (.+)$/gm, '<h1 class="text-xl font-bold mt-4 mb-2">$1</h1>')
                // êµµê²Œ/ì´íƒ¤ë¦­
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // ë§í¬
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-600 underline" target="_blank">$1</a>')
                // ë¦¬ìŠ¤íŠ¸
                .replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>')
                .replace(/(<li.*<\/li>\n?)+/g, '<ul class="list-disc my-2">$&</ul>')
                // ìˆ˜í‰ì„ 
                .replace(/^---$/gm, '<hr class="my-4 border-gray-300">')
                // ì¤„ë°”ê¿ˆ
                .replace(/\n/g, '<br>');
        }

        return {
            store,
            activeTab,
            viewMode,
            searchQuery,
            selectedDocId,
            selectedDoc,
            selectedTaxonomy,
            modal,
            docModal,
            uploadPreview,
            highlightedDocs,
            toasts,
            filteredDocuments,
            otherDocuments,
            availableSiblings,
            duplicateGroups,
            removeToast,
            showToast,
            saveStore,
            fitGraph,
            highlightRelatedDocs,
            getRelatedDocIds,
            selectDocument,
            selectTaxonomy,
            checkDocModalDuplicate,
            onDocMetaChange,
            handleFileUpload,
            confirmUpload,
            showAddModal,
            addTaxonomy,
            showAddDocModal,
            createDocument,
            deleteDocument,
            addSiblingRelation,
            removeSiblingRelation,
            addReference,
            removeReference,
            exportData,
            importData,
            getCarrierName,
            getProductName,
            getDocTypeName,
            getDocName,
            getDocCountByCarrier,
            getDocCountByCarrierTier,
            getDocsByCarrier,
            getDocsByProduct,
            getSupersededByProducts,
            getRelationCount,
            getTotalRelations,
            getTierClass,
            formatDate,
            newCarrierAlias,
            newProductAlias,
            addCarrierAlias,
            removeCarrierAlias,
            addProductAlias,
            removeProductAlias,
            contentViewMode,
            renderMarkdown
        };
    }
}).mount('#app');
</script>

</body>
</html>
