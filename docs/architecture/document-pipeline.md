# 보험 GA RAG 문서체계 설계서

## 1. 문서 분류체계 (6-Facet Taxonomy)

### 1.1 Facet 코드 체계

모든 문서는 6개 Facet의 **조합**으로 분류된다. 각 Facet은 독립적이며, 하나의 문서가 여러 Facet 값을 동시에 가질 수 있다(M:N).

```
Facet 1. 보험사 (Carrier)         → INS-{CODE}
Facet 2. 상품라인 (Product Line)   → PRD-{대분류}-{세분류}
Facet 3. 문서유형 (Document Type)  → DOC-{TYPE}
Facet 4. 업무프로세스 (Process)    → BIZ-{PROCESS}
Facet 5. 대상역할 (Audience)       → AUD-{ROLE}
Facet 6. 유효기간 (Validity)       → 상태코드 (active/scheduled/expired/superseded)
```

### 1.2 Facet 상세 코드 정의

#### Facet 1: 보험사 (Carrier)

| 코드 | 설명 | 비고 |
|------|------|------|
| INS-SAMSUNG | 삼성생명 | 동의어: 삼성, SL |
| INS-HANWHA | 한화생명 | 동의어: 한화, HL |
| INS-KYOBO | 교보생명 | 동의어: 교보, KL |
| INS-DB | DB손해보험 | 동의어: DB손보 |
| INS-MERITZ | 메리츠화재 | 동의어: 메리츠 |
| INS-COMMON | 공통 | 보험사 무관 자료 |

> **등록 규칙**: 신규 보험사 추가 시 `INS-{영문약칭}` 형식. 공식명칭 + 약칭을 동의어(synonym)로 반드시 등록.

#### Facet 2: 상품라인 (Product Line) — 2단계 계층

| 대분류 | 코드 | 세분류 예시 |
|--------|------|------------|
| 생명보험 | PRD-LIFE | PRD-LIFE-TERM(정기), PRD-LIFE-WHOLE(종신), PRD-LIFE-ENDOW(저축) |
| 건강보험 | PRD-HEALTH | PRD-HEALTH-CI(CI), PRD-HEALTH-MEDICAL(의료), PRD-HEALTH-CANCER(암) |
| 손해보험 | PRD-NONLIFE | PRD-NONLIFE-AUTO(자동차), PRD-NONLIFE-FIRE(화재), PRD-NONLIFE-LIAB(배상) |
| 연금 | PRD-ANNUITY | PRD-ANNUITY-TAX(세제적격), PRD-ANNUITY-VAR(변액) |
| 공통 | PRD-COMMON | 상품 무관 자료 |

> **매핑 규칙**: 보험사 고유 상품명은 반드시 내부 표준 분류에 매핑. 매핑 테이블(`ProductMapping`)에서 `보험사상품코드 → 내부분류코드` 관리.

#### Facet 3: 문서유형 (Document Type)

| 코드 | 유형 | 변경빈도 | 데이터 티어 |
|------|------|---------|-----------|
| DOC-PROD-GUIDE | 상품설명서 | 중간 | Warm |
| DOC-RATE-TABLE | 보험료표 | 중간 | Hot |
| DOC-COMPARISON | 비교표 | 중간 | Warm |
| DOC-POLICY-TERMS | 보통약관 | 낮음 | Cold |
| DOC-SPECIAL-TERMS | 특별약관 | 낮음 | Cold |
| DOC-EXCLUSION | 면책조항 | 낮음 | Cold |
| DOC-BROCHURE | 브로슈어 | 중간 | Warm |
| DOC-SCRIPT | 영업스크립트 | 중간 | Warm |
| DOC-TRAINING | 교육자료 | 낮음 | Cold |
| DOC-COMPLIANCE | 컴플라이언스 | 낮음 | Cold |
| DOC-UW-GUIDE | 심사가이드라인 | 낮음~중간 | Warm |
| DOC-UW-RULE | 심사기준 | 낮음 | Cold |
| DOC-COMMISSION | 수수료체계 | **높음** | **Hot** |
| DOC-INCENTIVE | 시책프로그램 | **높음** | **Hot** |
| DOC-SYSTEM-MANUAL | 시스템매뉴얼 | 낮음 | Cold |
| DOC-INTERNAL-MEMO | 내부메모/회의록 | - | Cold |
| DOC-BEST-PRACTICE | 베스트프랙티스 | 중간 | Warm |
| DOC-CASE-STUDY | 케이스스터디 | 중간 | Warm |
| DOC-EXPERT-TIP | 전문가팁 | 중간 | Warm |

#### Facet 4: 업무프로세스 (Business Process)

| 코드 | 프로세스 | 설명 |
|------|---------|------|
| BIZ-CONSULT | 상담/청약 | 고객 상담, 청약서 작성 |
| BIZ-UW | 심사 | 언더라이팅, 위험 평가 |
| BIZ-ISSUE | 계약발행 | 증권 발행, 계약 체결 |
| BIZ-MAINTAIN | 보전 | 계약 변경, 해지, 부활 |
| BIZ-CLAIM | 지급 | 보험금 청구, 심사, 지급 |
| BIZ-SETTLE | 수수료정산 | 수수료 계산, 정산 |
| BIZ-RECRUIT | 리크루팅 | 설계사 채용, 교육 |
| BIZ-COMMON | 공통 | 프로세스 무관 |

#### Facet 5: 대상역할 (Audience)

| 코드 | 역할 | 열람 권한 수준 |
|------|------|--------------|
| AUD-AGENT | 설계사 | 일반 |
| AUD-AGENT-GOLD | 골드등급 설계사 | 높음 |
| AUD-AGENT-NEW | 신입 설계사 | 일반 |
| AUD-UW | 언더라이터 | 높음 |
| AUD-CS | 고객서비스 | 일반 |
| AUD-MANAGER | 관리자 | 최고 |
| AUD-ALL | 전체 | - |

---

## 2. 문서 수명주기 (Document Lifecycle)

### 2.1 상태 전이도

```
                    ┌──────────────────────────┐
                    │                          │
                    ▼                          │
 ┌─────────┐   ┌─────────┐   ┌──────────┐   ┌┴─────────┐
 │ DRAFT   │──▶│REVIEWING│──▶│ APPROVED │──▶│ ACTIVE   │
 │ (임시)   │   │ (검토중) │   │ (승인됨)  │   │ (활성)    │
 └─────────┘   └────┬────┘   └──────────┘   └┬───┬─────┘
                    │                         │   │
                    │ 반려                     │   │ 대체 문서 등록
                    ▼                         │   ▼
               ┌─────────┐                   │  ┌───────────┐
               │REJECTED │                   │  │SUPERSEDED │
               │ (반려)   │                   │  │ (대체됨)   │
               └─────────┘                   │  └───────────┘
                                             │
                    ┌────────────────────────┘
                    │ 유효기간 만료 7일 전
                    ▼
               ┌──────────────┐   만료일 도달   ┌─────────┐
               │PENDING_EXPIRY│──────────────▶│EXPIRED  │
               │ (만료임박)     │               │ (만료)   │
               └──────────────┘               └────┬────┘
                                                   │ 90일 후
                                                   ▼
                                              ┌─────────┐
                                              │ARCHIVED │
                                              │ (보관)   │
                                              └─────────┘
```

### 2.2 상태 전이 규칙

| 현재 상태 | 전이 가능 상태 | 전이 조건 | 자동/수동 |
|----------|--------------|----------|----------|
| DRAFT | REVIEWING | 필수 메타데이터 완전성 검증 통과 | 수동 |
| REVIEWING | APPROVED | 검토자 승인 | 수동 |
| REVIEWING | REJECTED | 검토자 반려 (사유 필수) | 수동 |
| REJECTED | DRAFT | 수정 후 재제출 | 수동 |
| APPROVED | ACTIVE | effective_date 도달 또는 즉시 활성화 | 자동/수동 |
| ACTIVE | PENDING_EXPIRY | expiry_date 7일 전 | **자동** (스케줄러) |
| PENDING_EXPIRY | EXPIRED | expiry_date 도달 | **자동** (스케줄러) |
| ACTIVE | SUPERSEDED | 동일 문서의 신규 버전 ACTIVE 전환 시 | **자동** (연쇄) |
| EXPIRED | ARCHIVED | 만료 후 90일 경과 | **자동** (스케줄러) |
| ARCHIVED | ACTIVE | 관리자 수동 복원 (사유 필수) | 수동 |

### 2.3 버전 관리 정책

```
버전 번호: Major.Minor 체계

Major 증가 (v1.0 → v2.0):
  - 보험료율 변경
  - 수수료 구조 변경
  - 약관 조항 변경
  - 시책 조건 변경

Minor 증가 (v1.0 → v1.1):
  - 오타 수정
  - 서식 변경
  - 보충 설명 추가

버전 생성 규칙:
  1. 신규 버전 생성 시 이전 ACTIVE 버전은 자동으로 SUPERSEDED 전환
  2. SUPERSEDED 문서는 검색 가능하되 "대체됨" 경고 표시
  3. 과거 시점 조회(As-Of Query)를 위해 모든 버전 영구 보존
  4. 동일 문서에 ACTIVE 버전은 최대 1개만 존재 (불변 규칙)
```

---

## 3. 문서 수집 파이프라인 (Ingestion Pipeline)

### 3.1 전체 흐름도

```
 ┌─────────────────────────────────────────────────────────────────┐
 │                    문서 수집 파이프라인 (8단계)                      │
 └─────────────────────────────────────────────────────────────────┘

 [소스]              [Stage 1~3: 수집/검증]        [Stage 4~6: 처리]         [Stage 7~8: 활성화]
 
 보험사 포털 ─┐
 이메일     ─┤     ①        ②        ③        ④        ⑤        ⑥        ⑦        ⑧
 스프레드시트─┼──▶ 감지 ──▶ 검증 ──▶ 분류 ──▶ 추출 ──▶ 청킹 ──▶ 임베딩 ──▶ 활성화 ──▶ 알림
 내부 작성  ─┤    Gate1    Gate2    Gate3    Gate4    Gate5    Gate6    Gate7
 전문가 입력 ─┘
 
 실패 시: ──────▶ [격리 큐 (Quarantine)] ──▶ 수동 검토 ──▶ 재처리 or 폐기
```

### 3.2 단계별 상세 설계

---

#### Stage 1: 감지 (Detection)

**목적**: 신규/변경 문서 인입 감지

| 항목 | 내용 |
|------|------|
| **입력** | 외부 소스(포털 크롤링, 이메일 첨부, 수동 업로드) |
| **출력** | 원본 파일 + 수집 메타데이터(소스, 수집일시, 수집자) |
| **처리** | 파일 해시(SHA-256) 생성, 중복 체크, 원본 보관 |

**Gate 1: 중복/무결성 검증**
```
검증 규칙:
  ✓ 파일 해시 중복 체크 → 기존 동일 해시 존재 시 SKIP (로그 기록)
  ✓ 파일 크기 > 0 bytes
  ✓ 지원 포맷 확인: PDF, DOCX, XLSX, PPTX, HWP, PNG/JPG(스캔본)
  ✓ 파일 손상 여부 (열기 테스트)
  ✗ 실패 시: 격리 큐 + 알림 "파일 손상 또는 미지원 포맷"
```

---

#### Stage 2: 검증 (Validation)

**목적**: 문서 진위 확인 및 필수 정보 존재 여부 검증

| 항목 | 내용 |
|------|------|
| **입력** | Stage 1 통과 파일 |
| **출력** | 검증 결과 리포트 (통과/실패/경고) |
| **처리** | 문서 유형별 검증 규칙 적용 |

**Gate 2: 문서 품질 검증**

```
[공통 검증 규칙]
  ✓ OCR 가독성 점수 ≥ 0.8 (스캔 문서의 경우)
  ✓ 텍스트 추출 가능 여부
  ✓ 언어 감지 = 한국어 (또는 허용된 언어)
  ✓ 페이지 수 > 0

[문서유형별 검증 규칙]

  DOC-INCENTIVE (시책):
    ✓ 보험사명 식별 가능
    ✓ 유효기간(시작일~종료일) 존재
    ✓ 수수료율 또는 인센티브 조건 존재
    ✓ 대상 등급/상품 명시
    ⚠ 이전 시책과 유효기간 중복 시 경고

  DOC-RATE-TABLE (보험료표):
    ✓ 테이블 구조 감지 (행×열)
    ✓ 숫자 데이터 비율 ≥ 30%
    ✓ 상품명/상품코드 식별 가능
    ✓ 보험료 단위(원) 식별

  DOC-COMMISSION (수수료체계):
    ✓ 보험사명 식별
    ✓ 등급별 수수료율 테이블 존재
    ✓ 적용기간 식별

  DOC-POLICY-TERMS (약관):
    ✓ 조항 번호 체계 존재 (제1조, 제2조...)
    ✓ 목차 존재 여부 (없으면 경고)
    ✓ 보험사/상품 식별

  DOC-UW-GUIDE (심사가이드):
    ✓ 심사 조건/기준 식별
    ✓ 보험사/상품 범위 식별

  DOC-BEST-PRACTICE / DOC-EXPERT-TIP (암묵지):
    ✓ 작성자 식별 (전문가 디렉토리 대조)
    ✓ 관련 공식 문서 참조 존재 (없으면 경고)
    ✓ 동료 리뷰 완료 여부

  ✗ 실패 시: 격리 큐 + 검증 실패 상세 리포트 생성
  ⚠ 경고 시: 처리 계속하되 수동 검토 플래그 설정
```

---

#### Stage 3: 분류 (Classification)

**목적**: 6-Facet 분류 태깅

| 항목 | 내용 |
|------|------|
| **입력** | Stage 2 통과 문서 |
| **출력** | 6-Facet 태그 세트 + 신뢰도 점수 |
| **처리** | 자동 분류 + 수동 보정 |

**분류 전략**:
```
자동 분류 우선순위:
  1순위: 파일명/경로 기반 규칙 (정규식 매칭)
         예: "삼성생명_종신보험_수수료체계_202502.pdf"
         → INS-SAMSUNG, PRD-LIFE-WHOLE, DOC-COMMISSION

  2순위: 본문 키워드 기반 규칙 매칭
         예: "인센티브", "시책", "보너스" → DOC-INCENTIVE
             "약관", "제1조", "보통약관" → DOC-POLICY-TERMS

  3순위: LLM 기반 분류 (신뢰도 점수 포함)
         프롬프트: "다음 문서를 6개 Facet으로 분류하시오..."
         신뢰도 < 0.7 → 수동 검토 플래그
```

**Gate 3: 분류 완전성 검증**
```
검증 규칙:
  ✓ Facet 1(보험사): 최소 1개 태그 (INS-COMMON 허용)
  ✓ Facet 2(상품라인): 최소 1개 태그 (PRD-COMMON 허용)
  ✓ Facet 3(문서유형): 정확히 1개 태그 (필수, 단일 선택)
  ✓ Facet 4(업무프로세스): 최소 1개 태그
  ✓ Facet 5(대상역할): 최소 1개 태그
  ✓ Facet 6(유효기간): 상태 + 날짜 설정
     - DOC-INCENTIVE, DOC-COMMISSION: effective_date 필수
     - DOC-POLICY-TERMS: effective_date 권장
  ✓ 자동분류 신뢰도 ≥ 0.7 (미만 시 수동 검토 필수)
  ✗ Facet 3 미지정 시: 처리 중단, 수동 분류 요청
```

---

#### Stage 4: 추출 (Extraction)

**목적**: 문서에서 구조화 데이터 및 핵심 조건 추출

| 항목 | 내용 |
|------|------|
| **입력** | 분류 완료 문서 |
| **출력** | 구조화 데이터(JSON) + 원문 텍스트 |
| **처리** | 문서유형별 추출 전략 적용 |

**문서유형별 추출 전략**:

```
DOC-INCENTIVE (시책):
  추출 대상:
    - insurer_code: 보험사 코드
    - program_name: 시책명
    - effective_date / expiry_date: 유효기간
    - conditions[]: 조건 목록
        - target_products[]: 대상 상품
        - target_tiers[]: 대상 등급
        - metric: 달성 기준 (건수/실적 등)
        - threshold: 기준값
        - reward_type: 보상 유형 (추가수수료/상품/포인트)
        - reward_value: 보상값
    - special_notes: 특이사항

DOC-RATE-TABLE (보험료표):
  추출 대상:
    - 테이블 구조 보존 (Markdown 형식)
    - 행/열 헤더 식별
    - 테이블별 설명 메타데이터 ("30세 남성 기준 월납 보험료")
  주의: 테이블은 절대 일반 텍스트로 평탄화하지 않음

DOC-COMMISSION (수수료체계):
  추출 대상:
    - insurer_code
    - tier_rates[]: 등급별 수수료율
        - tier: 등급명
        - initial_rate: 초년도 수수료율
        - renewal_rate: 차년도 수수료율
        - conditions: 조건
    - effective_date / expiry_date

DOC-POLICY-TERMS (약관):
  추출 대상:
    - 조항 단위 분리 (제N조 → 독립 청크)
    - 조항 간 참조 관계 추출 ("제5조에 의한...")
    - 핵심 키워드 추출

DOC-EXPERT-TIP / DOC-BEST-PRACTICE (암묵지):
  추출 대상:
    - author: 작성자
    - context: 적용 상황/맥락
    - recommendation: 권장 행동
    - related_docs[]: 관련 공식 문서 참조
    - confidence_level: 확신도 (작성자 자가 평가)
```

**Gate 4: 추출 품질 검증**
```
검증 규칙:
  ✓ 필수 추출 필드 완전성 (문서유형별 필수 필드 모두 존재)
  ✓ 날짜 형식 유효성 (YYYY-MM-DD)
  ✓ 수치 데이터 범위 검증 (수수료율 0~100%, 보험료 > 0)
  ✓ 보험사 코드가 마스터 테이블에 존재
  ✓ 상품 코드가 매핑 테이블에 존재 (없으면 신규 매핑 요청)
  ✓ 테이블 추출 시 행×열 일관성 (빈 셀 비율 < 20%)
  ⚠ 추출 신뢰도 < 0.8: 수동 검토 플래그
  ✗ 필수 필드 누락 시: 격리 큐 + 수동 보완 요청
```

---

#### Stage 5: 청킹 (Chunking)

**목적**: 검색에 최적화된 단위로 문서 분할

| 항목 | 내용 |
|------|------|
| **입력** | 추출 완료 데이터 |
| **출력** | 청크 목록 + 청크별 메타데이터 |
| **처리** | 문서유형별 청킹 전략 적용 |

**문서유형별 청킹 전략**:

```
┌──────────────────┬─────────────────────┬───────────┬─────────┐
│ 문서유형          │ 청킹 전략            │ 청크 크기   │ 오버랩   │
├──────────────────┼─────────────────────┼───────────┼─────────┤
│ 약관 (법률문서)    │ 계층적/의미적 청킹    │ 512~1024  │ 15%     │
│                  │ (조항 단위 우선)       │ 토큰      │         │
├──────────────────┼─────────────────────┼───────────┼─────────┤
│ 상품안내장        │ 섹션 기반 재귀적 청킹  │ 256~512   │ 10~15%  │
│                  │                     │ 토큰      │         │
├──────────────────┼─────────────────────┼───────────┼─────────┤
│ 교육자료          │ 부모-자식 청킹        │ 512 토큰   │ 15%     │
│                  │ (Parent: 1024)       │          │         │
├──────────────────┼─────────────────────┼───────────┼─────────┤
│ 보험료표/수수료표  │ 테이블 단위 보존      │ 전체      │ N/A     │
│                  │ (Markdown 형식)      │ 테이블    │         │
├──────────────────┼─────────────────────┼───────────┼─────────┤
│ 시책 프로그램     │ 문서 단위            │ 256~512   │ 10%     │
│                  │ + 핵심 조건 구조화     │ 토큰      │         │
├──────────────────┼─────────────────────┼───────────┼─────────┤
│ 전문가팁/BP      │ 개별 팁 단위 청킹     │ 256~512   │ 10%     │
│                  │                     │ 토큰      │         │
└──────────────────┴─────────────────────┴───────────┴─────────┘
```

**테이블 데이터 처리 원칙**:
```
절대 원칙: 테이블을 일반 텍스트로 평탄화(flatten)하지 않는다.

보존 방식:
  1. Markdown 테이블 형식으로 구조 보존
  2. 테이블 설명 메타데이터를 함께 임베딩
     예: "삼성생명 종신보험 30세 남성 월납 보험료 테이블"
  3. 큰 테이블은 논리적 단위로 분할
     예: 연령대별(20대/30대/40대...) 또는 조건별

임베딩 전략:
  - 테이블 본문 + 테이블 설명 메타데이터를 결합하여 임베딩
  - "어떤 보험사의 어떤 상품의 어떤 조건 테이블인지"를 
    임베딩 텍스트에 포함
```

**청크 메타데이터 스키마**:
```json
{
  "chunk_id": "UUID",
  "document_id": "UUID",
  "document_version_id": "UUID",
  "chunk_sequence": 1,
  "chunk_type": "text | table | structured_condition",
  
  "facet_tags": {
    "insurers": ["INS-SAMSUNG"],
    "products": ["PRD-LIFE-WHOLE"],
    "doc_type": "DOC-COMMISSION",
    "processes": ["BIZ-SETTLE"],
    "audiences": ["AUD-AGENT"],
    "validity_status": "active"
  },
  
  "temporal": {
    "valid_from": "2025-02-01",
    "valid_to": "2025-03-31"
  },
  
  "content": {
    "text": "청크 본문...",
    "parent_section": "3. 수수료 체계",
    "has_table": true,
    "keywords": ["수수료", "골드등급", "초년도"]
  },
  
  "data_tier": "hot",
  "embedding_model": "ko-sroberta-multitask",
  "embedded_at": "2025-02-01T09:00:00Z"
}
```

**Gate 5: 청킹 품질 검증**
```
검증 규칙:
  ✓ 청크 크기 범위 내 (최소 50 토큰, 최대 1500 토큰)
  ✓ 빈 청크 없음 (텍스트 길이 > 0)
  ✓ 메타데이터 완전성 (facet_tags 6개 모두 존재)
  ✓ 테이블 청크: Markdown 파싱 가능 여부
  ✓ 청크 시퀀스 연속성 (1, 2, 3... 빠짐 없음)
  ✓ Parent-child 관계 정합성 (부모 청크 존재 확인)
  ⚠ 평균 청크 크기가 문서유형 기준 대비 ±50% 벗어나면 경고
```

---

#### Stage 6: 임베딩 (Embedding)

**목적**: 벡터 생성 및 인덱스 적재

| 항목 | 내용 |
|------|------|
| **입력** | 청크 + 메타데이터 |
| **출력** | 벡터 인덱스 적재 완료 |
| **처리** | 티어별 벡터 인덱스 분리 적재 |

**티어별 벡터 인덱스 분리 전략**:
```
┌─────────────────────────────────────────────────┐
│              벡터 인덱스 구조                      │
├──────────┬──────────────────────────────────────┤
│ Hot 인덱스 │ 시책, 수수료, 보험료표                  │
│          │ 재임베딩: 매일                          │
│          │ 스토리지: 인메모리 우선                   │
│          │ 검색 우선순위: 1순위                     │
├──────────┼──────────────────────────────────────┤
│ Warm 인덱스│ 상품설명, 심사가이드, 영업자료, BP       │
│          │ 재임베딩: 매주                          │
│          │ 스토리지: 디스크 기반                    │
│          │ 검색 우선순위: 2순위                     │
├──────────┼──────────────────────────────────────┤
│ Cold 인덱스│ 약관, 교육자료, 컴플라이언스             │
│          │ 재임베딩: 연 1회 또는 변경 시             │
│          │ 스토리지: 아카이브                       │
│          │ 검색 우선순위: 3순위 (명시적 요청 시)      │
└──────────┴──────────────────────────────────────┘

검색 시 동작:
  기본: Hot + Warm 인덱스만 검색
  "약관" 키워드 감지 시: Cold 인덱스 포함
  "이전 시책", "작년" 감지 시: Archived 인덱스 포함
```

**Gate 6: 임베딩 품질 검증**
```
검증 규칙:
  ✓ 벡터 차원 수 일치 (모델별 기대 차원)
  ✓ 벡터 norm 범위 (0이 아닌 정상 벡터)
  ✓ 적재된 청크 수 = 생성된 청크 수
  ✓ 메타데이터 필터 인덱스 정상 생성
  ✓ 샘플 쿼리 테스트 (대표 질의 3개로 관련 청크 반환 확인)
  ✗ 샘플 쿼리 적합도 < 0.5: 임베딩 품질 경고
```

---

#### Stage 7: 활성화 (Activation)

**목적**: 문서를 검색 가능 상태로 전환

| 항목 | 내용 |
|------|------|
| **입력** | 임베딩 완료 문서 |
| **출력** | ACTIVE 상태 문서 + 이전 버전 SUPERSEDED 처리 |
| **처리** | 상태 전이 + 이전 버전 처리 + Knowledge Graph 업데이트 |

**활성화 처리 순서**:
```
1. effective_date 확인
   - effective_date ≤ 오늘 → 즉시 활성화
   - effective_date > 오늘 → APPROVED 상태로 대기 (스케줄러가 처리)

2. 이전 버전 처리 (동일 문서의 기존 ACTIVE 버전이 있는 경우)
   a. 기존 ACTIVE 버전 → SUPERSEDED 전환
   b. 기존 벡터 인덱스에서 제거 (또는 "superseded" 필터 태그 추가)
   c. 버전 이력 연결 (previous_version_id 설정)

3. Knowledge Graph 업데이트
   - 관련 노드/엣지 갱신 (보험사→상품→문서 관계)
   - 시책의 경우: 시간 엣지(VALID_DURING) 업데이트

4. 캐시 무효화
   - 관련 FAQ/자주 묻는 질의 캐시 클리어
```

**Gate 7: 활성화 전 최종 검증**
```
검증 규칙:
  ✓ 동일 문서에 ACTIVE 버전이 2개 이상 되지 않는지 확인
  ✓ 유효기간이 과거가 아닌지 (이미 만료된 문서를 ACTIVE로 전환 방지)
  ✓ 필수 메타데이터 최종 확인
  ✓ 벡터 인덱스에 정상 적재 확인
  ✓ 시책/수수료: 기존 활성 데이터와 유효기간 중복 검사
     → 중복 시 경고 (의도된 중복인지 확인 필요)
```

---

#### Stage 8: 알림 (Notification)

**목적**: 관련자에게 변경 사항 통지

```
알림 대상 결정 규칙:
  DOC-INCENTIVE 변경 → 해당 보험사 담당 설계사 전원
  DOC-COMMISSION 변경 → 전체 설계사 + 정산 담당자
  DOC-RATE-TABLE 변경 → 해당 상품 판매 설계사
  DOC-UW-GUIDE 변경  → 언더라이터 + 관련 설계사
  DOC-POLICY-TERMS   → 전체 공지 (약관 변경은 중요)

알림 내용:
  - 문서명, 변경 요약
  - 이전 버전과의 주요 차이점 (diff)
  - 유효기간
  - 영향받는 상품/프로세스
```

---

## 4. SSOT 충돌 해결 의사결정 트리

```
질의 응답 시 데이터 충돌이 감지되면 다음 순서로 해결:

                      충돌 감지
                         │
              ┌──────────┴──────────┐
              │ 데이터 유형이 무엇인가? │
              └──────────┬──────────┘
                         │
          ┌──────────────┼──────────────┐
          │              │              │
     정량적 데이터     정성적 데이터     시간 관련
     (금액,요율,건수)  (설명,해석,가이드)  (유효기간)
          │              │              │
          ▼              ▼              ▼
    Core DB 우선     문서저장소 우선   Bi-Temporal
    (계산 결과는      (맥락/해석은      쿼리 적용
     시스템이 권한)    문서가 권한)     (최신 유효 버전)
          │              │              │
          │         ┌────┴────┐         │
          │         │         │         │
          │    공식 문서   전문가 지식    │
          │    (1순위)    (2순위)        │
          │         │         │         │
          ▼         ▼         ▼         ▼
    ┌─────────────────────────────────────┐
    │       응답에 출처 명시 (필수)          │
    │  "Core DB 기준 수수료율은 X%이며,      │
    │   시책 문서에 따르면 Y 조건 충족 시     │
    │   추가 Z%가 적용됩니다."              │
    └─────────────────────────────────────┘
```

**충돌 시나리오별 해결 규칙**:

| 시나리오 | 규칙 | 예시 |
|---------|------|------|
| DB 금액 vs 문서 요율 | DB=실제 계산결과, 문서=요율 정의의 권한 출처 | "DB상 수수료 50만원 (문서 기준 수수료율 3.5% 적용)" |
| 복수 문서 버전 존재 | effective_date 기반 최신 유효 버전 | 2월 시책 vs 3월 시책 → 조회 시점 기준 |
| 보험사별 vs 일반 규정 | 특정 보험사 문서가 해당 보험사에 대해 우선 | 삼성생명 심사기준 > 일반 심사가이드 |
| 공식 문서 vs 전문가 지식 | 공식 문서 우선, 전문가 지식은 보충 | "약관 제5조에 따르면... (참고: 실무에서는...)" |
| 전문가 간 의견 충돌 | 리뷰 완료된 버전 우선, 충돌 플래그 | 관리자에게 충돌 해소 요청 알림 |

---

## 5. 검증 대시보드 지표 (Quality Metrics)

### 5.1 파이프라인 모니터링 지표

```
[수집 건전성]
  - 일별 수집 건수 (소스별)
  - Gate 통과율 (Gate 1~7 각각)
  - 격리 큐 적재 건수 / 해소율
  - 평균 처리 시간 (수집→활성화)

[분류 품질]
  - 자동분류 정확도 (수동 보정 비율)
  - Facet별 미분류(COMMON) 비율
  - 분류 신뢰도 분포

[데이터 신선도]
  - Hot 티어 평균 데이터 연령 (목표: < 24시간)
  - Warm 티어 평균 데이터 연령 (목표: < 7일)
  - 만료 임박(PENDING_EXPIRY) 문서 수
  - 만료 후 미처리(후속 버전 없음) 문서 수 ← 위험 지표

[검색 품질]
  - 샘플 질의 적합도 점수 (주간 자동 테스트)
  - 사용자 피드백 (👍👎 비율)
  - 출처 없는 응답 비율 (목표: < 5%)

[SSOT 일관성]
  - DB-문서 간 충돌 감지 건수
  - 충돌 해소 평균 시간
  - 미해소 충돌 누적 건수 ← 위험 지표
```

### 5.2 정기 검증 스케줄

| 검증 항목 | 주기 | 담당 | 방법 |
|----------|------|------|------|
| Hot 티어 데이터 신선도 | 매일 | 자동 | 만료/변경 체크 스케줄러 |
| 샘플 질의 적합도 테스트 | 매주 | 자동 | 대표 질의 20개 자동 실행 |
| 분류 정확도 샘플링 | 매주 | 수동 | 최근 수집 50건 중 10건 랜덤 검토 |
| Warm 티어 데이터 갱신 | 매주 | 자동 | 변경 감지 → 재임베딩 |
| SSOT 충돌 감사 | 월 1회 | 수동 | DB-문서 교차 검증 리포트 |
| Cold 티어 유효성 | 분기 1회 | 수동 | 약관/규정 변경 여부 확인 |
| 전체 임베딩 품질 | 분기 1회 | 반자동 | 임베딩 드리프트 측정 |
| 암묵지 리뷰 | 분기 1회 | 수동 | 전문가 팁/BP 현행화 확인 |
| 전체 Taxonomy 리뷰 | 연 1회 | 수동 | 분류체계 적정성 재검토 |

---

## 6. 암묵지 관리 체계

### 6.1 캡처 프로세스

```
전문가 지식 캡처 워크플로우:

  ┌─────────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐
  │ 전문가    │────▶│ 구조화    │────▶│ 동료 리뷰 │────▶│ 등록     │
  │ 인터뷰/   │     │ 템플릿    │     │ (최소 1명) │     │ & 태깅   │
  │ 경험 기록  │     │ 작성      │     │          │     │         │
  └─────────┘     └──────────┘     └──────────┘     └─────────┘

구조화 템플릿:
  ┌─────────────────────────────────────────────┐
  │ [상황/맥락] 어떤 상황에서 이 지식이 필요한가?    │
  │ [판단 기준] 어떤 기준으로 의사결정 하는가?       │
  │ [권장 행동] 구체적으로 어떻게 해야 하는가?       │
  │ [주의사항] 흔한 실수나 예외 상황은?             │
  │ [관련 문서] 참조할 공식 문서는?                │
  │ [신뢰도] 작성자 자가 평가 (상/중/하)           │
  │ [유효범위] 특정 보험사/상품에 한정되는가?        │
  └─────────────────────────────────────────────┘
```

### 6.2 암묵지 품질 등급

| 등급 | 조건 | 검색 시 표시 |
|------|------|------------|
| **검증됨 (Verified)** | 동료 리뷰 완료 + 공식 문서 연결 있음 | 일반 표시 |
| **리뷰됨 (Reviewed)** | 동료 리뷰 완료, 공식 문서 연결 없음 | "전문가 의견" 라벨 |
| **미리뷰 (Unreviewed)** | 리뷰 전 상태 | "미검증 전문가 의견" 경고 |
| **구식 (Stale)** | 마지막 리뷰 후 6개월 경과 | "최신성 미확인" 경고 |

---

## 7. 물리적 저장소 구조

### 7.1 디렉토리 구조

```
/knowledge-base/
├── /originals/                    # 원본 파일 (불변, 감사용)
│   └── /{YYYY}/{MM}/
│       └── {SHA256_PREFIX}_{원본파일명}
│
├── /processed/                    # 처리 완료 파일
│   └── /{InsurerCode}/
│       └── /{DocTypeCode}/
│           └── /{파일명}_v{Version}.{ext}
│
├── /quarantine/                   # 격리 큐 (검증 실패)
│   └── /{YYYY-MM-DD}/
│       └── {원본파일명}
│       └── {원본파일명}.validation-report.json
│
├── /extracted/                    # 추출된 구조화 데이터
│   └── /{DocumentID}/
│       └── metadata.json
│       └── chunks/
│           └── chunk_{seq}.json
│
└── /archive/                      # 아카이브 (ARCHIVED 상태)
    └── /{YYYY}/
        └── ...
```

### 7.2 파일 명명 규칙

```
패턴: {InsurerCode}_{DocTypeCode}_{ProductCode}_{YYYYMMDD}_v{Major}.{Minor}.{ext}

예시:
  SAMSUNG_INCENTIVE_LIFE-WHOLE_20250201_v1.0.pdf
  HANWHA_COMMISSION_COMMON_20250115_v2.0.xlsx
  COMMON_UW-GUIDE_HEALTH-CI_20250101_v1.1.pdf
  INTERNAL_BEST-PRACTICE_COMMON_20250203_v1.0.md

특수 케이스:
  - 보험사 무관: COMMON
  - 상품 무관: COMMON
  - 암묵지: INTERNAL 접두사
```
