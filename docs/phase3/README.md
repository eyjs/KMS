# Phase 3: RAG 시스템 연동

> **Version** 3.0 | 2026-02 | 미래 단계

---

## 1. 목표

**AI 기반 검색 증강 생성(RAG) 시스템을 구축한다.**

자연어 질의를 분석하여 적절한 검색 전략을 선택하고,
문서 + 그래프를 융합하여 정확한 답변을 생성:
- 의도 분류 → 검색 전략 결정
- 하이브리드 검색 (벡터 + 그래프 + 메타데이터)
- LLM 응답 생성 + 출처 인용

---

## 2. 아키텍처

```
┌──────────────────────────────────────────────────────────┐
│                    사용자 질의                             │
└────────────────────────┬─────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────┐
│                   쿼리 오케스트레이터                        │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────┐ │
│  │ 의도 분류기   │→│ 쿼리 라우터   │→│ 메타데이터 필터 │ │
│  └──────────────┘  └──────────────┘  └────────────────┘ │
└────┬──────────────────┬──────────────────┬───────────────┘
     │                  │                  │
┌────▼─────┐    ┌───────▼──────┐    ┌──────▼──────┐
│ Qdrant   │    │   Neo4j      │    │  메타데이터   │
│ 벡터 검색 │    │  그래프 탐색  │    │   필터 DB    │
└────┬─────┘    └───────┬──────┘    └──────┬──────┘
     │                  │                  │
     └──────────┬───────┘──────────────────┘
                │
┌───────────────▼──────────────────────────────────────────┐
│                   결과 융합 & 응답 생성                     │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐│
│  │ 결과 리랭킹   │→│ 충돌 해결기   │→│ LLM + 출처 인용  ││
│  └──────────────┘  └──────────────┘  └─────────────────┘│
└──────────────────────────────────────────────────────────┘
```

---

## 3. 의도 분류

### 3.1 질의 유형

| 의도 | 예시 | 검색 전략 |
|------|------|----------|
| 사실 조회 | "삼성생명 종신보험 수수료율은?" | 구조화 DB 우선 |
| 문서 검색 | "KB손해 어린이보험 약관 보여줘" | 메타데이터 필터 |
| 비교 분석 | "종신보험 수수료 높은 보험사 Top 5" | 그래프 집계 |
| 관계 탐색 | "이 시책 관련 문서 전부" | 그래프 전파 |
| 개념 설명 | "1200%룰이 뭐야?" | 온톨로지 + 문서 |
| 절차 안내 | "청약 절차 알려줘" | 프로세스 기반 |

### 3.2 메타데이터 자동 추출

```
사용자: "삼성생명 종신보험 골드등급 수수료율은?"

→ 의도 분석:
  {
    "intent": "factual_lookup",
    "entities": {
      "carrier": "삼성생명",
      "product": "종신보험",
      "tier": "골드",
      "info_type": "수수료율"
    }
  }

→ 필터 변환:
  {
    "domain": "GA-SALES",
    "carrier": "INS-SAMSUNG",
    "product.category": "life/whole_life",
    "docType": ["DOC-COMMISSION", "DOC-INCENTIVE"],
    "lifecycle": "ACTIVE"
  }
```

---

## 4. 하이브리드 검색

### 4.1 검색 전략 조합

```
[전략 1: 벡터 검색]
├── 의미적 유사도 기반
├── 메타데이터 필터 적용
└── HOT/WARM 인덱스 우선

[전략 2: 그래프 탐색]
├── 시작 문서에서 관계 전파
├── 다중 홉 탐색 (depth 제한)
└── 관계 가중치 적용

[전략 3: 구조화 조회]
├── 수수료/시책 테이블 직접 조회
├── 정확한 수치 반환
└── 계산 로직 적용
```

### 4.2 결과 융합

```
[리랭킹 기준]
1. 신선도 (HOT > WARM > COLD)
2. 라이프사이클 (ACTIVE > STALE)
3. 의미적 관련성 (벡터 유사도)
4. 관계 거리 (직접 참조 > 2홉 > 3홉)
```

---

## 5. 충돌 해결

### 5.1 의사결정 트리

```
복수 출처의 정보가 충돌하는가?
│
├─ 아니오 → 단일 출처 결과 반환
│
└─ 예 → 출처 유형이 다른가?
    │
    ├─ DB vs 문서 충돌
    │   ├─ 금액/수치 → DB(계산 결과) 우선
    │   └─ 규정/조건 → 문서(원본) 우선
    │
    ├─ 복수 문서 버전 충돌
    │   └─ 현재 유효 버전 우선 (lifecycle = ACTIVE)
    │
    └─ 보험사별 vs 일반 규정
        └─ 해당 보험사 문서가 그 보험사에 대해 우선
```

### 5.2 출처 인용

```
[응답 형식]

답변 내용...

---
**출처:**
1. [삼성생명 종신보험 수수료체계 v2.0](doc-id) (2026-02-01)
2. [2026년 2월 시책 공지](doc-id) (2026-02-01)

※ 본 답변은 위 문서를 기반으로 생성되었습니다.
```

---

## 6. Phase 1 자산 재활용

| Phase 1 자산 | Phase 3 활용 |
|-------------|-------------|
| `taxonomy.py` | 메타데이터 필터 스키마 |
| `ontology.py` | 동의어/시소러스 |
| 지식 그래프 구조 | 관계 전파 로직 |
| 샘플 문서 | 학습/테스트 데이터 |

---

## 7. 완료 기준

| 기준 | 상태 |
|------|------|
| 의도 분류기 구현 | 예정 |
| 하이브리드 검색 통합 | 예정 |
| 결과 융합 로직 구현 | 예정 |
| LLM 응답 생성 파이프라인 | 예정 |
| 출처 인용 시스템 | 예정 |
| 검색 정확도 80%+ | 예정 |

---

## 8. 성공 지표

| 지표 | Phase 2 | Phase 3 목표 |
|------|---------|-------------|
| 검색 정확도 | 기준선 | 90%+ |
| 응답 시간 | - | < 3초 |
| 출처 포함률 | - | 100% |
| 사용자 만족도 | - | 80%+ |
