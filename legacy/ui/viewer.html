<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iFA ì§€ì‹ì²´ê³„ Explorer</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; display: flex; height: 100vh; background: #fafafa; }
        
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ (NotebookLM ëŠë‚Œ) */
        #sidebar {
            width: 420px;
            background: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        #search-container { padding: 24px; border-bottom: 1px solid #f0f0f0; }
        #search-input {
            width: 100%; padding: 14px; border: 1px solid #d1d1d1; border-radius: 12px;
            font-size: 15px; outline: none; transition: border-color 0.2s;
            background: #f9f9f9;
        }
        #search-input:focus { border-color: #007bff; background: #fff; }

        #content-area { flex: 1; overflow-y: auto; padding: 10px; }
        .card {
            background: #fff; border: 1px solid #eef0f2; border-radius: 10px;
            padding: 16px; margin-bottom: 12px; cursor: pointer; transition: 0.2s;
        }
        .card:hover { border-color: #007bff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card.active { border-left: 4px solid #007bff; background: #f0f7ff; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 20px; color: white; font-weight: bold; }
        .bg-root { background: #2c3e50; }
        .bg-carrier { background: #8e44ad; }
        .bg-product { background: #007bff; }
        .bg-doc { background: #6c757d; }

        #detail-view {
            padding: 24px; background: #fdfdfd; border-top: 1px solid #eee; height: 45%; overflow-y: auto;
            display: none;
        }
        #detail-view.active { display: block; }
        .prop-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .prop-table th { text-align: left; font-size: 12px; color: #888; padding: 4px 0; width: 100px; }
        .prop-table td { font-size: 14px; color: #333; padding: 4px 0; }

        /* ê·¸ë˜í”„ ì˜ì—­ */
        #network-container { flex: 1; position: relative; background: #fff; }
        #network { width: 100%; height: 100%; }
        
        .floating-controls {
            position: absolute; bottom: 30px; right: 30px;
            display: flex; gap: 10px;
        }
        .btn-round {
            background: #fff; border: 1px solid #ddd; padding: 10px 20px;
            border-radius: 30px; cursor: pointer; font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="search-container">
        <input type="text" id="search-input" placeholder="ë¬¸ì„œ ë˜ëŠ” ë³´í—˜ì‚¬ ê²€ìƒ‰...">
    </div>
    
    <div id="content-area">
        <div id="list-container"></div>
    </div>

    <div id="detail-view">
        <h2 id="detail-title" style="margin:0 0 10px 0; font-size:18px;"></h2>
        <div id="detail-props"></div>
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        <div style="font-size:12px; font-weight:bold; color:#666; margin-bottom:10px;">ì—°ê³„ ì •ë³´</div>
        <div id="detail-links"></div>
    </div>
</div>

<div id="network-container">
    <div id="network"></div>
    <div class="floating-controls">
        <button class="btn-round" onclick="network.fit({animation:true})">ì „ì²´ ì¤‘ì•™ ì •ë ¬</button>
    </div>
</div>

<script>
    let network;
    let nodesDS;
    let edgesDS;
    let rawData = [];

    // ì†ì„± ë° ê°’ í•œê¸€ ë§¤í•‘ ì‚¬ì „
    const labelMap = {
        'id': 'ì‹ë³„ì(ID)',
        'name': 'ëª…ì¹­',
        'type': 'ìœ í˜•',
        'version': 'ë²„ì „',
        'carrier': 'ì†Œì† ë³´í—˜ì‚¬',
        'product': 'ìƒí’ˆêµ°',
        'tier': 'ë³€ê²½ë¹ˆë„',
        'file_path': 'íŒŒì¼ê²½ë¡œ',
        'alias': 'ë³„ì¹­',
        'description': 'ìƒì„¸ ì„¤ëª…',
        'category': 'ìƒí’ˆ ì¹´í…Œê³ ë¦¬',
        // ë¬¸ì„œ ìœ í˜• ë§¤í•‘
        'DOC-TERMS': 'ì•½ê´€',
        'DOC-GUIDE': 'ìƒí’ˆì„¤ëª…ì„œ',
        'DOC-SCRIPT': 'íŒë§¤ìŠ¤í¬ë¦½íŠ¸',
        'DOC-INCENTIVE': 'ì‹œì±…',
        'DOC-COMMISSION': 'ìˆ˜ìˆ˜ë£Œ',
        'DOC-TRAINING': 'êµìœ¡ìë£Œ',
        // ë³´í—˜ì‚¬ ë§¤í•‘
        'INS-SAMSUNG': 'ì‚¼ì„±ìƒëª…',
        'INS-HANWHA': 'í•œí™”ìƒëª…',
        'INS-KYOBO': 'êµë³´ìƒëª…',
        // ìƒí’ˆ ë§¤í•‘
        'PRD-LIFE-WHOLE': 'ì¢…ì‹ ë³´í—˜',
        'PRD-CHILD': 'ì–´ë¦°ì´ë³´í—˜',
        // í‹°ì–´ ë§¤í•‘
        'HOT': 'ğŸ”¥ HOT (ìˆ˜ì‹œë³€ê²½)',
        'WARM': 'ğŸŒ¡ï¸ WARM (ë¶„ê¸°ë³€ê²½)',
        'COLD': 'â„ï¸ COLD (ì—°ê°„ê³ ì •)'
    };

    function translate(key) {
        return labelMap[key] || key;
    }

    async function start() {
        const res = await fetch('../data/knowledge-graph-ontology.json');
        const json = await res.json();
        rawData = json.graph_data;

        // --- ë…¸ë“œ ë³€í™˜ (Level ì„¤ì •ì´ í•µì‹¬) ---
        const nodes = rawData.nodes.map(n => {
            let level = 3; // ê¸°ë³¸ê°’ (Document)
            let color = '#95a5a6';
            let label = n.id;
            let type = 'Document';

            if (n.labels.includes('SystemRoot')) {
                level = 0; color = '#2c3e50'; label = 'ì „ì²´ ì§€ì‹ ì²´ê³„'; type = 'Root';
            } else if (n.labels.includes('Carrier')) {
                level = 1; color = '#8e44ad'; label = n.properties.name; type = 'Carrier';
            } else if (n.labels.includes('Product')) {
                level = 2; color = '#007bff'; label = n.properties.name.split(' ')[0]; type = 'Product';
            } else if (n.labels.includes('Document')) {
                // ë¬¸ì„œì¼ ê²½ìš° properties.name(íŒŒì¼ëª…)ì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ IDì—ì„œ ì¶”ì¶œ
                label = n.properties.name || n.id.split('-').pop();
                if (n.labels.includes('HOT')) { color = '#e74c3c'; type = 'HOT'; }
                else if (n.labels.includes('WARM')) { color = '#f1c40f'; type = 'WARM'; }
            }

            return {
                id: n.id,
                label: label,
                level: level,
                color: color,
                shape: 'dot',
                size: (4 - level) * 10,
                font: { color: level === 0 ? '#fff' : '#333', size: 14 },
                raw: n,
                typeName: type
            };
        });

        nodesDS = new vis.DataSet(nodes);
        edgesDS = new vis.DataSet(rawData.edges.map(e => ({
            from: e.source, to: e.target, label: e.relationship,
            arrows: 'to', color: { color: '#bdc3c7', opacity: 0.5 },
            font: { size: 10, align: 'middle' },
            smooth: { type: 'cubicBezier', forceDirection: 'horizontal' }
        })));

        // --- ë„¤íŠ¸ì›Œí¬ ìƒì„± (ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ ì„¤ì •) ---
        const container = document.getElementById('network');
        const options = {
            layout: {
                hierarchical: {
                    enabled: true,
                    direction: 'LR',      // Left to Right
                    sortMethod: 'directed',
                    nodeSpacing: 100,
                    treeSpacing: 200,
                    levelSeparation: 300
                }
            },
            physics: { enabled: false }, // ê³„ì¸µí˜•ì¼ ë•ŒëŠ” ë¬¼ë¦¬ ì—”ì§„ ë„ëŠ” ê²ƒì´ ê¹”ë”í•¨
            interaction: { hover: true, tooltipDelay: 200 }
        };

        network = new vis.Network(container, { nodes: nodesDS, edges: edgesDS }, options);

        network.on("click", (p) => {
            if (p.nodes.length > 0) showDetail(p.nodes[0]);
        });

        document.getElementById('search-input').oninput = (e) => updateList(e.target.value);
        updateList('');
    }

    function updateList(keyword) {
        const container = document.getElementById('list-container');
        container.innerHTML = '';
        const key = keyword.toLowerCase();

        const filtered = nodesDS.get().filter(n => 
            n.label.toLowerCase().includes(key) || n.id.toLowerCase().includes(key)
        );

        filtered.forEach(n => {
            const card = document.createElement('div');
            card.className = 'card';
            const typeLabel = translate(n.typeName);
            card.innerHTML = `
                <div class="card-header">
                    <span style="font-weight:bold; font-size:14px;">${n.label.replace('\n', ' ')}</span>
                    <span class="badge ${getBadgeClass(n.typeName)}">${typeLabel}</span>
                </div>
                <div style="font-size:12px; color:#888;">${n.id}</div>
            `;
            card.onclick = () => {
                network.selectNodes([n.id]);
                showDetail(n.id);
                network.focus(n.id, { scale: 1.2, animation: true });
            };
            container.appendChild(card);
        });
    }

    function showDetail(id) {
        const node = nodesDS.get(id);
        const detailView = document.getElementById('detail-view');
        const title = document.getElementById('detail-title');
        const props = document.getElementById('detail-props');
        const links = document.getElementById('detail-links');

        detailView.classList.add('active');
        title.innerText = node.label.replace('\n', ' ');
        
        let html = '<table class="prop-table">';
        html += `<tr><th>${translate('id')}</th><td>${node.id}</td></tr>`;
        for (const [k, v] of Object.entries(node.raw.properties)) {
            const displayKey = translate(k);
            const displayVal = translate(v);
            const detailDesc = (v !== displayVal) ? ` <small style="color:#999">(${v})</small>` : '';
            html += `<tr><th>${displayKey}</th><td>${displayVal}${detailDesc}</td></tr>`;
        }
        html += '</table>';
        props.innerHTML = html;

        // --- ì—°ê´€ ë…¸ë“œ ë¶„ë¥˜ ë¡œì§ ---
        const connectedEdges = network.getConnectedEdges(id);
        const hierarchy_up = [];   // ìƒìœ„ ê³„ì¸µ (ë³´í—˜ì‚¬, ìƒí’ˆ)
        const hierarchy_down = []; // í•˜ìœ„ ê³„ì¸µ (ìƒí’ˆ, ë¬¸ì„œ)
        const refs_in = [];        // ë‚˜ë¥¼ ì°¸ì¡°í•˜ëŠ” ë¬¸ì„œ (EXPLAINED_BY ë“±)
        const refs_out = [];       // ë‚´ê°€ ì°¸ì¡°í•˜ëŠ” ë¬¸ì„œ
        const peers = [];          // ê²½ìŸ ê´€ê³„

        // ê³„ì¸µ ê´€ê³„ ì •ì˜
        const isHierarchy = (rel) => ['HAS_CARRIER', 'OFFERS_PRODUCT', 'HAS_DOCUMENT'].includes(rel);

        connectedEdges.forEach(eid => {
            const edge = edgesDS.get(eid);
            const isOutbound = (edge.from === id);
            const targetId = isOutbound ? edge.to : edge.from;
            const targetNode = nodesDS.get(targetId);
            const rel = edge.label;
            
            if (rel === 'RELATED_TO') {
                // ë¬¸ì„œ ê°„ ì—°ê²° ê´€ê³„
                if (edge.from === id) refs_out.push({ id: edge.to, label: targetNode.label, rel: 'ì—°ê²°' });
                else refs_in.push({ id: edge.from, label: targetNode.label, rel: 'ì—°ê²°' });
            } else if (isHierarchy(rel)) {
                if (edge.to === id) hierarchy_up.push({ id: edge.from, label: targetNode.label, rel });
                else hierarchy_down.push({ id: edge.to, label: targetNode.label, rel });
            } else {
                // ë¬¸ì„œ ê°„ ì°¸ì¡° ê´€ê³„ (EXPLAINED_BY, TARGETS ë“±)
                if (edge.to === id) refs_in.push({ id: edge.from, label: targetNode.label, rel });
                else refs_out.push({ id: edge.to, label: targetNode.label, rel });
            }
        });

        // --- ë ˆì´ì•„ì›ƒ ë Œë”ë§ ---
        links.innerHTML = '';
        
        const renderSection = (title, items, color, isMain = false) => {
            if (items.length === 0) return '';
            let sectionHtml = `<div style="margin-bottom:15px;">
                <div style="font-size:11px; color:${color}; font-weight:bold; margin-bottom:5px; border-left:3px solid ${color}; padding-left:5px;">${title}</div>
                <div style="display:flex; flex-wrap:wrap; gap:5px;">`;
            
            items.forEach(item => {
                const style = isMain ? `font-weight:bold; border-width:2px;` : '';
                sectionHtml += `<button class="btn-round" style="padding:4px 10px; font-size:11px; border-color:${color}88; ${style}" 
                    onclick="network.selectNodes(['${item.id}']); showDetail('${item.id}'); network.focus('${item.id}', {scale:1.2, animation:true});">
                    <span style="color:#999; font-size:9px;">[${item.rel}]</span> ${item.label.replace('\n', ' ')}
                </button>`;
            });
            
            sectionHtml += `</div></div>`;
            return sectionHtml;
        };

        // 1. êµ¬ì¡°ì  ì†Œì† ê´€ê³„ (ê°€ì¥ ì¤‘ìš”)
        links.innerHTML += renderSection('ğŸ  ì†Œì† ê³„ì¸µ (ìƒìœ„)', hierarchy_up, '#2c3e50', true);
        links.innerHTML += renderSection('ğŸ“‚ í•˜ìœ„ êµ¬ì„± (ì†Œì†)', hierarchy_down, '#2c3e50');

        // 2. ë¬¸ì„œ ê°„ ì°¸ì¡°/ì„¤ëª… ê´€ê³„
        links.innerHTML += renderSection('ğŸ”— ë‚˜ë¥¼ ì°¸ì¡°/ì„¤ëª…í•˜ëŠ” í•­ëª©', refs_in, '#27ae60');
        links.innerHTML += renderSection('ğŸ“– ë‚´ê°€ ì°¸ì¡°/ì„¤ëª…í•˜ëŠ” í•­ëª©', refs_out, '#27ae60');

        // 3. ìˆ˜í‰ ê´€ê³„
        links.innerHTML += renderSection('â—€â–¶ ë™ì¼ ë ˆë²¨ ê²½ìŸ ìƒí’ˆ', peers, '#ffaa00');
    }

    function getBadgeClass(type) {
        if (type === 'Root') return 'bg-root';
        if (type === 'Carrier') return 'bg-carrier';
        if (type === 'Product') return 'bg-product';
        return 'bg-doc';
    }

    start();
</script>

</body>
</html>