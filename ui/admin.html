<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMS Admin v2.1 - ì§€ì‹ê´€ë¦¬ì²´ê³„ ê²€ì¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        #network { width: 100%; height: 100%; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .regulation-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">

<div id="app" class="flex h-full">

    <!-- Toast ì•Œë¦¼ -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
        <div v-for="(toast, idx) in toasts" :key="idx"
            :class="toast.type === 'error' ? 'bg-red-500' : toast.type === 'warning' ? 'bg-yellow-500' : 'bg-green-500'"
            class="toast text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 max-w-sm">
            <span>{{ toast.message }}</span>
            <button @click="removeToast(idx)" class="ml-2 hover:opacity-70">&times;</button>
        </div>
    </div>

    <!-- LEFT SIDEBAR -->
    <aside class="w-80 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-gray-800">KMS Admin</h1>
                    <p class="text-xs text-gray-500">v2.1 - 6-Facet Taxonomy</p>
                </div>
                <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded">í™•ì¥íŒ</span>
            </div>
        </div>

        <!-- Taxonomy Tabs - 2ì¤„ -->
        <div class="flex-1 overflow-y-auto scrollbar-thin p-3">
            <!-- ì²«ì§¸ ì¤„: ê¸°ë³¸ íƒ­ -->
            <div class="flex gap-1 mb-2">
                <button @click="activeTab = 'carriers'"
                    :class="activeTab === 'carriers' ? 'bg-purple-100 text-purple-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ë³´í—˜ì‚¬</button>
                <button @click="activeTab = 'products'"
                    :class="activeTab === 'products' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ìƒí’ˆ</button>
                <button @click="activeTab = 'docTypes'"
                    :class="activeTab === 'docTypes' ? 'bg-green-100 text-green-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ë¬¸ì„œìœ í˜•</button>
            </div>
            <!-- ë‘˜ì§¸ ì¤„: v2.1 í™•ì¥ íƒ­ -->
            <div class="flex gap-1 mb-3">
                <button @click="activeTab = 'processes'"
                    :class="activeTab === 'processes' ? 'bg-orange-100 text-orange-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">í”„ë¡œì„¸ìŠ¤</button>
                <button @click="activeTab = 'audiences'"
                    :class="activeTab === 'audiences' ? 'bg-cyan-100 text-cyan-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ì—­í• </button>
                <button @click="activeTab = 'certifications'"
                    :class="activeTab === 'certifications' ? 'bg-pink-100 text-pink-700' : 'text-gray-600 hover:bg-gray-100'"
                    class="flex-1 text-xs py-1.5 rounded-md font-medium transition">ìê²©ì¦</button>
            </div>

            <!-- Carriers -->
            <div v-if="activeTab === 'carriers'" class="space-y-2">
                <!-- í•„í„° -->
                <div class="flex gap-1 mb-2">
                    <button @click="carrierTypeFilter = 'all'"
                        :class="carrierTypeFilter === 'all' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                        class="flex-1 text-xs py-1 rounded">ì „ì²´</button>
                    <button @click="carrierTypeFilter = 'life'"
                        :class="carrierTypeFilter === 'life' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                        class="flex-1 text-xs py-1 rounded">ìƒë³´</button>
                    <button @click="carrierTypeFilter = 'non-life'"
                        :class="carrierTypeFilter === 'non-life' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                        class="flex-1 text-xs py-1 rounded">ì†ë³´</button>
                </div>
                <div v-for="(carrier, id) in filteredCarriers" :key="id"
                    @click="selectTaxonomy('carrier', id)"
                    :class="selectedTaxonomy.type === 'carrier' && selectedTaxonomy.id === id ? 'ring-2 ring-purple-400' : ''"
                    class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">{{ carrier.name }}</span>
                        <div class="flex items-center gap-1">
                            <span v-if="carrier.type" class="text-xs px-1.5 py-0.5 rounded"
                                :class="carrier.type === 'life' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'">
                                {{ carrier.type === 'life' ? 'ìƒ' : 'ì†' }}
                            </span>
                            <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded">{{ getDocCountByCarrier(id) }}ê±´</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">{{ carrier.alias?.join(', ') || '-' }}</div>
                </div>
                <button @click="showAddModal('carrier')"
                    class="w-full p-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm hover:border-purple-400 hover:text-purple-600 transition">
                    + ë³´í—˜ì‚¬ ì¶”ê°€
                </button>
            </div>

            <!-- Products -->
            <div v-if="activeTab === 'products'" class="space-y-2">
                <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
                <select v-model="productCategoryFilter" class="w-full px-2 py-1 text-xs border rounded mb-2">
                    <option value="all">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                    <option v-for="(cat, key) in store.taxonomy.productCategories" :key="key" :value="key">{{ cat.name }}</option>
                </select>
                <div v-for="(product, id) in filteredProducts" :key="id"
                    @click="selectTaxonomy('product', id)"
                    :class="selectedTaxonomy.type === 'product' && selectedTaxonomy.id === id ? 'ring-2 ring-blue-400' : ''"
                    class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">{{ product.name }}</span>
                        <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">{{ product.category }}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
                    <div v-if="product.requires_license" class="text-xs text-orange-600 mt-1">
                        ğŸ”’ {{ product.requires_license }} ìê²© í•„ìš”
                    </div>
                </div>
                <button @click="showAddModal('product')"
                    class="w-full p-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm hover:border-blue-400 hover:text-blue-600 transition">
                    + ìƒí’ˆ ì¶”ê°€
                </button>
            </div>

            <!-- DocTypes -->
            <div v-if="activeTab === 'docTypes'" class="space-y-2">
                <!-- Tier í•„í„° -->
                <div class="flex gap-1 mb-2">
                    <button @click="docTypeTierFilter = 'all'"
                        :class="docTypeTierFilter === 'all' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                        class="flex-1 text-xs py-1 rounded">ì „ì²´</button>
                    <button @click="docTypeTierFilter = 'HOT'"
                        :class="docTypeTierFilter === 'HOT' ? 'bg-red-200 text-red-700' : 'hover:bg-gray-100'"
                        class="flex-1 text-xs py-1 rounded">ğŸ”¥HOT</button>
                    <button @click="docTypeTierFilter = 'WARM'"
                        :class="docTypeTierFilter === 'WARM' ? 'bg-yellow-200 text-yellow-700' : 'hover:bg-gray-100'"
                        class="flex-1 text-xs py-1 rounded">ğŸŒ¡ï¸WARM</button>
                    <button @click="docTypeTierFilter = 'COLD'"
                        :class="docTypeTierFilter === 'COLD' ? 'bg-gray-300 text-gray-700' : 'hover:bg-gray-100'"
                        class="flex-1 text-xs py-1 rounded">â„ï¸COLD</button>
                </div>
                <div v-for="(docType, id) in filteredDocTypes" :key="id"
                    class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">{{ docType.name }}</span>
                        <div class="flex items-center gap-1">
                            <span v-if="docType.source" class="text-xs px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded">{{ docType.source }}</span>
                            <span :class="getTierClass(docType.tier)" class="text-xs px-2 py-0.5 rounded">{{ docType.tier }}</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
                    <div v-if="docType.description" class="text-xs text-gray-400 mt-1">{{ docType.description }}</div>
                </div>
            </div>

            <!-- Processes (v2.1 ì‹ ê·œ) -->
            <div v-if="activeTab === 'processes'" class="space-y-2">
                <div class="text-xs text-gray-500 mb-2 p-2 bg-orange-50 rounded">
                    ğŸ“‹ ì˜ì—… í”„ë¡œì„¸ìŠ¤ ë‹¨ê³„ë³„ ë¬¸ì„œ ë¶„ë¥˜
                </div>
                <div v-for="(process, id) in sortedProcesses" :key="id"
                    @click="selectTaxonomy('process', id)"
                    :class="selectedTaxonomy.type === 'process' && selectedTaxonomy.id === id ? 'ring-2 ring-orange-400' : ''"
                    class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-orange-50 transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 flex items-center justify-center bg-orange-100 text-orange-700 rounded-full text-xs font-bold">
                                {{ process.order }}
                            </span>
                            <span class="font-medium text-sm">{{ process.name }}</span>
                        </div>
                        <span class="text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded">{{ getDocCountByProcess(id) }}ê±´</span>
                    </div>
                    <div v-if="process.description" class="text-xs text-gray-500 mt-2 ml-8">{{ process.description }}</div>
                </div>
            </div>

            <!-- Audiences (v2.1 ì‹ ê·œ) -->
            <div v-if="activeTab === 'audiences'" class="space-y-2">
                <div class="text-xs text-gray-500 mb-2 p-2 bg-cyan-50 rounded">
                    ğŸ‘¥ ëŒ€ìƒ ì—­í• ë³„ ë¬¸ì„œ ë¶„ë¥˜
                </div>
                <div v-for="(audience, id) in sortedAudiences" :key="id"
                    @click="selectTaxonomy('audience', id)"
                    :class="selectedTaxonomy.type === 'audience' && selectedTaxonomy.id === id ? 'ring-2 ring-cyan-400' : ''"
                    class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-cyan-50 transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 flex items-center justify-center bg-cyan-100 text-cyan-700 rounded-full text-xs font-bold">
                                L{{ audience.level }}
                            </span>
                            <span class="font-medium text-sm">{{ audience.name }}</span>
                        </div>
                        <span class="text-xs px-2 py-0.5 bg-cyan-100 text-cyan-700 rounded">{{ getDocCountByAudience(id) }}ê±´</span>
                    </div>
                    <div v-if="audience.description" class="text-xs text-gray-500 mt-2 ml-8">{{ audience.description }}</div>
                </div>
            </div>

            <!-- Certifications (v2.1 ì‹ ê·œ) -->
            <div v-if="activeTab === 'certifications'" class="space-y-2">
                <div class="text-xs text-gray-500 mb-2 p-2 bg-pink-50 rounded">
                    ğŸ“œ ì„¤ê³„ì‚¬ ìê²©ì¦ ê´€ë¦¬
                </div>
                <div v-for="(cert, id) in store.taxonomy.certifications" :key="id"
                    class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-sm">{{ cert.name }}</span>
                        <span v-if="cert.mandatory" class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded">í•„ìˆ˜</span>
                        <span v-else class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded">ì„ íƒ</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
                    <div v-if="cert.hours" class="text-xs text-gray-400 mt-1">êµìœ¡ì‹œê°„: {{ cert.hours }}ì‹œê°„</div>
                    <div v-if="cert.description" class="text-xs text-gray-400">{{ cert.description }}</div>
                    <div v-if="cert.products" class="flex flex-wrap gap-1 mt-2">
                        <span v-for="prd in cert.products" :key="prd" class="text-xs px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded">
                            {{ getProductName(prd) }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="p-3 border-t border-gray-100">
            <label class="block w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
                <span class="text-sm text-gray-600">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ (ìë™ ë¶„ë¥˜)</span>
                <input type="file" accept=".md,.pdf,.hwp,.docx" @change="handleFileUpload" class="hidden">
            </label>
        </div>

        <!-- Data Actions -->
        <div class="p-3 border-t border-gray-100 flex gap-2">
            <button @click="exportData" class="flex-1 py-2 px-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-medium transition">
                ë‚´ë³´ë‚´ê¸°
            </button>
            <label class="flex-1 py-2 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-medium text-center cursor-pointer transition">
                ê°€ì ¸ì˜¤ê¸°
                <input type="file" accept=".json" @change="importData" class="hidden">
            </label>
        </div>
    </aside>

    <!-- CENTER AREA -->
    <main class="flex-1 flex flex-col">
        <!-- Toolbar -->
        <div class="h-12 bg-white border-b border-gray-200 flex items-center px-4 gap-4">
            <div class="flex items-center gap-2">
                <button @click="viewMode = 'graph'"
                    :class="viewMode === 'graph' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                    class="p-2 rounded-lg transition" title="ê·¸ë˜í”„ ë·°">ğŸ“Š</button>
                <button @click="viewMode = 'list'"
                    :class="viewMode === 'list' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                    class="p-2 rounded-lg transition" title="ëª©ë¡ ë·°">ğŸ“‹</button>
                <button @click="viewMode = 'validation'"
                    :class="viewMode === 'validation' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                    class="p-2 rounded-lg transition" title="ê²€ì¦ ë·°">âœ…</button>
                <button @click="viewMode = 'timeline'"
                    :class="viewMode === 'timeline' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                    class="p-2 rounded-lg transition" title="ê·œì œ íƒ€ì„ë¼ì¸">ğŸ“…</button>
            </div>
            <div class="h-6 w-px bg-gray-200"></div>
            <input type="text" v-model="searchQuery" placeholder="ë¬¸ì„œ ê²€ìƒ‰..."
                class="flex-1 px-3 py-1.5 bg-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
            <!-- í•„í„° ë“œë¡­ë‹¤ìš´ -->
            <select v-model="filterProcess" class="px-2 py-1.5 text-xs border rounded-lg">
                <option value="">í”„ë¡œì„¸ìŠ¤ ì „ì²´</option>
                <option v-for="(p, id) in store.taxonomy.processes" :key="id" :value="id">{{ p.name }}</option>
            </select>
            <select v-model="filterAudience" class="px-2 py-1.5 text-xs border rounded-lg">
                <option value="">ì—­í•  ì „ì²´</option>
                <option v-for="(a, id) in store.taxonomy.audiences" :key="id" :value="id">{{ a.name }}</option>
            </select>
            <button @click="showAddDocModal" class="px-4 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition">
                + ë¬¸ì„œ ìƒì„±
            </button>
        </div>

        <!-- Regulation Alert Bar (ë‹¤ê°€ì˜¤ëŠ” ê·œì œ) -->
        <div v-if="upcomingRegulation" class="bg-gradient-to-r from-red-500 to-orange-500 text-white px-4 py-2 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="regulation-badge px-2 py-1 bg-white/20 rounded text-xs font-bold">âš ï¸ ê·œì œ ì˜ˆê³ </span>
                <span class="font-medium">{{ upcomingRegulation.name }}</span>
                <span class="text-sm opacity-90">{{ upcomingRegulation.date }}</span>
            </div>
            <span class="text-sm">D-{{ getDaysUntil(upcomingRegulation.date) }}</span>
        </div>

        <!-- Graph View -->
        <div v-show="viewMode === 'graph'" class="flex-1 relative">
            <div id="network" class="w-full h-full bg-gray-50"></div>
            <div class="absolute top-4 left-4 bg-white/90 backdrop-blur rounded-lg p-3 shadow-lg text-xs">
                <div class="font-bold mb-2">ë²”ë¡€</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-purple-500"></span> ë³´í—˜ì‚¬</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span> ìƒí’ˆ</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> HOT</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-yellow-500"></span> WARM</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-gray-400"></span> COLD</div>
            </div>
            <div class="absolute bottom-4 right-4 flex gap-2">
                <button @click="fitGraph" class="px-4 py-2 bg-white shadow-lg rounded-lg text-sm hover:bg-gray-50 transition">
                    ì „ì²´ ë³´ê¸°
                </button>
                <button v-if="selectedDocId" @click="highlightRelatedDocs" class="px-4 py-2 bg-blue-500 text-white shadow-lg rounded-lg text-sm hover:bg-blue-600 transition">
                    ì—°ê´€ ë¬¸ì„œ ì „íŒŒ
                </button>
            </div>
        </div>

        <!-- List View -->
        <div v-show="viewMode === 'list'" class="flex-1 overflow-auto p-4">
            <table class="w-full bg-white rounded-lg shadow-sm overflow-hidden">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë¬¸ì„œëª…</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë³´í—˜ì‚¬</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒí’ˆ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìœ í˜•</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">í”„ë¡œì„¸ìŠ¤</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ëŒ€ìƒ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tier</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="(doc, id) in filteredDocuments" :key="id"
                        @click="selectDocument(id)"
                        :class="[selectedDocId === id ? 'bg-blue-50' : '', highlightedDocs.includes(id) ? 'ring-2 ring-blue-400' : '']"
                        class="cursor-pointer hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm font-medium text-gray-800">{{ doc.name }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getCarrierName(doc.carrier) }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getProductName(doc.product) }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getDocTypeName(doc.docType) }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getProcessName(doc.process) }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ getAudienceName(doc.audience) }}</td>
                        <td class="px-4 py-3">
                            <span :class="getTierClass(doc.tier)" class="text-xs px-2 py-0.5 rounded">{{ doc.tier }}</span>
                        </td>
                        <td class="px-4 py-3">
                            <button @click.stop="deleteDocument(id)" class="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Validation View -->
        <div v-show="viewMode === 'validation'" class="flex-1 overflow-auto p-4">
            <div class="grid grid-cols-2 gap-4">
                <!-- ìœ ë‹ˆí¬ ê²€ì¦ -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ğŸ”‘ ìœ ë‹ˆí¬ ê²€ì¦
                    </h3>
                    <div v-if="duplicateGroups.length === 0" class="text-green-600 text-sm flex items-center gap-2">
                        âœ… ëª¨ë“  ë¬¸ì„œê°€ ìœ ë‹ˆí¬í•©ë‹ˆë‹¤
                    </div>
                    <div v-else class="space-y-2">
                        <div v-for="group in duplicateGroups" :key="group.key" class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-sm font-medium text-red-700">{{ group.key }}</div>
                            <div class="text-xs text-red-600 mt-1">{{ group.docs.length }}ê°œ ì¤‘ë³µ</div>
                        </div>
                    </div>
                </div>

                <!-- ì „íŒŒ ê²€ì¦ -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ğŸ”— ì „íŒŒ ê²€ì¦
                    </h3>
                    <div class="text-sm text-gray-600 mb-3">ë¬¸ì„œë¥¼ ì„ íƒí•˜ê³  "ì—°ê´€ ë¬¸ì„œ ì „íŒŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    <div v-if="selectedDocId" class="space-y-2">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="font-medium text-sm">{{ selectedDoc?.name }}</div>
                            <div class="text-xs text-gray-500 mt-2">ì—°ê´€ ë¬¸ì„œ ({{ getRelatedDocIds(selectedDocId).length }}ê°œ):</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                <span v-for="relId in getRelatedDocIds(selectedDocId)" :key="relId"
                                    class="text-xs px-2 py-1 bg-white rounded border">
                                    {{ getDocName(relId) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í†µê³„ (í™•ì¥) -->
                <div class="bg-white rounded-lg shadow-sm p-4 col-span-2">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        ğŸ“Š í†µê³„
                    </h3>
                    <div class="grid grid-cols-6 gap-3 text-sm">
                        <div class="p-3 bg-purple-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">{{ Object.keys(store.taxonomy.carriers).length - 1 }}</div>
                            <div class="text-xs text-gray-500">ë³´í—˜ì‚¬</div>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">{{ Object.keys(store.taxonomy.products).length - 1 }}</div>
                            <div class="text-xs text-gray-500">ìƒí’ˆ</div>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">{{ Object.keys(store.taxonomy.docTypes).length }}</div>
                            <div class="text-xs text-gray-500">ë¬¸ì„œìœ í˜•</div>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600">{{ Object.keys(store.taxonomy.processes).length - 1 }}</div>
                            <div class="text-xs text-gray-500">í”„ë¡œì„¸ìŠ¤</div>
                        </div>
                        <div class="p-3 bg-cyan-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-cyan-600">{{ Object.keys(store.taxonomy.audiences).length - 1 }}</div>
                            <div class="text-xs text-gray-500">ì—­í• </div>
                        </div>
                        <div class="p-3 bg-indigo-50 rounded-lg text-center">
                            <div class="text-2xl font-bold text-indigo-600">{{ Object.keys(store.documents).length }}</div>
                            <div class="text-xs text-gray-500">ë¬¸ì„œ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline View (v2.1 ì‹ ê·œ) -->
        <div v-show="viewMode === 'timeline'" class="flex-1 overflow-auto p-4">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ“… ê·œì œ íƒ€ì„ë¼ì¸</h2>
                <div class="relative">
                    <!-- íƒ€ì„ë¼ì¸ ì„  -->
                    <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                    
                    <div v-for="(reg, idx) in store.taxonomy.regulationTimeline" :key="idx" class="relative pl-20 pb-8">
                        <!-- ë…¸ë“œ -->
                        <div class="absolute left-6 w-5 h-5 rounded-full border-4"
                            :class="getRegulationStatusClass(reg.status)"></div>
                        
                        <!-- ì¹´ë“œ -->
                        <div class="bg-white rounded-lg shadow-sm p-4 border-l-4"
                            :class="getRegulationBorderClass(reg.impact)">
                            <div class="flex items-start justify-between">
                                <div>
                                    <span class="text-sm text-gray-500">{{ reg.date }}</span>
                                    <h3 class="font-bold text-gray-800 mt-1">{{ reg.name }}</h3>
                                    <p class="text-sm text-gray-600 mt-2">{{ reg.description }}</p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <span class="text-xs px-2 py-1 rounded"
                                        :class="reg.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'">
                                        {{ reg.status === 'active' ? 'ì‹œí–‰ì¤‘' : 'ì˜ˆì •' }}
                                    </span>
                                    <span v-if="reg.impact" class="text-xs px-2 py-1 rounded"
                                        :class="reg.impact === 'critical' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700'">
                                        {{ reg.impact === 'critical' ? 'âš ï¸ ë§¤ìš°ì¤‘ìš”' : 'ì¤‘ìš”' }}
                                    </span>
                                    <span v-if="reg.status === 'upcoming'" class="text-xs text-gray-500">
                                        D-{{ getDaysUntil(reg.date) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="h-8 bg-gray-100 border-t border-gray-200 flex items-center px-4 text-xs text-gray-600">
            <span>ë¬¸ì„œ: {{ Object.keys(store.documents).length }}ê°œ</span>
            <span class="mx-2">|</span>
            <span :class="duplicateGroups.length > 0 ? 'text-red-600 font-medium' : 'text-green-600'">
                ì¤‘ë³µ: {{ duplicateGroups.length }}ê±´
            </span>
            <span class="mx-2">|</span>
            <span v-if="highlightedDocs.length > 0" class="text-blue-600">
                ì „íŒŒëœ ë¬¸ì„œ: {{ highlightedDocs.length }}ê°œ
            </span>
            <span class="ml-auto text-gray-400">v{{ store.version }} | {{ formatDate(store.lastModified) }}</span>
        </div>
    </main>

    <!-- RIGHT PANEL -->
    <aside v-show="selectedDocId || selectedTaxonomy.type" class="w-80 bg-white border-l border-gray-200 flex flex-col">
        
        <!-- Process Detail -->
        <div v-if="selectedTaxonomy.type === 'process'" class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-bold text-gray-800">í”„ë¡œì„¸ìŠ¤ ìƒì„¸</h2>
                <button @click="selectedTaxonomy.type = null; selectedTaxonomy.id = null" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div v-if="store.taxonomy.processes[selectedTaxonomy.id]" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">ID</label>
                    <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">í”„ë¡œì„¸ìŠ¤ëª…</label>
                    <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">{{ store.taxonomy.processes[selectedTaxonomy.id].name }}</div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ìˆœì„œ</label>
                    <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">{{ store.taxonomy.processes[selectedTaxonomy.id].order }}</div>
                </div>
                <div v-if="store.taxonomy.processes[selectedTaxonomy.id].description">
                    <label class="text-xs font-medium text-gray-500">ì„¤ëª…</label>
                    <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded mt-1">{{ store.taxonomy.processes[selectedTaxonomy.id].description }}</div>
                </div>
                <div class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">ê´€ë ¨ ë¬¸ì„œ ({{ getDocCountByProcess(selectedTaxonomy.id) }}ê±´)</label>
                    <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                        <div v-for="(doc, docId) in getDocsByProcess(selectedTaxonomy.id)" :key="docId"
                            @click="selectDocument(docId)"
                            class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-orange-50 transition text-sm">
                            {{ doc.name }}
                        </div>
                        <div v-if="getDocCountByProcess(selectedTaxonomy.id) === 0" class="text-sm text-gray-400 py-2">
                            ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audience Detail -->
        <div v-else-if="selectedTaxonomy.type === 'audience'" class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-bold text-gray-800">ì—­í•  ìƒì„¸</h2>
                <button @click="selectedTaxonomy.type = null; selectedTaxonomy.id = null" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div v-if="store.taxonomy.audiences[selectedTaxonomy.id]" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">ID</label>
                    <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ì—­í• ëª…</label>
                    <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">{{ store.taxonomy.audiences[selectedTaxonomy.id].name }}</div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ë ˆë²¨</label>
                    <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">{{ store.taxonomy.audiences[selectedTaxonomy.id].level }}</div>
                </div>
                <div class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">ê´€ë ¨ ë¬¸ì„œ ({{ getDocCountByAudience(selectedTaxonomy.id) }}ê±´)</label>
                    <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                        <div v-for="(doc, docId) in getDocsByAudience(selectedTaxonomy.id)" :key="docId"
                            @click="selectDocument(docId)"
                            class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-cyan-50 transition text-sm">
                            {{ doc.name }}
                        </div>
                        <div v-if="getDocCountByAudience(selectedTaxonomy.id) === 0" class="text-sm text-gray-400 py-2">
                            ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carrier Detail -->
        <div v-else-if="selectedTaxonomy.type === 'carrier'" class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-bold text-gray-800">ë³´í—˜ì‚¬ ìƒì„¸</h2>
                <button @click="selectedTaxonomy.type = null; selectedTaxonomy.id = null" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div v-if="store.taxonomy.carriers[selectedTaxonomy.id]" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">ID</label>
                    <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬ëª…</label>
                    <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">{{ store.taxonomy.carriers[selectedTaxonomy.id].name }}</div>
                </div>
                <div v-if="store.taxonomy.carriers[selectedTaxonomy.id].type">
                    <label class="text-xs font-medium text-gray-500">êµ¬ë¶„</label>
                    <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">
                        {{ store.taxonomy.carriers[selectedTaxonomy.id].type === 'life' ? 'ìƒëª…ë³´í—˜' : 'ì†í•´ë³´í—˜' }}
                    </div>
                </div>
                <div class="border-t border-gray-100 pt-4">
                    <label class="text-xs font-medium text-gray-500">í†µê³„</label>
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div class="p-2 bg-purple-50 rounded text-center">
                            <div class="text-lg font-bold text-purple-600">{{ getDocCountByCarrier(selectedTaxonomy.id) }}</div>
                            <div class="text-xs text-gray-500">ë¬¸ì„œ</div>
                        </div>
                        <div class="p-2 bg-red-50 rounded text-center">
                            <div class="text-lg font-bold text-red-600">{{ getDocCountByCarrierTier(selectedTaxonomy.id, 'HOT') }}</div>
                            <div class="text-xs text-gray-500">HOT</div>
                        </div>
                        <div class="p-2 bg-yellow-50 rounded text-center">
                            <div class="text-lg font-bold text-yellow-600">{{ getDocCountByCarrierTier(selectedTaxonomy.id, 'WARM') }}</div>
                            <div class="text-xs text-gray-500">WARM</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Detail -->
        <div v-else-if="selectedDocId" class="flex-1 overflow-y-auto scrollbar-thin">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h2 class="font-bold text-gray-800">ë¬¸ì„œ ìƒì„¸</h2>
                <button @click="selectedDocId = null; highlightedDocs = []" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>

            <div v-if="selectedDoc" class="p-4 space-y-4">
                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œ ID</label>
                    <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1 break-all">{{ selectedDocId }}</div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œëª…</label>
                    <input type="text" v-model="selectedDoc.name" @change="saveStore"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬</label>
                        <select v-model="selectedDoc.carrier" @change="saveStore"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500">ìƒí’ˆ</label>
                        <select v-model="selectedDoc.product" @change="saveStore"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•</label>
                    <select v-model="selectedDoc.docType" @change="saveStore"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
                    </select>
                </div>

                <!-- v2.1 ì‹ ê·œ í•„ë“œ -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium text-gray-500">í”„ë¡œì„¸ìŠ¤</label>
                        <select v-model="selectedDoc.process" @change="saveStore"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">ë¯¸ì§€ì •</option>
                            <option v-for="(p, id) in store.taxonomy.processes" :key="id" :value="id">{{ p.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500">ëŒ€ìƒì—­í• </label>
                        <select v-model="selectedDoc.audience" @change="saveStore"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">ë¯¸ì§€ì •</option>
                            <option v-for="(a, id) in store.taxonomy.audiences" :key="id" :value="id">{{ a.name }}</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-medium text-gray-500">Tier</label>
                    <div :class="getTierClass(selectedDoc.tier)" class="mt-1 px-3 py-2 rounded-lg text-sm text-center font-medium">
                        {{ selectedDoc.tier }}
                    </div>
                </div>

                <!-- Relations -->
                <div class="border-t border-gray-100 pt-4">
                    <h3 class="text-sm font-bold text-gray-700 mb-3">ê´€ê³„ ì„¤ì •</h3>

                    <!-- Siblings -->
                    <div class="mb-3">
                        <label class="text-xs font-medium text-gray-500">í˜•ì œ ë¬¸ì„œ (ì–‘ë°©í–¥)</label>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-for="sibId in selectedDoc.relations?.siblings || []" :key="sibId"
                                @click="selectDocument(sibId)"
                                class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded text-xs cursor-pointer hover:bg-green-200">
                                {{ getDocName(sibId) }}
                                <button @click.stop="removeSiblingRelation(sibId)" class="hover:text-red-500">&times;</button>
                            </span>
                        </div>
                        <select @change="addSiblingRelation($event)"
                            class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">+ í˜•ì œ ì¶”ê°€</option>
                            <option v-for="(doc, id) in availableSiblings" :key="id" :value="id">{{ doc.name }}</option>
                        </select>
                    </div>

                    <!-- References -->
                    <div>
                        <label class="text-xs font-medium text-gray-500">ì°¸ì¡° ë¬¸ì„œ (ë‹¨ë°©í–¥)</label>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-for="refId in selectedDoc.relations?.references || []" :key="refId"
                                @click="selectDocument(refId)"
                                class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs cursor-pointer hover:bg-gray-200">
                                {{ getDocName(refId) }}
                                <button @click.stop="removeReference(refId)" class="hover:text-red-500">&times;</button>
                            </span>
                        </div>
                        <select @change="addReference($event)"
                            class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">+ ì°¸ì¡° ì¶”ê°€</option>
                            <option v-for="(doc, id) in otherDocuments" :key="id" :value="id">{{ doc.name }}</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="p-3 border-t border-gray-100 flex gap-2">
                <button @click="highlightRelatedDocs" class="flex-1 py-2 px-3 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-medium">
                    ì „íŒŒ í™•ì¸
                </button>
                <button @click="deleteDocument(selectedDocId)" class="py-2 px-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-medium">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </aside>

    <!-- Add Taxonomy Modal -->
    <div v-if="modal.show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="modal.show = false">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
            <h3 class="text-lg font-bold mb-4">{{ modal.title }}</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-medium text-gray-500">ID</label>
                    <input type="text" v-model="modal.data.id" :placeholder="modal.type === 'carrier' ? 'ì˜ˆ: INS-KB' : 'ì˜ˆ: PRD-CHILD-NEW'"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ì´ë¦„</label>
                    <input type="text" v-model="modal.data.name" :placeholder="modal.type === 'carrier' ? 'ì˜ˆ: KBì†í•´ë³´í—˜' : 'ì˜ˆ: ë“ ë“  ì–´ë¦°ì´ë³´í—˜ ë¦¬ë‰´ì–¼'"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <div v-if="modal.type === 'carrier'">
                    <label class="text-xs font-medium text-gray-500">êµ¬ë¶„</label>
                    <select v-model="modal.data.insurerType" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="life">ìƒëª…ë³´í—˜</option>
                        <option value="non-life">ì†í•´ë³´í—˜</option>
                    </select>
                </div>
                <div v-if="modal.type === 'product'">
                    <label class="text-xs font-medium text-gray-500">ì¹´í…Œê³ ë¦¬</label>
                    <select v-model="modal.data.category" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option v-for="(cat, key) in store.taxonomy.productCategories" :key="key" :value="key">{{ cat.name }}</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="modal.show = false" class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">ì·¨ì†Œ</button>
                <button @click="addTaxonomy" class="flex-1 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- Add Document Modal -->
    <div v-if="docModal.show" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="docModal.show = false">
        <div class="bg-white rounded-xl shadow-2xl w-[500px] p-6">
            <h3 class="text-lg font-bold mb-4">ìƒˆ ë¬¸ì„œ ìƒì„±</h3>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬</label>
                        <select v-model="docModal.data.carrier" @change="checkDocModalDuplicate"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">ì„ íƒ</option>
                            <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500">ìƒí’ˆ</label>
                        <select v-model="docModal.data.product" @change="checkDocModalDuplicate"
                            class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">ì„ íƒ</option>
                            <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•</label>
                    <select v-model="docModal.data.docType" @change="checkDocModalDuplicate"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        <option value="">ì„ íƒ</option>
                        <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium text-gray-500">í”„ë¡œì„¸ìŠ¤</label>
                        <select v-model="docModal.data.process" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">ë¯¸ì§€ì •</option>
                            <option v-for="(p, id) in store.taxonomy.processes" :key="id" :value="id">{{ p.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500">ëŒ€ìƒì—­í• </label>
                        <select v-model="docModal.data.audience" class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <option value="">ë¯¸ì§€ì •</option>
                            <option v-for="(a, id) in store.taxonomy.audiences" :key="id" :value="id">{{ a.name }}</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-500">ë¬¸ì„œëª… (ì„ íƒ)</label>
                    <input type="text" v-model="docModal.data.name" placeholder="ìë™ ìƒì„±ë¨"
                        class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>

                <!-- ì¤‘ë³µ ê²½ê³  -->
                <div v-if="docModal.duplicateWarning" class="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div class="text-sm font-medium text-red-700">âš ï¸ ì¤‘ë³µ ë¬¸ì„œ ì¡´ì¬!</div>
                    <div class="text-xs text-red-600 mt-1">{{ docModal.duplicateWarning }}</div>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="docModal.show = false" class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium">ì·¨ì†Œ</button>
                <button @click="createDocument" :disabled="docModal.duplicateWarning"
                    :class="docModal.duplicateWarning ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'"
                    class="flex-1 py-2 text-white rounded-lg text-sm font-medium">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

// ê¸°ë³¸ ë°ì´í„° êµ¬ì¡° v2.1
const DEFAULT_DATA = {
    version: "2.1",
    lastModified: new Date().toISOString(),
    taxonomy: {
        carriers: {
            "INS-COMMON": { name: "ê³µí†µ", alias: ["ì „ì²´", "ALL"], type: "common", tier: "common" }
        },
        products: {
            "PRD-COMMON": { name: "ê³µí†µ", category: "COMMON", alias: ["ì „ì²´", "ALL"] }
        },
        productCategories: {
            "LIFE": { name: "ìƒëª…ë³´í—˜", order: 1 },
            "HEALTH": { name: "ê±´ê°•/ì œ3ë³´í—˜", order: 2 },
            "NON-LIFE": { name: "ì†í•´ë³´í—˜", order: 3 },
            "ANNUITY": { name: "ì—°ê¸ˆ/ì €ì¶•", order: 4 },
            "COMMON": { name: "ê³µí†µ", order: 99 }
        },
        docTypes: {},
        processes: {
            "BIZ-COMMON": { name: "ê³µí†µ", order: 99 }
        },
        audiences: {
            "AUD-ALL": { name: "ì „ì²´", level: 0 }
        },
        certifications: {},
        regulationTimeline: [],
        defaultRelations: {}
    },
    documents: {}
};

// v2.1 JSON ë§ˆì´ê·¸ë ˆì´ì…˜
function migrateFromTaxonomyV21(taxData) {
    const data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    
    if (taxData.carriers) data.taxonomy.carriers = { ...data.taxonomy.carriers, ...taxData.carriers };
    if (taxData.products) data.taxonomy.products = { ...data.taxonomy.products, ...taxData.products };
    if (taxData.product_categories) data.taxonomy.productCategories = taxData.product_categories;
    if (taxData.doc_types) data.taxonomy.docTypes = taxData.doc_types;
    if (taxData.processes) data.taxonomy.processes = { ...data.taxonomy.processes, ...taxData.processes };
    if (taxData.audiences) data.taxonomy.audiences = { ...data.taxonomy.audiences, ...taxData.audiences };
    if (taxData.certifications) data.taxonomy.certifications = taxData.certifications;
    if (taxData.regulation_timeline) data.taxonomy.regulationTimeline = taxData.regulation_timeline;
    if (taxData.default_relations) data.taxonomy.defaultRelations = taxData.default_relations;
    
    return data;
}

// knowledge-graph.json ë§ˆì´ê·¸ë ˆì´ì…˜
function migrateFromKnowledgeGraphV21(graphData) {
    const data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    const nodes = graphData.graph_data?.nodes || [];
    const edges = graphData.graph_data?.edges || [];

    // taxonomy ë³‘í•©
    if (graphData.taxonomy) {
        Object.assign(data.taxonomy, migrateFromTaxonomyV21(graphData.taxonomy).taxonomy);
    }

    // ê´€ê³„ ë§µ êµ¬ì„±
    const relatedTo = {};
    const references = {};
    edges.forEach(e => {
        if (e.relationship === 'SIBLINGS' || e.relationship === 'RELATED_TO') {
            if (!relatedTo[e.source]) relatedTo[e.source] = [];
            relatedTo[e.source].push(e.target);
        }
        if (e.relationship === 'REFERENCES') {
            if (!references[e.source]) references[e.source] = [];
            references[e.source].push(e.target);
        }
    });

    // ë¬¸ì„œ ë…¸ë“œ ì²˜ë¦¬
    nodes.forEach(n => {
        if (!n.labels.includes('Document')) return;
        const props = n.properties;
        const docType = n.labels.find(l => l.startsWith('DOC-'));
        const tier = n.labels.find(l => ['HOT', 'WARM', 'COLD'].includes(l)) || 'COLD';

        data.documents[n.id] = {
            id: n.id,
            name: props.name,
            carrier: props.carrier,
            product: props.product,
            docType: docType,
            tier: tier,
            process: props.process || '',
            audience: props.audience || '',
            status: "ACTIVE",
            version: "1.0",
            content: "",
            relations: { 
                parent: null, 
                children: [], 
                siblings: relatedTo[n.id] || [], 
                references: references[n.id] || [] 
            },
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
    });

    return data;
}

createApp({
    setup() {
        let network = null;

        const store = reactive(JSON.parse(JSON.stringify(DEFAULT_DATA)));
        const activeTab = ref('carriers');
        const viewMode = ref('graph');
        const searchQuery = ref('');
        const selectedDocId = ref(null);
        const selectedTaxonomy = reactive({ type: null, id: null });
        const modal = reactive({ show: false, type: '', title: '', data: {} });
        const docModal = reactive({ show: false, data: {}, duplicateWarning: null });
        const uploadPreview = reactive({ show: false, filename: '', data: {}, confidence: {} });
        const highlightedDocs = ref([]);
        const toasts = ref([]);

        // v2.1 í•„í„°
        const carrierTypeFilter = ref('all');
        const productCategoryFilter = ref('all');
        const docTypeTierFilter = ref('all');
        const filterProcess = ref('');
        const filterAudience = ref('');

        const selectedDoc = computed(() => selectedDocId.value ? store.documents[selectedDocId.value] : null);

        // í•„í„°ëœ ë³´í—˜ì‚¬
        const filteredCarriers = computed(() => {
            const result = {};
            Object.entries(store.taxonomy.carriers).forEach(([id, carrier]) => {
                if (id === 'INS-COMMON') return;
                if (carrierTypeFilter.value === 'all' || carrier.type === carrierTypeFilter.value) {
                    result[id] = carrier;
                }
            });
            return result;
        });

        // í•„í„°ëœ ìƒí’ˆ
        const filteredProducts = computed(() => {
            const result = {};
            Object.entries(store.taxonomy.products).forEach(([id, product]) => {
                if (id === 'PRD-COMMON') return;
                if (productCategoryFilter.value === 'all' || product.category === productCategoryFilter.value) {
                    result[id] = product;
                }
            });
            return result;
        });

        // í•„í„°ëœ ë¬¸ì„œìœ í˜•
        const filteredDocTypes = computed(() => {
            const result = {};
            Object.entries(store.taxonomy.docTypes).forEach(([id, docType]) => {
                if (docTypeTierFilter.value === 'all' || docType.tier === docTypeTierFilter.value) {
                    result[id] = docType;
                }
            });
            return result;
        });

        // ì •ë ¬ëœ í”„ë¡œì„¸ìŠ¤
        const sortedProcesses = computed(() => {
            const entries = Object.entries(store.taxonomy.processes)
                .filter(([id]) => id !== 'BIZ-COMMON')
                .sort((a, b) => (a[1].order || 99) - (b[1].order || 99));
            return Object.fromEntries(entries);
        });

        // ì •ë ¬ëœ ì—­í• 
        const sortedAudiences = computed(() => {
            const entries = Object.entries(store.taxonomy.audiences)
                .filter(([id]) => id !== 'AUD-ALL')
                .sort((a, b) => (a[1].level || 0) - (b[1].level || 0));
            return Object.fromEntries(entries);
        });

        // í•„í„°ëœ ë¬¸ì„œ
        const filteredDocuments = computed(() => {
            const q = searchQuery.value.toLowerCase();
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (q && !doc.name.toLowerCase().includes(q) && !id.toLowerCase().includes(q)) return;
                if (filterProcess.value && doc.process !== filterProcess.value) return;
                if (filterAudience.value && doc.audience !== filterAudience.value) return;
                docs[id] = doc;
            });
            return docs;
        });

        const otherDocuments = computed(() => {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (id !== selectedDocId.value) docs[id] = doc;
            });
            return docs;
        });

        const availableSiblings = computed(() => {
            if (!selectedDoc.value) return {};
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (id !== selectedDocId.value && !(selectedDoc.value.relations?.siblings || []).includes(id)) {
                    docs[id] = doc;
                }
            });
            return docs;
        });

        const duplicateGroups = computed(() => {
            const groups = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                const key = `${doc.carrier}|${doc.product}|${doc.docType}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push({ id, name: doc.name });
            });
            return Object.entries(groups)
                .filter(([_, docs]) => docs.length > 1)
                .map(([key, docs]) => {
                    const [carrier, product, docType] = key.split('|');
                    return {
                        key: `${getCarrierName(carrier)} > ${getProductName(product)} > ${getDocTypeName(docType)}`,
                        docs
                    };
                });
        });

        // ë‹¤ê°€ì˜¤ëŠ” ê·œì œ
        const upcomingRegulation = computed(() => {
            const upcoming = store.taxonomy.regulationTimeline
                .filter(r => r.status === 'upcoming')
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            return upcoming[0] || null;
        });

        // ì´ˆê¸°í™”
        onMounted(() => {
            loadStore();
            nextTick(() => {
                initGraph();
            });
        });

        function loadStore() {
            const saved = localStorage.getItem('kms_data_v2');
            if (saved) {
                Object.assign(store, JSON.parse(saved));
            } else {
                // data/taxonomy.json ë˜ëŠ” data/knowledge-graph.json ë¡œë“œ ì‹œë„
                Promise.all([
                    fetch('../data/taxonomy.json').then(r => r.ok ? r.json() : null).catch(() => null),
                    fetch('../data/knowledge-graph.json').then(r => r.ok ? r.json() : null).catch(() => null)
                ]).then(([taxData, graphData]) => {
                    if (graphData) {
                        Object.assign(store, migrateFromKnowledgeGraphV21(graphData));
                    } else if (taxData) {
                        Object.assign(store, migrateFromTaxonomyV21(taxData));
                    }
                    saveStore();
                    rebuildGraph();
                });
            }
        }

        function saveStore() {
            store.lastModified = new Date().toISOString();
            localStorage.setItem('kms_data_v2', JSON.stringify(store));
            rebuildGraph();
        }

        function showToast(message, type = 'success') {
            toasts.value.push({ message, type });
            setTimeout(() => toasts.value.shift(), 3000);
        }

        function removeToast(idx) {
            toasts.value.splice(idx, 1);
        }

        function initGraph() {
            const container = document.getElementById('network');
            if (!container) return;

            const options = {
                layout: {
                    hierarchical: { enabled: true, direction: 'LR', sortMethod: 'directed', nodeSpacing: 80, levelSeparation: 200 }
                },
                physics: { enabled: false },
                interaction: { hover: true, selectConnectedEdges: true },
                nodes: { font: { size: 12 } },
                edges: { arrows: { to: { enabled: true, scaleFactor: 0.5 } }, smooth: { type: 'cubicBezier', forceDirection: 'horizontal' } }
            };

            network = new vis.Network(container, { nodes: [], edges: [] }, options);
            network.on('click', (params) => {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    if (store.documents[nodeId]) {
                        selectedTaxonomy.type = null;
                        selectedTaxonomy.id = null;
                        selectDocument(nodeId);
                    }
                }
            });

            rebuildGraph();
        }

        function rebuildGraph() {
            if (!network) return;

            const nodes = [];
            const edges = [];

            nodes.push({ id: 'ROOT', label: 'KMS v2.1', level: 0, color: '#2c3e50', shape: 'dot', size: 30, font: { color: '#fff' } });

            // ë³´í—˜ì‚¬ ë…¸ë“œ
            Object.entries(store.taxonomy.carriers).forEach(([id, c]) => {
                if (id === 'INS-COMMON') return;
                nodes.push({ id, label: c.name, level: 1, color: '#8e44ad', shape: 'dot', size: 25, font: { color: '#fff' } });
                edges.push({ from: 'ROOT', to: id, color: '#bdc3c7' });
            });

            // ë¬¸ì„œ ë…¸ë“œ (ìƒìœ„ 20ê°œë§Œ í‘œì‹œ)
            const docEntries = Object.entries(store.documents).slice(0, 20);
            docEntries.forEach(([id, doc]) => {
                const tierColors = { HOT: '#e74c3c', WARM: '#f39c12', COLD: '#95a5a6' };
                const isHighlighted = highlightedDocs.value.includes(id);

                nodes.push({
                    id,
                    label: getDocTypeName(doc.docType),
                    level: 2,
                    color: isHighlighted ? '#3b82f6' : (tierColors[doc.tier] || '#95a5a6'),
                    shape: 'dot',
                    size: isHighlighted ? 20 : 15,
                    borderWidth: isHighlighted ? 3 : 1
                });

                if (doc.carrier && store.taxonomy.carriers[doc.carrier]) {
                    edges.push({ from: doc.carrier, to: id, color: '#bdc3c7' });
                }

                // ê´€ê³„ ì—£ì§€
                (doc.relations?.siblings || []).forEach(sibId => {
                    if (store.documents[sibId]) {
                        edges.push({ from: id, to: sibId, color: '#27ae60', dashes: true });
                    }
                });

                (doc.relations?.references || []).forEach(refId => {
                    if (store.documents[refId]) {
                        edges.push({ from: id, to: refId, color: '#9b59b6', dashes: [5, 5] });
                    }
                });
            });

            network.setData({ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) });
        }

        function fitGraph() {
            network?.fit({ animation: true });
        }

        function highlightRelatedDocs() {
            if (!selectedDocId.value) return;
            const relatedIds = getRelatedDocIds(selectedDocId.value);
            highlightedDocs.value = [selectedDocId.value, ...relatedIds];
            rebuildGraph();
            showToast(`${relatedIds.length}ê°œ ì—°ê´€ ë¬¸ì„œ ì „íŒŒë¨`, 'success');
        }

        function getRelatedDocIds(docId, visited = new Set()) {
            if (visited.has(docId)) return [];
            visited.add(docId);

            const doc = store.documents[docId];
            if (!doc) return [];

            let related = [];

            (doc.relations?.siblings || []).forEach(sibId => {
                if (!visited.has(sibId)) {
                    related.push(sibId);
                    related = related.concat(getRelatedDocIds(sibId, visited));
                }
            });

            (doc.relations?.references || []).forEach(refId => {
                if (!visited.has(refId)) {
                    related.push(refId);
                }
            });

            return [...new Set(related)];
        }

        function selectDocument(id) {
            selectedTaxonomy.type = null;
            selectedTaxonomy.id = null;
            selectedDocId.value = id;
            highlightedDocs.value = [];
            network?.selectNodes([id]);
            network?.focus(id, { scale: 1.2, animation: true });
        }

        function selectTaxonomy(type, id) {
            selectedDocId.value = null;
            highlightedDocs.value = [];
            selectedTaxonomy.type = type;
            selectedTaxonomy.id = id;
        }

        function checkDuplicate(carrier, product, docType, excludeId = null) {
            const found = Object.entries(store.documents).find(([id, doc]) => {
                if (excludeId && id === excludeId) return false;
                return doc.carrier === carrier && doc.product === product && doc.docType === docType;
            });
            return found ? found[1] : null;
        }

        function checkDocModalDuplicate() {
            const { carrier, product, docType } = docModal.data;
            if (!carrier || !product || !docType) {
                docModal.duplicateWarning = null;
                return;
            }
            const dup = checkDuplicate(carrier, product, docType);
            docModal.duplicateWarning = dup ? `ì´ë¯¸ ì¡´ì¬: ${dup.name}` : null;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showToast('íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ëª©ë¡ë·°ì—ì„œ ìˆ˜ë™ ë¶„ë¥˜ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤', 'warning');
            event.target.value = '';
        }

        function showAddModal(type) {
            const titles = { carrier: 'ë³´í—˜ì‚¬ ì¶”ê°€', product: 'ìƒí’ˆ ì¶”ê°€' };
            modal.show = true;
            modal.type = type;
            modal.title = titles[type];
            modal.data = { id: '', name: '', alias: '', category: 'LIFE', insurerType: 'life' };
        }

        function addTaxonomy() {
            const { type, data } = modal;
            if (!data.id || !data.name) return showToast('IDì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

            if (type === 'carrier') {
                store.taxonomy.carriers[data.id] = {
                    name: data.name,
                    alias: [],
                    type: data.insurerType,
                    tier: 'mid'
                };
            } else if (type === 'product') {
                store.taxonomy.products[data.id] = {
                    name: data.name,
                    category: data.category || 'LIFE',
                    alias: []
                };
            }

            saveStore();
            modal.show = false;
            showToast(`${type === 'carrier' ? 'ë³´í—˜ì‚¬' : 'ìƒí’ˆ'}ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        }

        function showAddDocModal() {
            docModal.show = true;
            docModal.data = { carrier: '', product: '', docType: '', process: '', audience: '', name: '' };
            docModal.duplicateWarning = null;
        }

        function createDocument() {
            const { carrier, product, docType, process, audience, name } = docModal.data;
            if (!carrier || !product || !docType) {
                return showToast('ë³´í—˜ì‚¬, ìƒí’ˆ, ë¬¸ì„œìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
            }

            if (docModal.duplicateWarning) {
                return showToast('ì¤‘ë³µ ë¬¸ì„œê°€ ì¡´ì¬í•©ë‹ˆë‹¤', 'error');
            }

            const count = Object.keys(store.documents).length + 1;
            const id = `${docType}-${carrier}-${product}-${String(count).padStart(3, '0')}`;
            const docTypeObj = store.taxonomy.docTypes[docType];
            const carrierObj = store.taxonomy.carriers[carrier];
            const productObj = store.taxonomy.products[product];

            const docName = name || `${carrierObj?.name || carrier} ${productObj?.name || product} ${docTypeObj?.name || docType}`;

            store.documents[id] = {
                id,
                name: docName,
                carrier,
                product,
                docType,
                tier: docTypeObj?.tier || 'COLD',
                process: process || '',
                audience: audience || '',
                status: "ACTIVE",
                version: "1.0",
                content: "",
                relations: { parent: null, children: [], siblings: [], references: [] },
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            saveStore();
            selectDocument(id);
            docModal.show = false;
            showToast('ë¬¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function deleteDocument(id) {
            if (!confirm(`"${store.documents[id]?.name}" ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            Object.values(store.documents).forEach(doc => {
                if (doc.relations?.parent === id) doc.relations.parent = null;
                if (doc.relations?.children) doc.relations.children = doc.relations.children.filter(c => c !== id);
                if (doc.relations?.siblings) doc.relations.siblings = doc.relations.siblings.filter(s => s !== id);
                if (doc.relations?.references) doc.relations.references = doc.relations.references.filter(r => r !== id);
            });

            delete store.documents[id];
            if (selectedDocId.value === id) {
                selectedDocId.value = null;
                highlightedDocs.value = [];
            }
            saveStore();
            showToast('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function addSiblingRelation(event) {
            const sibId = event.target.value;
            if (!sibId || !selectedDoc.value) return;

            if (!selectedDoc.value.relations) selectedDoc.value.relations = { siblings: [], references: [] };
            if (!selectedDoc.value.relations.siblings) selectedDoc.value.relations.siblings = [];
            
            if (!selectedDoc.value.relations.siblings.includes(sibId)) {
                selectedDoc.value.relations.siblings.push(sibId);
            }
            if (store.documents[sibId]) {
                if (!store.documents[sibId].relations) store.documents[sibId].relations = { siblings: [], references: [] };
                if (!store.documents[sibId].relations.siblings) store.documents[sibId].relations.siblings = [];
                if (!store.documents[sibId].relations.siblings.includes(selectedDocId.value)) {
                    store.documents[sibId].relations.siblings.push(selectedDocId.value);
                }
            }

            event.target.value = '';
            saveStore();
            showToast('í˜•ì œ ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function removeSiblingRelation(sibId) {
            if (!selectedDoc.value?.relations?.siblings) return;
            selectedDoc.value.relations.siblings = selectedDoc.value.relations.siblings.filter(s => s !== sibId);

            if (store.documents[sibId]?.relations?.siblings) {
                store.documents[sibId].relations.siblings =
                    store.documents[sibId].relations.siblings.filter(s => s !== selectedDocId.value);
            }

            saveStore();
        }

        function addReference(event) {
            const refId = event.target.value;
            if (!refId || !selectedDoc.value) return;

            if (!selectedDoc.value.relations) selectedDoc.value.relations = { siblings: [], references: [] };
            if (!selectedDoc.value.relations.references) selectedDoc.value.relations.references = [];

            if (!selectedDoc.value.relations.references.includes(refId)) {
                selectedDoc.value.relations.references.push(refId);
            }

            event.target.value = '';
            saveStore();
            showToast('ì°¸ì¡° ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function removeReference(refId) {
            if (!selectedDoc.value?.relations?.references) return;
            selectedDoc.value.relations.references = selectedDoc.value.relations.references.filter(r => r !== refId);
            saveStore();
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kms_data_v2.1_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.graph_data) {
                        Object.assign(store, migrateFromKnowledgeGraphV21(data));
                    } else if (data.carriers && data.doc_types) {
                        Object.assign(store, migrateFromTaxonomyV21(data));
                    } else if (data.taxonomy && data.documents) {
                        Object.assign(store, data);
                    } else {
                        throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” í˜•ì‹');
                    }
                    saveStore();
                    showToast('ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
                } catch (err) {
                    showToast('ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Helper functions
        function getCarrierName(id) { return store.taxonomy.carriers[id]?.name || id; }
        function getProductName(id) { return store.taxonomy.products[id]?.name || id; }
        function getDocTypeName(id) { return store.taxonomy.docTypes[id]?.name || id; }
        function getProcessName(id) { return store.taxonomy.processes[id]?.name || id || '-'; }
        function getAudienceName(id) { return store.taxonomy.audiences[id]?.name || id || '-'; }
        function getDocName(id) { return store.documents[id]?.name || id; }

        function getDocCountByCarrier(carrierId) {
            return Object.values(store.documents).filter(d => d.carrier === carrierId).length;
        }

        function getDocCountByCarrierTier(carrierId, tier) {
            return Object.values(store.documents).filter(d => d.carrier === carrierId && d.tier === tier).length;
        }

        function getDocCountByProcess(processId) {
            return Object.values(store.documents).filter(d => d.process === processId).length;
        }

        function getDocCountByAudience(audienceId) {
            return Object.values(store.documents).filter(d => d.audience === audienceId).length;
        }

        function getDocsByProcess(processId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (doc.process === processId) docs[id] = doc;
            });
            return docs;
        }

        function getDocsByAudience(audienceId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
                if (doc.audience === audienceId) docs[id] = doc;
            });
            return docs;
        }

        function getTierClass(tier) {
            const classes = { HOT: 'bg-red-100 text-red-700', WARM: 'bg-yellow-100 text-yellow-700', COLD: 'bg-gray-100 text-gray-700' };
            return classes[tier] || 'bg-gray-100 text-gray-600';
        }

        function formatDate(isoString) {
            if (!isoString) return '-';
            return new Date(isoString).toLocaleString('ko-KR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getDaysUntil(dateStr) {
            const target = new Date(dateStr);
            const today = new Date();
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            return diff > 0 ? diff : 0;
        }

        function getRegulationStatusClass(status) {
            return status === 'active' 
                ? 'bg-green-500 border-green-500' 
                : 'bg-white border-yellow-500';
        }

        function getRegulationBorderClass(impact) {
            if (impact === 'critical') return 'border-red-500';
            if (impact === 'high') return 'border-orange-500';
            return 'border-blue-500';
        }

        return {
            store,
            activeTab,
            viewMode,
            searchQuery,
            selectedDocId,
            selectedDoc,
            selectedTaxonomy,
            modal,
            docModal,
            uploadPreview,
            highlightedDocs,
            toasts,
            carrierTypeFilter,
            productCategoryFilter,
            docTypeTierFilter,
            filterProcess,
            filterAudience,
            filteredCarriers,
            filteredProducts,
            filteredDocTypes,
            sortedProcesses,
            sortedAudiences,
            filteredDocuments,
            otherDocuments,
            availableSiblings,
            duplicateGroups,
            upcomingRegulation,
            removeToast,
            showToast,
            saveStore,
            fitGraph,
            highlightRelatedDocs,
            getRelatedDocIds,
            selectDocument,
            selectTaxonomy,
            checkDocModalDuplicate,
            handleFileUpload,
            showAddModal,
            addTaxonomy,
            showAddDocModal,
            createDocument,
            deleteDocument,
            addSiblingRelation,
            removeSiblingRelation,
            addReference,
            removeReference,
            exportData,
            importData,
            getCarrierName,
            getProductName,
            getDocTypeName,
            getProcessName,
            getAudienceName,
            getDocName,
            getDocCountByCarrier,
            getDocCountByCarrierTier,
            getDocCountByProcess,
            getDocCountByAudience,
            getDocsByProcess,
            getDocsByAudience,
            getTierClass,
            formatDate,
            getDaysUntil,
            getRegulationStatusClass,
            getRegulationBorderClass
        };
    }
}).mount('#app');
</script>

</body>
</html>
