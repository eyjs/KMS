<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KMS Admin v3.0 - ë¬¸ì„œê´€ë¦¬ í”„ë ˆì„ì›Œí¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }
      #network {
        width: 100%;
        height: 100%;
      }
      .toast {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .regulation-badge {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 h-screen overflow-hidden">
    <div id="app" class="flex h-full">
      <!-- Toast ì•Œë¦¼ -->
      <div class="fixed top-4 right-4 z-50 space-y-2">
        <div
          v-for="(toast, idx) in toasts"
          :key="idx"
          :class="toast.type === 'error' ? 'bg-red-500' : toast.type === 'warning' ? 'bg-yellow-500' : 'bg-green-500'"
          class="toast text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 max-w-sm"
        >
          <span>{{ toast.message }}</span>
          <button @click="removeToast(idx)" class="ml-2 hover:opacity-70">&times;</button>
        </div>
      </div>

      <!-- LEFT SIDEBAR -->
      <aside class="w-80 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-lg font-bold text-gray-800">KMS Admin</h1>
              <p class="text-xs text-gray-500">v3.0 - Document Framework</p>
            </div>
            <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded">í”„ë ˆì„ì›Œí¬</span>
          </div>
        </div>

        <!-- Taxonomy Tabs - 2ì¤„ -->
        <div class="flex-1 overflow-y-auto scrollbar-thin p-3">
          <!-- ì²«ì§¸ ì¤„: ê¸°ë³¸ íƒ­ -->
          <div class="flex gap-1 mb-2">
            <button
              @click="activeTab = 'carriers'"
              :class="activeTab === 'carriers' ? 'bg-purple-100 text-purple-700' : 'text-gray-600 hover:bg-gray-100'"
              class="flex-1 text-xs py-1.5 rounded-md font-medium transition"
            >
              ë³´í—˜ì‚¬
            </button>
            <button
              @click="activeTab = 'products'"
              :class="activeTab === 'products' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'"
              class="flex-1 text-xs py-1.5 rounded-md font-medium transition"
            >
              ìƒí’ˆ
            </button>
            <button
              @click="activeTab = 'docTypes'"
              :class="activeTab === 'docTypes' ? 'bg-green-100 text-green-700' : 'text-gray-600 hover:bg-gray-100'"
              class="flex-1 text-xs py-1.5 rounded-md font-medium transition"
            >
              ë¬¸ì„œìœ í˜•
            </button>
          </div>
          <!-- ë‘˜ì§¸ ì¤„: v2.1 í™•ì¥ íƒ­ -->
          <div class="flex gap-1 mb-3">
            <button
              @click="activeTab = 'processes'"
              :class="activeTab === 'processes' ? 'bg-orange-100 text-orange-700' : 'text-gray-600 hover:bg-gray-100'"
              class="flex-1 text-xs py-1.5 rounded-md font-medium transition"
            >
              í”„ë¡œì„¸ìŠ¤
            </button>
            <button
              @click="activeTab = 'audiences'"
              :class="activeTab === 'audiences' ? 'bg-cyan-100 text-cyan-700' : 'text-gray-600 hover:bg-gray-100'"
              class="flex-1 text-xs py-1.5 rounded-md font-medium transition"
            >
              ì—­í• 
            </button>
            <button
              @click="activeTab = 'certifications'"
              :class="activeTab === 'certifications' ? 'bg-pink-100 text-pink-700' : 'text-gray-600 hover:bg-gray-100'"
              class="flex-1 text-xs py-1.5 rounded-md font-medium transition"
            >
              ìê²©ì¦
            </button>
          </div>

          <!-- Carriers -->
          <div v-if="activeTab === 'carriers'" class="space-y-2">
            <!-- í•„í„° -->
            <div class="flex gap-1 mb-2">
              <button
                @click="carrierTypeFilter = 'all'"
                :class="carrierTypeFilter === 'all' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                class="flex-1 text-xs py-1 rounded"
              >
                ì „ì²´
              </button>
              <button
                @click="carrierTypeFilter = 'life'"
                :class="carrierTypeFilter === 'life' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                class="flex-1 text-xs py-1 rounded"
              >
                ìƒë³´
              </button>
              <button
                @click="carrierTypeFilter = 'non-life'"
                :class="carrierTypeFilter === 'non-life' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                class="flex-1 text-xs py-1 rounded"
              >
                ì†ë³´
              </button>
            </div>
            <div
              v-for="(carrier, id) in filteredCarriers"
              :key="id"
              @click="selectTaxonomy('carrier', id)"
              :class="selectedTaxonomy.type === 'carrier' && selectedTaxonomy.id === id ? 'ring-2 ring-purple-400' : ''"
              class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-purple-50 transition"
            >
              <div class="flex items-center justify-between">
                <span class="font-medium text-sm">{{ carrier.name }}</span>
                <div class="flex items-center gap-1">
                  <span
                    v-if="carrier.type"
                    class="text-xs px-1.5 py-0.5 rounded"
                    :class="carrier.type === 'life' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'"
                  >
                    {{ carrier.type === 'life' ? 'ìƒ' : 'ì†' }}
                  </span>
                  <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded"
                    >{{ getDocCountByCarrier(id) }}ê±´</span
                  >
                </div>
              </div>
              <div class="text-xs text-gray-500 mt-1">{{ carrier.alias?.join(', ') || '-' }}</div>
            </div>
            <button
              @click="showAddModal('carrier')"
              class="w-full p-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm hover:border-purple-400 hover:text-purple-600 transition"
            >
              + ë³´í—˜ì‚¬ ì¶”ê°€
            </button>
          </div>

          <!-- Products -->
          <div v-if="activeTab === 'products'" class="space-y-2">
            <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
            <select v-model="productCategoryFilter" class="w-full px-2 py-1 text-xs border rounded mb-2">
              <option value="all">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
              <option v-for="(cat, key) in store.taxonomy.productCategories" :key="key" :value="key">
                {{ cat.name }}
              </option>
            </select>
            <div
              v-for="(product, id) in filteredProducts"
              :key="id"
              @click="selectTaxonomy('product', id)"
              :class="selectedTaxonomy.type === 'product' && selectedTaxonomy.id === id ? 'ring-2 ring-blue-400' : ''"
              class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition"
            >
              <div class="flex items-center justify-between">
                <span class="font-medium text-sm">{{ product.name }}</span>
                <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">{{ product.category }}</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
              <div v-if="product.supersedes" class="text-xs text-amber-600 mt-1">
                â† {{ getProductName(product.supersedes) }}
              </div>
              <div v-if="product.requires_license" class="text-xs text-orange-600 mt-1">
                {{ product.requires_license }} ìê²© í•„ìš”
              </div>
            </div>
            <button
              @click="showAddModal('product')"
              class="w-full p-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm hover:border-blue-400 hover:text-blue-600 transition"
            >
              + ìƒí’ˆ ì¶”ê°€
            </button>
          </div>

          <!-- DocTypes -->
          <div v-if="activeTab === 'docTypes'" class="space-y-2">
            <!-- Tier í•„í„° -->
            <div class="flex gap-1 mb-2">
              <button
                @click="docTypeTierFilter = 'all'"
                :class="docTypeTierFilter === 'all' ? 'bg-gray-200' : 'hover:bg-gray-100'"
                class="flex-1 text-xs py-1 rounded"
              >
                ì „ì²´
              </button>
              <button
                @click="docTypeTierFilter = 'HOT'"
                :class="docTypeTierFilter === 'HOT' ? 'bg-red-200 text-red-700' : 'hover:bg-gray-100'"
                class="flex-1 text-xs py-1 rounded"
              >
                ğŸ”¥HOT
              </button>
              <button
                @click="docTypeTierFilter = 'WARM'"
                :class="docTypeTierFilter === 'WARM' ? 'bg-yellow-200 text-yellow-700' : 'hover:bg-gray-100'"
                class="flex-1 text-xs py-1 rounded"
              >
                ğŸŒ¡ï¸WARM
              </button>
              <button
                @click="docTypeTierFilter = 'COLD'"
                :class="docTypeTierFilter === 'COLD' ? 'bg-gray-300 text-gray-700' : 'hover:bg-gray-100'"
                class="flex-1 text-xs py-1 rounded"
              >
                â„ï¸COLD
              </button>
            </div>
            <div
              v-for="(docType, id) in filteredDocTypes"
              :key="id"
              @click="selectTaxonomy('docType', id)"
              :class="selectedTaxonomy.type === 'docType' && selectedTaxonomy.id === id ? 'ring-2 ring-green-400' : ''"
              class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-green-50 transition"
            >
              <div class="flex items-center justify-between">
                <span class="font-medium text-sm">{{ docType.name }}</span>
                <div class="flex items-center gap-1">
                  <span v-if="docType.source" class="text-xs px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded"
                    >{{ docType.source }}</span
                  >
                  <span :class="getTierClass(docType.tier)" class="text-xs px-2 py-0.5 rounded"
                    >{{ docType.tier }}</span
                  >
                </div>
              </div>
              <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
              <div v-if="docType.description" class="text-xs text-gray-400 mt-1">{{ docType.description }}</div>
            </div>
          </div>

          <!-- Processes (v2.1 ì‹ ê·œ) -->
          <div v-if="activeTab === 'processes'" class="space-y-2">
            <div class="text-xs text-gray-500 mb-2 p-2 bg-orange-50 rounded">ğŸ“‹ ì˜ì—… í”„ë¡œì„¸ìŠ¤ ë‹¨ê³„ë³„ ë¬¸ì„œ ë¶„ë¥˜</div>
            <div
              v-for="(process, id) in sortedProcesses"
              :key="id"
              @click="selectTaxonomy('process', id)"
              :class="selectedTaxonomy.type === 'process' && selectedTaxonomy.id === id ? 'ring-2 ring-orange-400' : ''"
              class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-orange-50 transition"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span
                    class="w-6 h-6 flex items-center justify-center bg-orange-100 text-orange-700 rounded-full text-xs font-bold"
                  >
                    {{ process.order }}
                  </span>
                  <span class="font-medium text-sm">{{ process.name }}</span>
                </div>
                <span class="text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded"
                  >{{ getDocCountByProcess(id) }}ê±´</span
                >
              </div>
              <div v-if="process.description" class="text-xs text-gray-500 mt-2 ml-8">{{ process.description }}</div>
            </div>
          </div>

          <!-- Audiences (v2.1 ì‹ ê·œ) -->
          <div v-if="activeTab === 'audiences'" class="space-y-2">
            <div class="text-xs text-gray-500 mb-2 p-2 bg-cyan-50 rounded">ğŸ‘¥ ëŒ€ìƒ ì—­í• ë³„ ë¬¸ì„œ ë¶„ë¥˜</div>
            <div
              v-for="(audience, id) in sortedAudiences"
              :key="id"
              @click="selectTaxonomy('audience', id)"
              :class="selectedTaxonomy.type === 'audience' && selectedTaxonomy.id === id ? 'ring-2 ring-cyan-400' : ''"
              class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-cyan-50 transition"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span
                    class="w-6 h-6 flex items-center justify-center bg-cyan-100 text-cyan-700 rounded-full text-xs font-bold"
                  >
                    L{{ audience.level }}
                  </span>
                  <span class="font-medium text-sm">{{ audience.name }}</span>
                </div>
                <span class="text-xs px-2 py-0.5 bg-cyan-100 text-cyan-700 rounded"
                  >{{ getDocCountByAudience(id) }}ê±´</span
                >
              </div>
              <div v-if="audience.description" class="text-xs text-gray-500 mt-2 ml-8">{{ audience.description }}</div>
            </div>
          </div>

          <!-- Certifications (v2.1 ì‹ ê·œ) -->
          <div v-if="activeTab === 'certifications'" class="space-y-2">
            <div class="text-xs text-gray-500 mb-2 p-2 bg-pink-50 rounded">ğŸ“œ ì„¤ê³„ì‚¬ ìê²©ì¦ ê´€ë¦¬</div>
            <div
              v-for="(cert, id) in store.taxonomy.certifications"
              :key="id"
              @click="selectTaxonomy('certification', id)"
              :class="selectedTaxonomy.type === 'certification' && selectedTaxonomy.id === id ? 'ring-2 ring-pink-400' : ''"
              class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-pink-50 transition"
            >
              <div class="flex items-center justify-between">
                <span class="font-medium text-sm">{{ cert.name }}</span>
                <span v-if="cert.mandatory" class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded">í•„ìˆ˜</span>
                <span v-else class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded">ì„ íƒ</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">{{ id }}</div>
              <div v-if="cert.hours" class="text-xs text-gray-400 mt-1">êµìœ¡ì‹œê°„: {{ cert.hours }}ì‹œê°„</div>
              <div v-if="cert.description" class="text-xs text-gray-400">{{ cert.description }}</div>
              <div v-if="cert.products" class="flex flex-wrap gap-1 mt-2">
                <span
                  v-for="prd in cert.products"
                  :key="prd"
                  class="text-xs px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded"
                >
                  {{ getProductName(prd) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Upload Section -->
        <div class="p-3 border-t border-gray-100">
          <label
            class="block w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition"
          >
            <span class="text-sm text-gray-600">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ (ìë™ ë¶„ë¥˜)</span>
            <input type="file" accept=".md,.pdf,.hwp,.docx" @change="handleFileUpload" class="hidden" />
          </label>
        </div>

        <!-- Data Actions -->
        <div class="p-3 border-t border-gray-100 flex gap-2">
          <button
            @click="exportData"
            class="flex-1 py-2 px-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-medium transition"
          >
            ë‚´ë³´ë‚´ê¸°
          </button>
          <label
            class="flex-1 py-2 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-medium text-center cursor-pointer transition"
          >
            ê°€ì ¸ì˜¤ê¸°
            <input type="file" accept=".json" @change="importData" class="hidden" />
          </label>
        </div>
      </aside>

      <!-- CENTER AREA -->
      <main class="flex-1 flex flex-col">
        <!-- Toolbar -->
        <div class="h-12 bg-white border-b border-gray-200 flex items-center px-4 gap-4">
          <div class="flex items-center gap-2">
            <button
              @click="viewMode = 'graph'"
              :class="viewMode === 'graph' ? 'bg-gray-200' : 'hover:bg-gray-100'"
              class="p-2 rounded-lg transition"
              title="ê·¸ë˜í”„ ë·°"
            >
              ğŸ“Š
            </button>
            <button
              @click="viewMode = 'list'"
              :class="viewMode === 'list' ? 'bg-gray-200' : 'hover:bg-gray-100'"
              class="p-2 rounded-lg transition"
              title="ëª©ë¡ ë·°"
            >
              ğŸ“‹
            </button>
            <button
              @click="viewMode = 'validation'"
              :class="viewMode === 'validation' ? 'bg-gray-200' : 'hover:bg-gray-100'"
              class="p-2 rounded-lg transition"
              title="ê²€ì¦ ë·°"
            >
              âœ…
            </button>
            <button
              @click="viewMode = 'timeline'"
              :class="viewMode === 'timeline' ? 'bg-gray-200' : 'hover:bg-gray-100'"
              class="p-2 rounded-lg transition"
              title="ê·œì œ íƒ€ì„ë¼ì¸"
            >
              ğŸ“…
            </button>
            <button
              @click="viewMode = 'dashboard'"
              :class="viewMode === 'dashboard' ? 'bg-gray-200' : 'hover:bg-gray-100'"
              class="p-2 rounded-lg transition"
              title="ë°ì´í„° í’ˆì§ˆ ëŒ€ì‹œë³´ë“œ"
            >
              ğŸ©º
            </button>
          </div>
          <div class="h-6 w-px bg-gray-200"></div>
          <input
            type="text"
            v-model="searchQuery"
            @keydown.enter="applySearch"
            placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ í›„ Enter..."
            class="flex-1 px-3 py-1.5 bg-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
          <button
            v-if="appliedSearch"
            @click="clearSearch"
            class="px-2 py-1 text-xs text-gray-500 hover:text-red-500 transition"
            title="ê²€ìƒ‰ ì´ˆê¸°í™”"
          >
            &times;
          </button>
          <!-- í•„í„° ë“œë¡­ë‹¤ìš´ -->
          <select v-model="filterLifecycle" class="px-2 py-1.5 text-xs border rounded-lg">
            <option value="">ìƒíƒœ ì „ì²´</option>
            <option value="ACTIVE">ACTIVE</option>
            <option value="STALE">STALE</option>
            <option value="DRAFT">DRAFT</option>
            <option value="REVIEW">REVIEW</option>
            <option value="DEPRECATED">DEPRECATED</option>
          </select>
          <select v-model="filterProcess" class="px-2 py-1.5 text-xs border rounded-lg">
            <option value="">í”„ë¡œì„¸ìŠ¤ ì „ì²´</option>
            <option v-for="(p, id) in store.taxonomy.processes" :key="id" :value="id">{{ p.name }}</option>
          </select>
          <select v-model="filterAudience" class="px-2 py-1.5 text-xs border rounded-lg">
            <option value="">ì—­í•  ì „ì²´</option>
            <option v-for="(a, id) in store.taxonomy.audiences" :key="id" :value="id">{{ a.name }}</option>
          </select>
          <button
            @click="showAddDocModal"
            class="px-4 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition"
          >
            + ë¬¸ì„œ ìƒì„±
          </button>
        </div>

        <!-- Regulation Alert Bar (ë‹¤ê°€ì˜¤ëŠ” ê·œì œ) -->
        <div
          v-if="upcomingRegulation"
          class="bg-gradient-to-r from-red-500 to-orange-500 text-white px-4 py-2 flex items-center justify-between"
        >
          <div class="flex items-center gap-3">
            <span class="regulation-badge px-2 py-1 bg-white/20 rounded text-xs font-bold">âš ï¸ ê·œì œ ì˜ˆê³ </span>
            <span class="font-medium">{{ upcomingRegulation.name }}</span>
            <span class="text-sm opacity-90">{{ upcomingRegulation.date }}</span>
          </div>
          <span class="text-sm">D-{{ getDaysUntil(upcomingRegulation.date) }}</span>
        </div>

        <!-- Graph View -->
        <div v-show="viewMode === 'graph'" class="flex-1 relative">
          <div id="network" class="w-full h-full bg-gray-50"></div>
          <!-- Breadcrumbì€ ë²”ë¡€ ìœ„ì— í‘œì‹œ -->
          <!-- ê·¸ë˜í”„ ëª¨ë“œ ì„ íƒ -->
          <div
            class="absolute top-4 right-4 bg-white/90 backdrop-blur rounded-lg shadow-lg flex text-xs overflow-hidden"
          >
            <button
              @click="graphMode = 'overview'; clearSelection()"
              :class="graphMode === 'overview' ? 'bg-indigo-500 text-white' : 'text-gray-600 hover:bg-gray-100'"
              class="px-3 py-2 font-medium transition"
            >
              ì „ì²´ êµ¬ì¡°
            </button>
            <button
              @click="graphMode = 'detail'; rebuildGraph()"
              :class="graphMode === 'detail' ? 'bg-indigo-500 text-white' : 'text-gray-600 hover:bg-gray-100'"
              class="px-3 py-2 font-medium transition"
            >
              ë¬¸ì„œ ì¤‘ì‹¬
            </button>
          </div>
          <!-- ê²½ë¡œ + ì¶• ì„ íƒ + ë²”ë¡€ -->
          <div class="absolute top-4 left-4 bg-white/90 backdrop-blur rounded-lg p-3 shadow-lg text-xs">
            <!-- ì¶• ì„ íƒ -->
            <div class="flex items-center gap-1 mb-2">
              <span class="text-gray-400 mr-0.5">ì¶•:</span>
              <button v-for="axis in AXIS_OPTIONS" :key="axis.id"
                @click="setStartAxis(axis.id)"
                :class="startAxis === axis.id ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'"
                class="px-1.5 py-0.5 rounded text-[10px] font-medium transition">
                {{ axis.label }}
              </button>
            </div>
            <!-- í˜„ì¬ ê²½ë¡œ -->
            <div class="mb-2 flex items-center gap-1 flex-wrap">
              <button
                @click="clearSelection"
                class="font-bold hover:text-indigo-600 transition"
                :class="listDrillPath.length > 0 || selectedDocId || appliedSearch ? 'text-indigo-600 underline' : 'text-gray-800'"
              >
                KMS
              </button>
              <template v-for="(step, idx) in listDrillPath" :key="idx">
                <span class="text-gray-400">&gt;</span>
                <button
                  v-if="idx < listDrillPath.length - 1 || selectedDocId"
                  @click="drillTo(idx)"
                  class="text-indigo-600 hover:underline transition"
                >
                  {{ getDrillCategoryName(step.type, step.id) }}
                </button>
                <span v-else class="font-bold text-gray-800">{{ getDrillCategoryName(step.type, step.id) }}</span>
              </template>
              <template v-if="selectedDocId && selectedDoc">
                <span class="text-gray-400">&gt;</span>
                <span class="font-bold text-gray-800">{{ selectedDoc.name }}</span>
              </template>
              <template v-if="appliedSearch && !selectedTaxonomy.type && !selectedDocId">
                <span class="text-gray-400">&gt;</span>
                <span class="font-bold text-orange-600">"{{ appliedSearch }}" ê²€ìƒ‰ ê²°ê³¼</span>
                <button @click="clearSearch" class="ml-1 text-gray-400 hover:text-red-500">&times;</button>
              </template>
            </div>
            <div class="border-t border-gray-200 pt-2 mb-2"></div>
            <div class="font-bold mb-2">ë²”ë¡€</div>
            <template v-if="graphMode === 'overview'">
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-3 rounded-full bg-purple-500"></span> ë³´í—˜ì‚¬
              </div>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span> ìƒí’ˆ
              </div>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-3 rounded-full bg-green-500"></span> ë¬¸ì„œìœ í˜•
              </div>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-3 rounded-full bg-orange-500"></span> í”„ë¡œì„¸ìŠ¤
              </div>
              <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-cyan-500"></span> ì—­í• </div>
            </template>
            <template v-else>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-3 rounded-full bg-purple-500"></span> ë³´í—˜ì‚¬
              </div>
              <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> HOT</div>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-3 rounded-full bg-yellow-500"></span> WARM
              </div>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-3 rounded-full bg-gray-400"></span> COLD
              </div>
              <div class="flex items-center gap-2 mb-1"><span class="w-3 h-1 bg-indigo-500"></span> ë¶€ëª¨-ìì‹</div>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-3 h-0.5 bg-green-500 border-dashed border-t"></span> í˜•ì œ
              </div>
              <div class="flex items-center gap-2">
                <span class="w-3 h-0.5 bg-purple-500 border-dotted border-t"></span> ì°¸ì¡°
              </div>
            </template>
          </div>
          <div class="absolute bottom-4 right-4 flex gap-2">
            <button
              @click="fitGraph"
              class="px-4 py-2 bg-white shadow-lg rounded-lg text-sm hover:bg-gray-50 transition"
            >
              ë§ì¶¤ ë³´ê¸°
            </button>
            <button
              v-if="selectedDocId"
              @click="highlightRelatedDocs"
              class="px-4 py-2 bg-blue-500 text-white shadow-lg rounded-lg text-sm hover:bg-blue-600 transition"
            >
              ì—°ê´€ ë¬¸ì„œ ì „íŒŒ
            </button>
          </div>
        </div>

        <!-- List View -->
        <div v-show="viewMode === 'list'" class="flex-1 overflow-auto p-4">
          <!-- ì¶• ì„ íƒ -->
          <div class="flex items-center gap-1 mb-2">
            <span class="text-xs text-gray-400 mr-1">ì‹œì‘ ì¶•:</span>
            <button v-for="axis in AXIS_OPTIONS" :key="axis.id"
              @click="setStartAxis(axis.id)"
              :class="startAxis === axis.id ? 'bg-indigo-600 text-white shadow-sm' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
              class="px-2.5 py-1 rounded text-xs font-medium transition">
              {{ axis.label }}
            </button>
          </div>

          <!-- í•­ìƒ ë³´ì´ëŠ” ê²½ë¡œ (breadcrumb) -->
          <div class="flex items-center gap-1.5 text-sm mb-3 flex-wrap bg-white rounded-lg shadow-sm px-4 py-2.5">
            <button
              @click="clearSelection"
              class="font-bold transition"
              :class="listDrillPath.length > 0 || selectedDocId ? 'text-indigo-600 hover:underline' : 'text-gray-800'"
            >
              KMS
            </button>
            <template v-for="(step, idx) in listDrillPath" :key="idx">
              <span class="text-gray-400">&rsaquo;</span>
              <button
                v-if="idx < listDrillPath.length - 1 || selectedDocId"
                @click="drillTo(idx)"
                class="text-indigo-600 hover:underline transition"
              >
                {{ getDrillCategoryName(step.type, step.id) }}
              </button>
              <span v-else class="font-bold text-gray-800">{{ getDrillCategoryName(step.type, step.id) }}</span>
            </template>
            <template v-if="selectedDocId && selectedDoc">
              <span class="text-gray-400">&rsaquo;</span>
              <span class="font-bold text-gray-800">{{ selectedDoc.name }}</span>
            </template>
            <template v-if="appliedSearch && !selectedDocId && !selectedTaxonomy.type">
              <span class="text-gray-400">&rsaquo;</span>
              <span class="font-bold text-orange-600">"{{ appliedSearch }}" ê²€ìƒ‰</span>
              <button @click="clearSearch" class="text-gray-400 hover:text-red-500">&times;</button>
            </template>
            <span v-if="!selectedDocId && !selectedTaxonomy.type" class="text-xs text-gray-400 ml-2">
              ({{ Object.keys(filteredDocuments).length }}ê±´)
            </span>
            <span v-else-if="selectedTaxonomy.type && !selectedDocId" class="text-xs text-gray-400 ml-2">
              ({{ getFilteredDocsForDrill().length }}ê±´)
            </span>
          </div>

          <!-- ë¬¸ì„œ ë‚´ìš© í¸ì§‘ (ë¬¸ì„œ ì„ íƒ ì‹œ) -->
          <div v-if="selectedDocId && selectedDoc">
            <div class="bg-white rounded-lg shadow-sm">
              <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                <span class="text-lg font-bold text-gray-800">{{ selectedDoc.name }}</span>
                <span :class="getTierClass(selectedDoc.tier)" class="text-xs px-2 py-0.5 rounded"
                  >{{ selectedDoc.tier }}</span
                >
              </div>
              <textarea
                v-model="selectedDoc.content"
                @change="saveStore"
                placeholder="ë¬¸ì„œ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”...&#10;&#10;ì•½ê´€ ë‚´ìš©, ìƒí’ˆ ì„¤ëª…, ì‹œì±… ì¡°ê±´ ë“± ì‹¤ì œ ë¬¸ì„œ ë³¸ë¬¸ì„ ì…ë ¥í•©ë‹ˆë‹¤."
                class="w-full p-4 text-sm text-gray-800 leading-relaxed resize-none focus:outline-none"
                style="min-height: 300px"
              ></textarea>
            </div>
          </div>

          <!-- ë¶„ë¥˜ì²´ê³„ ë“œë¦´ë‹¤ìš´ (ë¶„ë¥˜ ì„ íƒ ì‹œ) -->
          <div v-else-if="selectedTaxonomy.type">
            <!-- ì„ íƒëœ ë¶„ë¥˜ í•­ëª© í—¤ë” + ì„¤ëª… -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
              <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-bold text-gray-800">
                  {{ getTaxonomyItemName(selectedTaxonomy.type, selectedTaxonomy.id) }}
                </h2>
                <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded"
                  >{{ getTaxonomyTypeLabel(selectedTaxonomy.type) }}</span
                >
              </div>
              <input
                type="text"
                :value="getTaxonomyItem(selectedTaxonomy.type, selectedTaxonomy.id)?.description || ''"
                @input="setTaxonomyField(selectedTaxonomy.type, selectedTaxonomy.id, 'description', $event.target.value)"
                @change="saveStore"
                placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm"
              />
            </div>

            <!-- í•˜ìœ„ ì¹´í…Œê³ ë¦¬ -->
            <div v-if="getSubCategoriesForDrill().length > 0" class="mb-4">
              <h3 class="text-sm font-bold text-gray-600 mb-2">
                í•˜ìœ„ ë¶„ë¥˜ ({{ getSubCategoriesForDrill().length }}ê°œ)
              </h3>
              <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
                <div
                  v-for="cat in getSubCategoriesForDrill()"
                  :key="cat.id"
                  @click="selectTaxonomy(cat.type, cat.id)"
                  class="bg-white rounded-lg shadow-sm p-3 cursor-pointer hover:bg-indigo-50 hover:ring-2 hover:ring-indigo-200 transition group"
                >
                  <div class="flex items-center justify-between">
                    <span class="font-medium text-sm text-gray-800 group-hover:text-indigo-700"
                      >{{ getDrillCategoryName(cat.type, cat.id) }}</span
                    >
                    <span class="text-xs text-gray-400">&rsaquo;</span>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">{{ cat.count }}ê±´</div>
                </div>
              </div>
            </div>

            <!-- í•„í„°ëœ ë¬¸ì„œ ëª©ë¡ -->
            <div>
              <h3 class="text-sm font-bold text-gray-600 mb-2">ë¬¸ì„œ ({{ getFilteredDocsForDrill().length }}ê±´)</h3>
              <table class="w-full bg-white rounded-lg shadow-sm overflow-hidden">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ë¬¸ì„œëª…</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ë³´í—˜ì‚¬</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ìƒí’ˆ</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ìœ í˜•</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì‹ ì„ ë„</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <tr
                    v-for="([docId, doc]) in getFilteredDocsForDrill()"
                    :key="docId"
                    @click="selectDocument(docId)"
                    class="cursor-pointer hover:bg-gray-50 transition"
                  >
                    <td class="px-4 py-2.5 text-sm font-medium text-gray-800">{{ doc.name }}</td>
                    <td class="px-4 py-2.5 text-sm text-gray-600">{{ getCarrierName(getDocCarrier(doc)) }}</td>
                    <td class="px-4 py-2.5 text-sm text-gray-600">{{ getProductName(getDocProduct(doc)) }}</td>
                    <td class="px-4 py-2.5 text-sm text-gray-600">{{ getDocTypeName(getDocDocType(doc)) }}</td>
                    <td class="px-4 py-2.5">
                      <span :class="getLifecycleClass(doc.lifecycle || 'ACTIVE')" class="text-xs px-2 py-0.5 rounded">{{ doc.lifecycle || 'ACTIVE' }}</span>
                    </td>
                    <td class="px-4 py-2.5">
                      <span :class="getFreshnessClass(calcFreshness(doc).status)" class="text-xs px-2 py-0.5 rounded">{{ calcFreshness(doc).status }}</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ì´ˆê¸° í™”ë©´: ì‹œì‘ ì¶• ê¸°ì¤€ ì¹´í…Œê³ ë¦¬ ê·¸ë¦¬ë“œ (ì„ íƒ ì—†ìŒ) -->
          <div v-else>
            <div class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
              <div
                v-for="cat in getSubCategoriesForDrill()"
                :key="cat.id"
                @click="selectTaxonomy(cat.type, cat.id)"
                class="bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:bg-indigo-50 hover:ring-2 hover:ring-indigo-200 transition group"
              >
                <div class="flex items-center justify-between">
                  <span class="font-medium text-sm text-gray-800 group-hover:text-indigo-700">{{ getDrillCategoryName(cat.type, cat.id) }}</span>
                  <span class="text-xs text-gray-400">&rsaquo;</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">{{ cat.count }}ê±´</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Validation View -->
        <div v-show="viewMode === 'validation'" class="flex-1 overflow-auto p-4">
          <div class="grid grid-cols-2 gap-4">
            <!-- ìœ ë‹ˆí¬ ê²€ì¦ -->
            <div class="bg-white rounded-lg shadow-sm p-4">
              <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">ğŸ”‘ ìœ ë‹ˆí¬ ê²€ì¦</h3>
              <div v-if="duplicateGroups.length === 0" class="text-green-600 text-sm flex items-center gap-2">
                âœ… ëª¨ë“  ë¬¸ì„œê°€ ìœ ë‹ˆí¬í•©ë‹ˆë‹¤
              </div>
              <div v-else class="space-y-2">
                <div
                  v-for="group in duplicateGroups"
                  :key="group.key"
                  class="p-3 bg-red-50 rounded-lg border border-red-200"
                >
                  <div class="text-sm font-medium text-red-700">{{ group.key }}</div>
                  <div class="text-xs text-red-600 mt-1">{{ group.docs.length }}ê°œ ì¤‘ë³µ</div>
                </div>
              </div>
            </div>

            <!-- ì „íŒŒ ê²€ì¦ -->
            <div class="bg-white rounded-lg shadow-sm p-4">
              <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">ì „íŒŒ ê²€ì¦</h3>
              <div class="text-sm text-gray-600 mb-3">ë¬¸ì„œë¥¼ ì„ íƒí•˜ê³  "ì—°ê´€ ë¬¸ì„œ ì „íŒŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
              <div v-if="selectedDocId" class="space-y-2">
                <div class="p-3 bg-blue-50 rounded-lg">
                  <div class="font-medium text-sm">{{ selectedDoc?.name }}</div>
                  <!-- ë¶€ëª¨ -->
                  <div v-if="selectedDoc?.relations?.parent" class="mt-2">
                    <div class="text-xs text-indigo-600 font-medium">ë¶€ëª¨:</div>
                    <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded inline-block mt-1">
                      {{ getDocName(selectedDoc.relations.parent) }}
                    </span>
                  </div>
                  <!-- ìì‹ -->
                  <div v-if="(selectedDoc?.relations?.children || []).length > 0" class="mt-2">
                    <div class="text-xs text-violet-600 font-medium">
                      ìì‹ ({{ selectedDoc.relations.children.length }}ê°œ):
                    </div>
                    <div class="flex flex-wrap gap-1 mt-1">
                      <span
                        v-for="cId in selectedDoc.relations.children"
                        :key="cId"
                        class="text-xs px-2 py-1 bg-violet-100 text-violet-700 rounded"
                      >
                        {{ getDocName(cId) }}
                      </span>
                    </div>
                  </div>
                  <!-- ì „ì²´ ì—°ê´€ -->
                  <div class="text-xs text-gray-500 mt-2">
                    ì „ì²´ ì—°ê´€ ë¬¸ì„œ ({{ getRelatedDocIds(selectedDocId).length }}ê°œ):
                  </div>
                  <div class="flex flex-wrap gap-1 mt-1">
                    <span
                      v-for="relId in getRelatedDocIds(selectedDocId)"
                      :key="relId"
                      class="text-xs px-2 py-1 bg-white rounded border"
                    >
                      {{ getDocName(relId) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- í†µê³„ (í™•ì¥) -->
            <div class="bg-white rounded-lg shadow-sm p-4 col-span-2">
              <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">ğŸ“Š í†µê³„</h3>
              <div class="grid grid-cols-6 gap-3 text-sm">
                <div class="p-3 bg-purple-50 rounded-lg text-center">
                  <div class="text-2xl font-bold text-purple-600">
                    {{ Object.keys(store.taxonomy.carriers).length - 1 }}
                  </div>
                  <div class="text-xs text-gray-500">ë³´í—˜ì‚¬</div>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg text-center">
                  <div class="text-2xl font-bold text-blue-600">
                    {{ Object.keys(store.taxonomy.products).length - 1 }}
                  </div>
                  <div class="text-xs text-gray-500">ìƒí’ˆ</div>
                </div>
                <div class="p-3 bg-green-50 rounded-lg text-center">
                  <div class="text-2xl font-bold text-green-600">{{ Object.keys(store.taxonomy.docTypes).length }}</div>
                  <div class="text-xs text-gray-500">ë¬¸ì„œìœ í˜•</div>
                </div>
                <div class="p-3 bg-orange-50 rounded-lg text-center">
                  <div class="text-2xl font-bold text-orange-600">
                    {{ Object.keys(store.taxonomy.processes).length - 1 }}
                  </div>
                  <div class="text-xs text-gray-500">í”„ë¡œì„¸ìŠ¤</div>
                </div>
                <div class="p-3 bg-cyan-50 rounded-lg text-center">
                  <div class="text-2xl font-bold text-cyan-600">
                    {{ Object.keys(store.taxonomy.audiences).length - 1 }}
                  </div>
                  <div class="text-xs text-gray-500">ì—­í• </div>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg text-center">
                  <div class="text-2xl font-bold text-indigo-600">{{ Object.keys(store.documents).length }}</div>
                  <div class="text-xs text-gray-500">ë¬¸ì„œ</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Timeline View (v2.1 ì‹ ê·œ) -->
        <div v-show="viewMode === 'timeline'" class="flex-1 overflow-auto p-4">
          <div class="max-w-4xl mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ“… ê·œì œ íƒ€ì„ë¼ì¸</h2>
            <div class="relative">
              <!-- íƒ€ì„ë¼ì¸ ì„  -->
              <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200"></div>

              <div v-for="(reg, idx) in store.taxonomy.regulationTimeline" :key="idx" class="relative pl-20 pb-8">
                <!-- ë…¸ë“œ -->
                <div
                  class="absolute left-6 w-5 h-5 rounded-full border-4"
                  :class="getRegulationStatusClass(reg.status)"
                ></div>

                <!-- ì¹´ë“œ -->
                <div class="bg-white rounded-lg shadow-sm p-4 border-l-4" :class="getRegulationBorderClass(reg.impact)">
                  <div class="flex items-start justify-between">
                    <div>
                      <span class="text-sm text-gray-500">{{ reg.date }}</span>
                      <h3 class="font-bold text-gray-800 mt-1">{{ reg.name }}</h3>
                      <p class="text-sm text-gray-600 mt-2">{{ reg.description }}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                      <span
                        class="text-xs px-2 py-1 rounded"
                        :class="reg.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'"
                      >
                        {{ reg.status === 'active' ? 'ì‹œí–‰ì¤‘' : 'ì˜ˆì •' }}
                      </span>
                      <span
                        v-if="reg.impact"
                        class="text-xs px-2 py-1 rounded"
                        :class="reg.impact === 'critical' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700'"
                      >
                        {{ reg.impact === 'critical' ? 'âš ï¸ ë§¤ìš°ì¤‘ìš”' : 'ì¤‘ìš”' }}
                      </span>
                      <span v-if="reg.status === 'upcoming'" class="text-xs text-gray-500">
                        D-{{ getDaysUntil(reg.date) }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard View -->
        <div v-show="viewMode === 'dashboard'" class="flex-1 overflow-auto p-4">
          <div class="max-w-6xl mx-auto space-y-4">

            <!-- ê±´ê°• ì ìˆ˜ í—¤ë” -->
            <div class="bg-white rounded-lg shadow-sm p-5">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-800">ë°ì´í„° í’ˆì§ˆ ëŒ€ì‹œë³´ë“œ</h2>
                <div class="flex items-center gap-3">
                  <span class="text-xs text-gray-400">ë§ˆì§€ë§‰ ê°±ì‹ : {{ formatDate(store.lastModified) }}</span>
                  <span class="text-sm font-bold px-3 py-1 rounded-full"
                    :class="dashboard.score >= 90 ? 'bg-green-100 text-green-700' : dashboard.score >= 70 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'">
                    {{ dashboard.score }}ì 
                  </span>
                </div>
              </div>
              <!-- ì ìˆ˜ ë°” -->
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="h-3 rounded-full transition-all duration-500"
                  :class="dashboard.score >= 90 ? 'bg-green-500' : dashboard.score >= 70 ? 'bg-yellow-500' : 'bg-red-500'"
                  :style="{ width: dashboard.score + '%' }"></div>
              </div>
              <div class="flex justify-between text-xs text-gray-400 mt-1">
                <span>0</span><span>50</span><span>100</span>
              </div>
            </div>

            <!-- í•µì‹¬ ì§€í‘œ 4ê°œ -->
            <div class="grid grid-cols-4 gap-3">
              <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-3xl font-bold text-indigo-600">{{ dashboard.totalDocs }}</div>
                <div class="text-xs text-gray-500 mt-1">ì „ì²´ ë¬¸ì„œ</div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-3xl font-bold" :class="dashboard.orphanCount === 0 ? 'text-green-600' : 'text-red-600'">
                  {{ dashboard.orphanCount }}
                </div>
                <div class="text-xs text-gray-500 mt-1">ê³ ì•„ ë¬¸ì„œ (ê´€ê³„ ì—†ìŒ)</div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-3xl font-bold" :class="dashboard.duplicateCount === 0 ? 'text-green-600' : 'text-red-600'">
                  {{ dashboard.duplicateCount }}
                </div>
                <div class="text-xs text-gray-500 mt-1">ìœ ë‹ˆí¬ ìœ„ë°˜</div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-4 text-center">
                <div class="text-3xl font-bold" :class="dashboard.brokenRefCount === 0 ? 'text-green-600' : 'text-orange-600'">
                  {{ dashboard.brokenRefCount }}
                </div>
                <div class="text-xs text-gray-500 mt-1">ëŠì–´ì§„ ì°¸ì¡°</div>
              </div>
            </div>

            <!-- ë¼ì´í”„ì‚¬ì´í´ + ì‹ ì„ ë„ + ë„ë©”ì¸ ë¶„í¬ -->
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm">ë¼ì´í”„ì‚¬ì´í´ ë¶„í¬</h3>
                <div class="space-y-2">
                  <div v-for="lc in dashboard.lifecycleDist" :key="lc.name">
                    <div class="flex justify-between text-xs mb-1">
                      <span :class="getLifecycleClass(lc.name)" class="px-1.5 py-0.5 rounded font-medium">{{ lc.name }}</span>
                      <span class="text-gray-600">{{ lc.count }}ê±´ ({{ lc.pct }}%)</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                      <div class="h-2 rounded-full bg-indigo-400" :style="{ width: lc.pct + '%' }"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm">ì‹ ì„ ë„ ë¶„í¬</h3>
                <div class="space-y-2">
                  <div v-for="f in dashboard.freshnessDist" :key="f.name">
                    <div class="flex justify-between text-xs mb-1">
                      <span :class="getFreshnessClass(f.name)" class="font-medium">{{ f.name }}</span>
                      <span class="text-gray-600">{{ f.count }}ê±´ ({{ f.pct }}%)</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                      <div class="h-2 rounded-full"
                        :class="f.name === 'FRESH' ? 'bg-green-400' : f.name === 'WARNING' ? 'bg-yellow-400' : 'bg-red-400'"
                        :style="{ width: f.pct + '%' }"></div>
                    </div>
                  </div>
                </div>
                <!-- ë§Œë£Œ ì„ë°• -->
                <div v-if="dashboard.expiringDocs.length > 0" class="mt-3 pt-3 border-t border-gray-100">
                  <div class="text-xs font-medium text-red-600 mb-1">ë§Œë£Œ ì„ë°• (7ì¼ ë‚´)</div>
                  <div v-for="ed in dashboard.expiringDocs" :key="ed.id" class="text-xs text-gray-600 py-0.5">
                    {{ ed.name }} <span class="text-red-500 font-bold">D-{{ ed.daysLeft }}</span>
                  </div>
                </div>
              </div>
              <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm">ë„ë©”ì¸ë³„ ë¬¸ì„œ ìˆ˜</h3>
                <div class="space-y-2">
                  <div v-for="dm in dashboard.domainDist" :key="dm.name">
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-700 font-medium">{{ dm.name }}</span>
                      <span class="text-gray-600">{{ dm.count }}ê±´</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                      <div class="h-2 rounded-full bg-purple-400" :style="{ width: dm.pct + '%' }"></div>
                    </div>
                  </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500">
                  SSOT ìœ„ë°˜: <span class="font-bold" :class="dashboard.ssotViolations > 0 ? 'text-red-600' : 'text-green-600'">{{ dashboard.ssotViolations }}ê±´</span>
                </div>
              </div>
            </div>

            <!-- ê´€ê³„ ê±´ê°•ë„ + Tier ë¶„í¬ -->
            <div class="grid grid-cols-2 gap-3">
              <!-- ê´€ê³„ ê±´ê°•ë„ -->
              <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm">ê´€ê³„ ê±´ê°•ë„</h3>
                <div class="space-y-2">
                  <div v-for="rel in dashboard.relationHealth" :key="rel.label">
                    <div class="flex justify-between text-xs mb-1">
                      <span class="text-gray-600">{{ rel.label }}</span>
                      <span class="font-medium" :class="rel.pct >= 50 ? 'text-green-600' : rel.pct >= 20 ? 'text-yellow-600' : 'text-red-600'">
                        {{ rel.count }}ê±´ ({{ rel.pct }}%)
                      </span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                      <div class="h-2 rounded-full transition-all"
                        :class="rel.pct >= 50 ? 'bg-green-400' : rel.pct >= 20 ? 'bg-yellow-400' : 'bg-red-400'"
                        :style="{ width: rel.pct + '%' }"></div>
                    </div>
                  </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500">
                  í‰ê·  ê´€ê³„ ìˆ˜: <span class="font-bold text-gray-700">{{ dashboard.avgRelations }}</span>ê°œ/ë¬¸ì„œ
                </div>
              </div>

              <!-- Tier ë¶„í¬ -->
              <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm">Tier ë¶„í¬</h3>
                <div class="space-y-3">
                  <div v-for="tier in dashboard.tierDist" :key="tier.name">
                    <div class="flex justify-between text-xs mb-1">
                      <span :class="tier.name === 'HOT' ? 'text-red-600 font-bold' : tier.name === 'WARM' ? 'text-orange-600 font-bold' : 'text-blue-600 font-bold'">
                        {{ tier.name }}
                      </span>
                      <span class="text-gray-600">{{ tier.count }}ê±´ ({{ tier.pct }}%)</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2.5">
                      <div class="h-2.5 rounded-full"
                        :class="tier.name === 'HOT' ? 'bg-red-400' : tier.name === 'WARM' ? 'bg-orange-400' : 'bg-blue-400'"
                        :style="{ width: tier.pct + '%' }"></div>
                    </div>
                  </div>
                </div>
                <!-- ë©”íƒ€ë°ì´í„° ì™„ì„±ë„ -->
                <h3 class="font-bold text-gray-800 mb-2 mt-4 text-sm">ë©”íƒ€ë°ì´í„° ì™„ì„±ë„</h3>
                <div class="space-y-1.5">
                  <div v-for="m in dashboard.metaCompleteness" :key="m.label" class="flex items-center gap-2">
                    <span class="w-16 text-xs text-gray-600">{{ m.label }}</span>
                    <div class="flex-1 bg-gray-100 rounded-full h-2">
                      <div class="h-2 rounded-full bg-indigo-400" :style="{ width: m.pct + '%' }"></div>
                    </div>
                    <span class="text-xs text-gray-500 w-10 text-right">{{ m.pct }}%</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- ë³´í—˜ì‚¬ë³„ ë¬¸ì„œ ë¶„í¬ -->
            <div class="bg-white rounded-lg shadow-sm p-4">
              <h3 class="font-bold text-gray-800 mb-3 text-sm">ë³´í—˜ì‚¬ë³„ ë¬¸ì„œ ë¶„í¬</h3>
              <div class="space-y-1.5">
                <div v-for="item in dashboard.carrierDist" :key="item.id" class="flex items-center gap-2">
                  <span class="w-28 text-xs text-gray-700 truncate" :title="item.name">{{ item.name }}</span>
                  <div class="flex-1 bg-gray-100 rounded-full h-4 relative">
                    <div class="h-4 rounded-full bg-purple-400 flex items-center justify-end pr-1.5"
                      :style="{ width: Math.max(item.pct, 2) + '%' }">
                      <span v-if="item.pct > 8" class="text-white text-xs font-medium">{{ item.count }}</span>
                    </div>
                    <span v-if="item.pct <= 8" class="absolute right-1 top-0.5 text-xs text-gray-500">{{ item.count }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- ë¬¸ì„œìœ í˜•ë³„ ë¶„í¬ + SUPERSEDES ì²´ì¸ -->
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm">ë¬¸ì„œìœ í˜•ë³„ ë¶„í¬</h3>
                <div class="space-y-1">
                  <div v-for="item in dashboard.docTypeDist" :key="item.id" class="flex items-center gap-2">
                    <span class="w-24 text-xs text-gray-700 truncate" :title="item.name">{{ item.name }}</span>
                    <div class="flex-1 bg-gray-100 rounded-full h-3">
                      <div class="h-3 rounded-full bg-green-400" :style="{ width: Math.max(item.pct, 1) + '%' }"></div>
                    </div>
                    <span class="text-xs text-gray-500 w-12 text-right">{{ item.count }}ê±´</span>
                  </div>
                </div>
              </div>

              <div class="bg-white rounded-lg shadow-sm p-4">
                <h3 class="font-bold text-gray-800 mb-3 text-sm">ìƒí’ˆ ê°œí¸ (SUPERSEDES) ì²´ì¸</h3>
                <div v-if="dashboard.supersedesChains.length === 0" class="text-sm text-gray-400">ê°œí¸ ê´€ê³„ ì—†ìŒ</div>
                <div v-else class="space-y-2">
                  <div v-for="(chain, idx) in dashboard.supersedesChains" :key="idx"
                    class="p-2 bg-amber-50 rounded border border-amber-200">
                    <div class="flex items-center gap-1 flex-wrap">
                      <template v-for="(pid, ci) in chain" :key="pid">
                        <span class="text-xs px-1.5 py-0.5 bg-white rounded border"
                          :class="ci === 0 ? 'border-amber-400 font-bold' : 'border-gray-200'">
                          {{ getProductName(pid) }}
                        </span>
                        <span v-if="ci < chain.length - 1" class="text-gray-400 text-xs">&rarr;</span>
                      </template>
                    </div>
                  </div>
                </div>
                <!-- ë³¸ë¬¸ ì±„ì›€ë¥  -->
                <h3 class="font-bold text-gray-800 mb-2 mt-4 text-sm">ë³¸ë¬¸ ì±„ì›€ë¥ </h3>
                <div class="flex items-center gap-3">
                  <div class="flex-1 bg-gray-100 rounded-full h-3">
                    <div class="h-3 rounded-full bg-teal-400" :style="{ width: dashboard.contentFillPct + '%' }"></div>
                  </div>
                  <span class="text-sm font-bold" :class="dashboard.contentFillPct > 50 ? 'text-teal-600' : 'text-red-600'">
                    {{ dashboard.contentFillPct }}%
                  </span>
                </div>
                <div class="text-xs text-gray-400 mt-1">
                  {{ dashboard.contentFilledCount }} / {{ dashboard.totalDocs }}ê°œ ë¬¸ì„œì— ë³¸ë¬¸ ìˆìŒ
                </div>
              </div>
            </div>

            <!-- ë¬¸ì œ ëª©ë¡ -->
            <div v-if="dashboard.issues.length > 0" class="bg-white rounded-lg shadow-sm p-4">
              <h3 class="font-bold text-gray-800 mb-3 text-sm">ë°œê²¬ëœ ë¬¸ì œ ({{ dashboard.issues.length }}ê±´)</h3>
              <div class="space-y-1.5 max-h-60 overflow-auto scrollbar-thin">
                <div v-for="(issue, idx) in dashboard.issues" :key="idx"
                  class="flex items-start gap-2 text-xs p-2 rounded"
                  :class="issue.severity === 'error' ? 'bg-red-50' : issue.severity === 'warning' ? 'bg-yellow-50' : 'bg-blue-50'">
                  <span :class="issue.severity === 'error' ? 'text-red-500' : issue.severity === 'warning' ? 'text-orange-500' : 'text-blue-500'">
                    {{ issue.severity === 'error' ? '!!!' : issue.severity === 'warning' ? '!!' : 'i' }}
                  </span>
                  <span class="text-gray-700">{{ issue.message }}</span>
                </div>
              </div>
            </div>
            <div v-else class="bg-green-50 rounded-lg shadow-sm p-4 text-center">
              <span class="text-green-600 font-medium text-sm">ëª¨ë“  ê²€ì¦ í†µê³¼ - ë°ì´í„° í’ˆì§ˆ ì–‘í˜¸</span>
            </div>

          </div>
        </div>

        <!-- Status Bar -->
        <div class="h-8 bg-gray-100 border-t border-gray-200 flex items-center px-4 text-xs text-gray-600">
          <span>ë¬¸ì„œ: {{ Object.keys(store.documents).length }}ê°œ</span>
          <span class="mx-2">|</span>
          <span class="text-green-600">ACTIVE: {{ lifecycleCounts.ACTIVE || 0 }}</span>
          <span class="mx-1 text-orange-600">STALE: {{ lifecycleCounts.STALE || 0 }}</span>
          <span class="mx-1 text-gray-500">DRAFT: {{ lifecycleCounts.DRAFT || 0 }}</span>
          <span class="mx-2">|</span>
          <span :class="duplicateGroups.length > 0 ? 'text-red-600 font-medium' : 'text-green-600'">
            ì¤‘ë³µ: {{ duplicateGroups.length }}ê±´
          </span>
          <span class="mx-2">|</span>
          <span v-if="highlightedDocs.length > 0" class="text-blue-600">
            ì „íŒŒëœ ë¬¸ì„œ: {{ highlightedDocs.length }}ê°œ
          </span>
          <span class="ml-auto text-gray-400">v{{ store.version }} | {{ formatDate(store.lastModified) }}</span>
        </div>
      </main>

      <!-- RIGHT PANEL -->
      <aside
        v-show="selectedDocId || selectedTaxonomy.type"
        class="w-80 bg-white border-l border-gray-200 flex flex-col"
      >
        <!-- Process Detail -->
        <div v-if="selectedTaxonomy.type === 'process'" class="flex-1 overflow-y-auto scrollbar-thin">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-bold text-gray-800">í”„ë¡œì„¸ìŠ¤ ë©”íƒ€</h2>
            <button @click="clearSelection" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div v-if="store.taxonomy.processes[selectedTaxonomy.id]" class="p-4 space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-500">ID</label>
              <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">í”„ë¡œì„¸ìŠ¤ëª…</label>
              <input
                type="text"
                v-model="store.taxonomy.processes[selectedTaxonomy.id].name"
                @change="saveStore"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ìˆœì„œ</label>
              <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">
                {{ store.taxonomy.processes[selectedTaxonomy.id].order }}
              </div>
            </div>
            <div class="border-t border-gray-100 pt-4">
              <label class="text-xs font-medium text-gray-500"
                >ê´€ë ¨ ë¬¸ì„œ ({{ getDocCountByProcess(selectedTaxonomy.id) }}ê±´)</label
              >
              <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                <div
                  v-for="(doc, docId) in getDocsByProcess(selectedTaxonomy.id)"
                  :key="docId"
                  @click="selectDocument(docId)"
                  class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-orange-50 transition text-sm"
                >
                  {{ doc.name }}
                </div>
                <div v-if="getDocCountByProcess(selectedTaxonomy.id) === 0" class="text-sm text-gray-400 py-2">
                  ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Audience Detail -->
        <div v-else-if="selectedTaxonomy.type === 'audience'" class="flex-1 overflow-y-auto scrollbar-thin">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-bold text-gray-800">ì—­í•  ë©”íƒ€</h2>
            <button @click="clearSelection" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div v-if="store.taxonomy.audiences[selectedTaxonomy.id]" class="p-4 space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-500">ID</label>
              <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ì—­í• ëª…</label>
              <input
                type="text"
                v-model="store.taxonomy.audiences[selectedTaxonomy.id].name"
                @change="saveStore"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ë ˆë²¨</label>
              <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">
                {{ store.taxonomy.audiences[selectedTaxonomy.id].level }}
              </div>
            </div>
            <div class="border-t border-gray-100 pt-4">
              <label class="text-xs font-medium text-gray-500"
                >ê´€ë ¨ ë¬¸ì„œ ({{ getDocCountByAudience(selectedTaxonomy.id) }}ê±´)</label
              >
              <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                <div
                  v-for="(doc, docId) in getDocsByAudience(selectedTaxonomy.id)"
                  :key="docId"
                  @click="selectDocument(docId)"
                  class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-cyan-50 transition text-sm"
                >
                  {{ doc.name }}
                </div>
                <div v-if="getDocCountByAudience(selectedTaxonomy.id) === 0" class="text-sm text-gray-400 py-2">
                  ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Carrier Detail -->
        <div v-else-if="selectedTaxonomy.type === 'carrier'" class="flex-1 overflow-y-auto scrollbar-thin">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-bold text-gray-800">ë³´í—˜ì‚¬ ë©”íƒ€</h2>
            <button @click="clearSelection" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div v-if="store.taxonomy.carriers[selectedTaxonomy.id]" class="p-4 space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-500">ID</label>
              <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬ëª…</label>
              <input
                type="text"
                v-model="store.taxonomy.carriers[selectedTaxonomy.id].name"
                @change="saveStore"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div v-if="store.taxonomy.carriers[selectedTaxonomy.id].type">
              <label class="text-xs font-medium text-gray-500">êµ¬ë¶„</label>
              <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">
                {{ store.taxonomy.carriers[selectedTaxonomy.id].type === 'life' ? 'ìƒëª…ë³´í—˜' : 'ì†í•´ë³´í—˜' }}
              </div>
            </div>
            <div v-if="(store.taxonomy.carriers[selectedTaxonomy.id].alias || []).length > 0">
              <label class="text-xs font-medium text-gray-500">ë³„ì¹­</label>
              <div class="flex flex-wrap gap-1 mt-1">
                <span
                  v-for="a in store.taxonomy.carriers[selectedTaxonomy.id].alias"
                  :key="a"
                  class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded"
                  >{{ a }}</span
                >
              </div>
            </div>
            <div class="border-t border-gray-100 pt-4">
              <label class="text-xs font-medium text-gray-500">í†µê³„</label>
              <div class="grid grid-cols-3 gap-2 mt-2">
                <div class="p-2 bg-purple-50 rounded text-center">
                  <div class="text-lg font-bold text-purple-600">{{ getDocCountByCarrier(selectedTaxonomy.id) }}</div>
                  <div class="text-xs text-gray-500">ë¬¸ì„œ</div>
                </div>
                <div class="p-2 bg-red-50 rounded text-center">
                  <div class="text-lg font-bold text-red-600">
                    {{ getDocCountByCarrierTier(selectedTaxonomy.id, 'HOT') }}
                  </div>
                  <div class="text-xs text-gray-500">HOT</div>
                </div>
                <div class="p-2 bg-yellow-50 rounded text-center">
                  <div class="text-lg font-bold text-yellow-600">
                    {{ getDocCountByCarrierTier(selectedTaxonomy.id, 'WARM') }}
                  </div>
                  <div class="text-xs text-gray-500">WARM</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Detail -->
        <div v-else-if="selectedTaxonomy.type === 'product'" class="flex-1 overflow-y-auto scrollbar-thin">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-bold text-gray-800">ìƒí’ˆ ë©”íƒ€</h2>
            <button @click="clearSelection" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div v-if="store.taxonomy.products[selectedTaxonomy.id]" class="p-4 space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-500">ID</label>
              <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ìƒí’ˆëª…</label>
              <input
                type="text"
                v-model="store.taxonomy.products[selectedTaxonomy.id].name"
                @change="saveStore"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ì¹´í…Œê³ ë¦¬</label>
              <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">
                {{ store.taxonomy.productCategories?.[store.taxonomy.products[selectedTaxonomy.id].category]?.name ||
                store.taxonomy.products[selectedTaxonomy.id].category }}
              </div>
            </div>
            <div
              v-if="store.taxonomy.products[selectedTaxonomy.id].requires_license"
              class="p-2 bg-orange-50 rounded border border-orange-200"
            >
              <div class="text-xs font-medium text-orange-700">
                ìê²© í•„ìš”: {{ store.taxonomy.products[selectedTaxonomy.id].requires_license }}
              </div>
            </div>
            <div v-if="(store.taxonomy.products[selectedTaxonomy.id].alias || []).length > 0">
              <label class="text-xs font-medium text-gray-500">ë³„ì¹­</label>
              <div class="flex flex-wrap gap-1 mt-1">
                <span
                  v-for="a in store.taxonomy.products[selectedTaxonomy.id].alias"
                  :key="a"
                  class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded"
                  >{{ a }}</span
                >
              </div>
            </div>

            <!-- Supersedes ê´€ê³„ -->
            <div class="border-t border-gray-100 pt-4">
              <label class="text-xs font-medium text-gray-500">ì´ì „ ìƒí’ˆ (supersedes)</label>
              <div v-if="store.taxonomy.products[selectedTaxonomy.id].supersedes" class="mt-1">
                <span
                  @click="selectTaxonomy('product', store.taxonomy.products[selectedTaxonomy.id].supersedes)"
                  class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs cursor-pointer hover:bg-amber-200"
                >
                  {{ getProductName(store.taxonomy.products[selectedTaxonomy.id].supersedes) }}
                  <button @click.stop="removeSupersedes" class="hover:text-red-500">&times;</button>
                </span>
              </div>
              <select
                @change="setSupersedes($event)"
                class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="">
                  {{ store.taxonomy.products[selectedTaxonomy.id].supersedes ? 'ë³€ê²½' : '+ ì´ì „ ìƒí’ˆ ì„¤ì •' }}
                </option>
                <option
                  v-for="(p, id) in store.taxonomy.products"
                  :key="id"
                  :value="id"
                  v-show="id !== selectedTaxonomy.id && id !== 'PRD-COMMON'"
                >
                  {{ p.name }}
                </option>
              </select>
            </div>

            <!-- ì´ ìƒí’ˆì„ ëŒ€ì²´í•œ ì‹ ê·œ ìƒí’ˆ -->
            <div v-if="getSupersededBy(selectedTaxonomy.id).length > 0">
              <label class="text-xs font-medium text-gray-500">í›„ì† ìƒí’ˆ</label>
              <div class="flex flex-wrap gap-1 mt-1">
                <span
                  v-for="newPrdId in getSupersededBy(selectedTaxonomy.id)"
                  :key="newPrdId"
                  @click="selectTaxonomy('product', newPrdId)"
                  class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs cursor-pointer hover:bg-green-200"
                >
                  {{ getProductName(newPrdId) }}
                </span>
              </div>
            </div>

            <div class="border-t border-gray-100 pt-4">
              <label class="text-xs font-medium text-gray-500"
                >ê´€ë ¨ ë¬¸ì„œ ({{ getDocCountByProduct(selectedTaxonomy.id) }}ê±´)</label
              >
              <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                <div
                  v-for="(doc, docId) in getDocsByProduct(selectedTaxonomy.id)"
                  :key="docId"
                  @click="selectDocument(docId)"
                  class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-blue-50 transition text-sm"
                >
                  {{ doc.name }}
                </div>
                <div v-if="getDocCountByProduct(selectedTaxonomy.id) === 0" class="text-sm text-gray-400 py-2">
                  ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- DocType Detail -->
        <div v-else-if="selectedTaxonomy.type === 'docType'" class="flex-1 overflow-y-auto scrollbar-thin">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-bold text-gray-800">ë¬¸ì„œìœ í˜• ë©”íƒ€</h2>
            <button @click="clearSelection" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div v-if="store.taxonomy.docTypes[selectedTaxonomy.id]" class="p-4 space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-500">ID</label>
              <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•ëª…</label>
              <input
                type="text"
                v-model="store.taxonomy.docTypes[selectedTaxonomy.id].name"
                @change="saveStore"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">Tier</label>
              <div
                :class="getTierClass(store.taxonomy.docTypes[selectedTaxonomy.id].tier)"
                class="mt-1 px-3 py-2 rounded-lg text-sm text-center font-medium"
              >
                {{ store.taxonomy.docTypes[selectedTaxonomy.id].tier }}
              </div>
            </div>
            <div class="border-t border-gray-100 pt-4">
              <label class="text-xs font-medium text-gray-500"
                >í•´ë‹¹ ìœ í˜• ë¬¸ì„œ ({{ getDocCountByDocType(selectedTaxonomy.id) }}ê±´)</label
              >
              <div class="mt-2 space-y-1 max-h-60 overflow-y-auto">
                <div
                  v-for="(doc, docId) in getDocsByDocType(selectedTaxonomy.id)"
                  :key="docId"
                  @click="selectDocument(docId)"
                  class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-green-50 transition text-sm"
                >
                  {{ doc.name }}
                </div>
                <div v-if="getDocCountByDocType(selectedTaxonomy.id) === 0" class="text-sm text-gray-400 py-2">
                  ë“±ë¡ëœ ë¬¸ì„œ ì—†ìŒ
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Certification Detail -->
        <div v-else-if="selectedTaxonomy.type === 'certification'" class="flex-1 overflow-y-auto scrollbar-thin">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-bold text-gray-800">ìê²©ì¦ ë©”íƒ€</h2>
            <button @click="clearSelection" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div v-if="store.taxonomy.certifications[selectedTaxonomy.id]" class="p-4 space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-500">ID</label>
              <div class="text-sm text-gray-800 font-mono bg-gray-50 p-2 rounded mt-1">{{ selectedTaxonomy.id }}</div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ìê²©ì¦ëª…</label>
              <input
                type="text"
                v-model="store.taxonomy.certifications[selectedTaxonomy.id].name"
                @change="saveStore"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div v-if="store.taxonomy.certifications[selectedTaxonomy.id].level">
              <label class="text-xs font-medium text-gray-500">ë“±ê¸‰</label>
              <div class="text-sm text-gray-800 bg-gray-50 p-2 rounded mt-1">
                {{ store.taxonomy.certifications[selectedTaxonomy.id].level }}
              </div>
            </div>
            <div class="border-t border-gray-100 pt-4">
              <label class="text-xs font-medium text-gray-500">ê´€ë ¨ ìƒí’ˆ</label>
              <div class="mt-2 space-y-1 max-h-40 overflow-y-auto">
                <div
                  v-for="(prd, prdId) in getProductsByCertification(selectedTaxonomy.id)"
                  :key="prdId"
                  @click="selectTaxonomy('product', prdId)"
                  class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-pink-50 transition text-sm"
                >
                  {{ prd.name }}
                </div>
                <div
                  v-if="Object.keys(getProductsByCertification(selectedTaxonomy.id)).length === 0"
                  class="text-sm text-gray-400 py-2"
                >
                  ì—°ê²°ëœ ìƒí’ˆ ì—†ìŒ
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Document Detail -->
        <div v-else-if="selectedDocId" class="flex-1 overflow-y-auto scrollbar-thin">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-bold text-gray-800">ë¬¸ì„œ ìƒì„¸</h2>
            <button @click="clearSelection" class="text-gray-400 hover:text-gray-600">&times;</button>
          </div>

          <div v-if="selectedDoc" class="p-4 space-y-4">
            <!-- ë¼ì´í”„ì‚¬ì´í´ ìƒíƒœ -->
            <div>
              <label class="text-xs font-medium text-gray-500">ë¼ì´í”„ì‚¬ì´í´</label>
              <div class="mt-1 flex items-center gap-2">
                <span :class="getLifecycleClass(selectedDoc.lifecycle || 'ACTIVE')" class="text-xs px-3 py-1.5 rounded-lg font-bold">
                  {{ selectedDoc.lifecycle || 'ACTIVE' }}
                </span>
                <button v-for="next in getNextLifecycleStates(selectedDoc.lifecycle || 'ACTIVE')" :key="next"
                  @click="transitionLifecycle(selectedDocId, next)"
                  class="text-xs px-2 py-1 border border-gray-300 rounded hover:bg-gray-100 transition">
                  &rarr; {{ next }}
                </button>
              </div>
            </div>

            <!-- ì‹ ì„ ë„ ë°” -->
            <div>
              <label class="text-xs font-medium text-gray-500">ì‹ ì„ ë„</label>
              <div class="mt-1">
                <div class="flex justify-between text-xs mb-1">
                  <span :class="getFreshnessClass(calcFreshness(selectedDoc).status)" class="font-medium">{{ calcFreshness(selectedDoc).status }}</span>
                  <span class="text-gray-500">{{ calcFreshness(selectedDoc).daysSince }}ì¼ / {{ calcFreshness(selectedDoc).maxDays }}ì¼</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="h-2 rounded-full transition-all"
                    :class="calcFreshness(selectedDoc).status === 'FRESH' ? 'bg-green-500' : calcFreshness(selectedDoc).status === 'WARNING' ? 'bg-yellow-500' : 'bg-red-500'"
                    :style="{ width: Math.min(100, calcFreshness(selectedDoc).pct) + '%' }"></div>
                </div>
              </div>
            </div>

            <!-- ë„ë©”ì¸ + ë²„ì „ + ID -->
            <div>
              <label class="text-xs font-medium text-gray-500">ë„ë©”ì¸</label>
              <select
                :value="selectedDoc.domain || 'GA-SALES'"
                @change="showMoveConfirm(selectedDocId, $event.target.value); $event.target.value = selectedDoc.domain || 'GA-SALES'"
                class="w-full mt-1 px-3 py-2 border border-indigo-200 rounded-lg text-sm bg-indigo-50"
              >
                <option v-for="(d, id) in store.domains" :key="id" :value="id">{{ d.name }}</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-medium text-gray-500">ë¬¸ì„œ ID</label>
                <div class="mt-1 px-3 py-2 bg-gray-50 rounded-lg text-xs text-gray-500 font-mono">
                  {{ selectedDocId }}
                </div>
              </div>
              <div>
                <label class="text-xs font-medium text-gray-500">ë²„ì „</label>
                <div class="mt-1 px-3 py-2 bg-gray-50 rounded-lg text-sm text-gray-700">
                  v{{ typeof selectedDoc.version === 'object' ? selectedDoc.version.major + '.' + selectedDoc.version.minor : selectedDoc.version || '1.0' }}
                </div>
              </div>
            </div>

            <div>
              <label class="text-xs font-medium text-gray-500">ë¬¸ì„œëª…</label>
              <input
                type="text"
                v-model="selectedDoc.name"
                @change="saveStore"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>

            <div class="grid grid-cols-2 gap-3" v-if="domainHasFacet(selectedDoc.domain || 'GA-SALES', 'carrier') || domainHasFacet(selectedDoc.domain || 'GA-SALES', 'product')">
              <div v-if="domainHasFacet(selectedDoc.domain || 'GA-SALES', 'carrier')">
                <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬</label>
                <select
                  :value="getDocCarrier(selectedDoc)"
                  @change="setDocClassification(selectedDoc, 'carrier', $event.target.value); saveStore()"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
                </select>
              </div>
              <div v-if="domainHasFacet(selectedDoc.domain || 'GA-SALES', 'product')">
                <label class="text-xs font-medium text-gray-500">ìƒí’ˆ</label>
                <select
                  :value="getDocProduct(selectedDoc)"
                  @change="setDocClassification(selectedDoc, 'product', $event.target.value); saveStore()"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                </select>
              </div>
            </div>

            <div>
              <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•</label>
              <select
                :value="getDocDocType(selectedDoc)"
                @change="setDocClassification(selectedDoc, 'docType', $event.target.value); saveStore()"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
              </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-medium text-gray-500">í”„ë¡œì„¸ìŠ¤</label>
                <select
                  :value="getDocMeta(selectedDoc, 'process')"
                  @change="setDocMeta(selectedDoc, 'process', $event.target.value); saveStore()"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">ë¯¸ì§€ì •</option>
                  <option v-for="(p, id) in store.taxonomy.processes" :key="id" :value="id">{{ p.name }}</option>
                </select>
              </div>
              <div>
                <label class="text-xs font-medium text-gray-500">ëŒ€ìƒì—­í• </label>
                <select
                  :value="getDocMeta(selectedDoc, 'audience')"
                  @change="setDocMeta(selectedDoc, 'audience', $event.target.value); saveStore()"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">ë¯¸ì§€ì •</option>
                  <option v-for="(a, id) in store.taxonomy.audiences" :key="id" :value="id">{{ a.name }}</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-medium text-gray-500">Tier</label>
                <div :class="getTierClass(selectedDoc.tier)" class="mt-1 px-3 py-2 rounded-lg text-sm text-center font-medium">
                  {{ selectedDoc.tier }}
                </div>
              </div>
              <div>
                <label class="text-xs font-medium text-gray-500">ë¦¬ë·°ì¼</label>
                <div class="mt-1 px-3 py-2 bg-gray-50 rounded-lg text-xs text-gray-600">
                  {{ selectedDoc.reviewedAt ? formatDate(selectedDoc.reviewedAt) : 'ë¯¸ë¦¬ë·°' }}
                </div>
              </div>
            </div>

            <!-- Relations -->
            <div class="border-t border-gray-100 pt-4">
              <h3 class="text-sm font-bold text-gray-700 mb-3">ê´€ê³„ ì„¤ì •</h3>

              <!-- Parent -->
              <div class="mb-3">
                <label class="text-xs font-medium text-gray-500"
                  >ë¶€ëª¨ ë¬¸ì„œ <span class="text-gray-400 font-normal">ê°™ì€ ë³´í—˜ì‚¬/ìƒí’ˆ</span></label
                >
                <div v-if="selectedDoc.relations?.parent" class="mt-1">
                  <span
                    @click="selectDocument(selectedDoc.relations.parent)"
                    class="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs cursor-pointer hover:bg-indigo-200"
                  >
                    {{ getDocName(selectedDoc.relations.parent) }}
                    <button @click.stop="removeParent" class="hover:text-red-500">&times;</button>
                  </span>
                </div>
                <select
                  @change="setParent($event)"
                  class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">{{ selectedDoc.relations?.parent ? 'ë¶€ëª¨ ë³€ê²½' : '+ ë¶€ëª¨ ì„¤ì •' }}</option>
                  <option v-for="(doc, id) in availableParents" :key="id" :value="id">{{ doc.name }}</option>
                </select>
              </div>

              <!-- Children -->
              <div class="mb-3">
                <label class="text-xs font-medium text-gray-500"
                  >ìì‹ ë¬¸ì„œ <span class="text-gray-400 font-normal">ê°™ì€ ë³´í—˜ì‚¬/ìƒí’ˆ</span></label
                >
                <div class="flex flex-wrap gap-1 mt-1">
                  <span
                    v-for="childId in selectedDoc.relations?.children || []"
                    :key="childId"
                    @click="selectDocument(childId)"
                    class="inline-flex items-center gap-1 px-2 py-1 bg-violet-100 text-violet-700 rounded text-xs cursor-pointer hover:bg-violet-200"
                  >
                    {{ getDocName(childId) }}
                    <button @click.stop="removeChild(childId)" class="hover:text-red-500">&times;</button>
                  </span>
                </div>
                <select
                  @change="addChild($event)"
                  class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">+ ìì‹ ì¶”ê°€</option>
                  <option v-for="(doc, id) in availableChildren" :key="id" :value="id">{{ doc.name }}</option>
                </select>
              </div>

              <!-- Siblings -->
              <div class="mb-3">
                <label class="text-xs font-medium text-gray-500"
                  >í˜•ì œ ë¬¸ì„œ <span class="text-gray-400 font-normal">ê°™ì€ ë³´í—˜ì‚¬/ìƒí’ˆ, ì–‘ë°©í–¥</span></label
                >
                <div class="flex flex-wrap gap-1 mt-1">
                  <span
                    v-for="sibId in selectedDoc.relations?.siblings || []"
                    :key="sibId"
                    @click="selectDocument(sibId)"
                    class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded text-xs cursor-pointer hover:bg-green-200"
                  >
                    {{ getDocName(sibId) }}
                    <button @click.stop="removeSiblingRelation(sibId)" class="hover:text-red-500">&times;</button>
                  </span>
                </div>
                <select
                  @change="addSiblingRelation($event)"
                  class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">+ í˜•ì œ ì¶”ê°€</option>
                  <option v-for="(doc, id) in availableSiblings" :key="id" :value="id">{{ doc.name }}</option>
                </select>
              </div>

              <!-- References -->
              <div>
                <label class="text-xs font-medium text-gray-500"
                  >ì°¸ì¡° ë¬¸ì„œ <span class="text-gray-400 font-normal">ì „ì²´, ë‹¨ë°©í–¥</span></label
                >
                <div class="flex flex-wrap gap-1 mt-1">
                  <span
                    v-for="refId in selectedDoc.relations?.references || []"
                    :key="refId"
                    @click="selectDocument(refId)"
                    class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs cursor-pointer hover:bg-gray-200"
                  >
                    {{ getDocName(refId) }}
                    <button @click.stop="removeReference(refId)" class="hover:text-red-500">&times;</button>
                  </span>
                </div>
                <select
                  @change="addReference($event)"
                  class="w-full mt-2 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">+ ì°¸ì¡° ì¶”ê°€</option>
                  <option v-for="(doc, id) in availableReferences" :key="id" :value="id">{{ doc.name }}</option>
                </select>
              </div>
            </div>
          </div>

          <div class="p-3 border-t border-gray-100 flex gap-2">
            <button
              @click="highlightRelatedDocs"
              class="flex-1 py-2 px-3 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-xs font-medium"
            >
              ì „íŒŒ í™•ì¸
            </button>
            <button
              @click="deleteDocument(selectedDocId)"
              class="py-2 px-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-xs font-medium"
            >
              ì‚­ì œ
            </button>
          </div>
        </div>
      </aside>

      <!-- Add Taxonomy Modal -->
      <div
        v-if="modal.show"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
        @click.self="modal.show = false"
      >
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
          <h3 class="text-lg font-bold mb-4">{{ modal.title }}</h3>
          <div class="space-y-3">
            <div>
              <label class="text-xs font-medium text-gray-500">ID</label>
              <input
                type="text"
                v-model="modal.data.id"
                :placeholder="modal.type === 'carrier' ? 'ì˜ˆ: INS-KB' : 'ì˜ˆ: PRD-CHILD-NEW'"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ì´ë¦„</label>
              <input
                type="text"
                v-model="modal.data.name"
                :placeholder="modal.type === 'carrier' ? 'ì˜ˆ: KBì†í•´ë³´í—˜' : 'ì˜ˆ: ë“ ë“  ì–´ë¦°ì´ë³´í—˜ ë¦¬ë‰´ì–¼'"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>
            <div v-if="modal.type === 'carrier'">
              <label class="text-xs font-medium text-gray-500">êµ¬ë¶„</label>
              <select
                v-model="modal.data.insurerType"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="life">ìƒëª…ë³´í—˜</option>
                <option value="non-life">ì†í•´ë³´í—˜</option>
              </select>
            </div>
            <div v-if="modal.type === 'product'">
              <label class="text-xs font-medium text-gray-500">ì¹´í…Œê³ ë¦¬</label>
              <select
                v-model="modal.data.category"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option v-for="(cat, key) in store.taxonomy.productCategories" :key="key" :value="key">
                  {{ cat.name }}
                </option>
              </select>
            </div>
            <div v-if="modal.type === 'product'">
              <label class="text-xs font-medium text-gray-500">ì´ì „ ìƒí’ˆ (ìƒí’ˆ ê°œí¸ ì‹œ)</label>
              <select
                v-model="modal.data.supersedes"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="">ì—†ìŒ</option>
                <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id" v-show="id !== 'PRD-COMMON'">
                  {{ p.name }}
                </option>
              </select>
              <div v-if="modal.data.supersedes" class="mt-1 text-xs text-amber-600">
                ì´ ìƒí’ˆì€ {{ getProductName(modal.data.supersedes) }}ì˜ í›„ì† ìƒí’ˆìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤
              </div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button
              @click="modal.show = false"
              class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium"
            >
              ì·¨ì†Œ
            </button>
            <button
              @click="addTaxonomy"
              class="flex-1 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium"
            >
              ì¶”ê°€
            </button>
          </div>
        </div>
      </div>

      <!-- Add Document Modal -->
      <div
        v-if="docModal.show"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
        @click.self="docModal.show = false"
      >
        <div class="bg-white rounded-xl shadow-2xl w-[500px] p-6">
          <h3 class="text-lg font-bold mb-4">ìƒˆ ë¬¸ì„œ ìƒì„±</h3>
          <div class="space-y-3">
            <!-- ë„ë©”ì¸ ì„ íƒ (í•„ìˆ˜ â€” facets ê²°ì •) -->
            <div>
              <label class="text-xs font-medium text-gray-500">ë„ë©”ì¸</label>
              <select
                v-model="docModal.data.domain"
                @change="onDocModalDomainChange"
                class="w-full mt-1 px-3 py-2 border border-indigo-300 rounded-lg text-sm bg-indigo-50"
              >
                <option v-for="(d, id) in store.domains" :key="id" :value="id">{{ d.name }}</option>
              </select>
              <div class="mt-1 text-xs text-gray-400">
                SSOT: {{ (store.domains[docModal.data.domain]?.ssotKey || []).join(' Ã— ') }}
              </div>
            </div>

            <!-- ë³´í—˜ì‚¬/ìƒí’ˆ (ë„ë©”ì¸ facetsì— ë”°ë¼ í‘œì‹œ) -->
            <div class="grid grid-cols-2 gap-3" v-if="domainHasFacet(docModal.data.domain, 'carrier') || domainHasFacet(docModal.data.domain, 'product')">
              <div v-if="domainHasFacet(docModal.data.domain, 'carrier')">
                <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬</label>
                <select
                  v-model="docModal.data.carrier"
                  @change="checkDocModalDuplicate"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">ì„ íƒ</option>
                  <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
                </select>
              </div>
              <div v-if="domainHasFacet(docModal.data.domain, 'product')">
                <label class="text-xs font-medium text-gray-500">ìƒí’ˆ</label>
                <select
                  v-model="docModal.data.product"
                  @change="checkDocModalDuplicate"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">ì„ íƒ</option>
                  <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
                </select>
              </div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•</label>
              <select
                v-model="docModal.data.docType"
                @change="checkDocModalDuplicate"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="">ì„ íƒ</option>
                <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-medium text-gray-500">í”„ë¡œì„¸ìŠ¤</label>
                <select
                  v-model="docModal.data.process"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">ë¯¸ì§€ì •</option>
                  <option v-for="(p, id) in store.taxonomy.processes" :key="id" :value="id">{{ p.name }}</option>
                </select>
              </div>
              <div>
                <label class="text-xs font-medium text-gray-500">ëŒ€ìƒì—­í• </label>
                <select
                  v-model="docModal.data.audience"
                  class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                >
                  <option value="">ë¯¸ì§€ì •</option>
                  <option v-for="(a, id) in store.taxonomy.audiences" :key="id" :value="id">{{ a.name }}</option>
                </select>
              </div>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-500">ë¬¸ì„œëª… (ì„ íƒ)</label>
              <input
                type="text"
                v-model="docModal.data.name"
                placeholder="ìë™ ìƒì„±ë¨"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              />
            </div>

            <!-- ì¤‘ë³µ ê²½ê³  -->
            <div v-if="docModal.duplicateWarning" class="p-3 bg-red-50 border border-red-200 rounded-lg">
              <div class="text-sm font-medium text-red-700">âš ï¸ ì¤‘ë³µ ë¬¸ì„œ ì¡´ì¬!</div>
              <div class="text-xs text-red-600 mt-1">{{ docModal.duplicateWarning }}</div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button
              @click="docModal.show = false"
              class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium"
            >
              ì·¨ì†Œ
            </button>
            <button
              @click="createDocument"
              :disabled="docModal.duplicateWarning"
              :class="docModal.duplicateWarning ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'"
              class="flex-1 py-2 text-white rounded-lg text-sm font-medium"
            >
              ìƒì„±
            </button>
          </div>
        </div>
      </div>

      <!-- Upload Auto-Classification Modal -->
      <div
        v-if="uploadPreview.show"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
        @click.self="uploadPreview.show = false"
      >
        <div class="bg-white rounded-xl shadow-2xl w-[520px] p-6">
          <h3 class="text-lg font-bold mb-2">ìë™ ë¶„ë¥˜ ê²°ê³¼</h3>
          <div class="text-sm text-gray-500 mb-4">íŒŒì¼: {{ uploadPreview.filename }}</div>

          <div class="space-y-3">
            <div>
              <div class="flex items-center justify-between">
                <label class="text-xs font-medium text-gray-500">ë³´í—˜ì‚¬</label>
                <span
                  v-if="uploadPreview.confidence.carrier"
                  class="text-xs px-1.5 py-0.5 rounded"
                  :class="uploadPreview.confidence.carrier >= 0.8 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'"
                >
                  {{ Math.round(uploadPreview.confidence.carrier * 100) }}%
                </span>
              </div>
              <select
                v-model="uploadPreview.data.carrier"
                @change="checkUploadDuplicate"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="">ë¯¸ë§¤ì¹­</option>
                <option v-for="(c, id) in store.taxonomy.carriers" :key="id" :value="id">{{ c.name }}</option>
              </select>
            </div>
            <div>
              <div class="flex items-center justify-between">
                <label class="text-xs font-medium text-gray-500">ìƒí’ˆ</label>
                <span
                  v-if="uploadPreview.confidence.product"
                  class="text-xs px-1.5 py-0.5 rounded"
                  :class="uploadPreview.confidence.product >= 0.8 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'"
                >
                  {{ Math.round(uploadPreview.confidence.product * 100) }}%
                </span>
              </div>
              <select
                v-model="uploadPreview.data.product"
                @change="checkUploadDuplicate"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="">ë¯¸ë§¤ì¹­</option>
                <option v-for="(p, id) in store.taxonomy.products" :key="id" :value="id">{{ p.name }}</option>
              </select>
            </div>
            <div>
              <div class="flex items-center justify-between">
                <label class="text-xs font-medium text-gray-500">ë¬¸ì„œìœ í˜•</label>
                <span
                  v-if="uploadPreview.confidence.docType"
                  class="text-xs px-1.5 py-0.5 rounded"
                  :class="uploadPreview.confidence.docType >= 0.8 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'"
                >
                  {{ Math.round(uploadPreview.confidence.docType * 100) }}%
                </span>
              </div>
              <select
                v-model="uploadPreview.data.docType"
                @change="checkUploadDuplicate"
                class="w-full mt-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="">ë¯¸ë§¤ì¹­</option>
                <option v-for="(dt, id) in store.taxonomy.docTypes" :key="id" :value="id">{{ dt.name }}</option>
              </select>
            </div>
            <div v-if="uploadPreview.data.version" class="p-2 bg-blue-50 rounded">
              <div class="text-xs text-blue-700">ì¶”ì¶œëœ ë‚ ì§œ/ë²„ì „: {{ uploadPreview.data.version }}</div>
            </div>

            <!-- ì¤‘ë³µ ê²½ê³  -->
            <div v-if="uploadPreview.duplicateWarning" class="p-3 bg-red-50 border border-red-200 rounded-lg">
              <div class="text-sm font-medium text-red-700">ì¤‘ë³µ ë¬¸ì„œ ì¡´ì¬!</div>
              <div class="text-xs text-red-600 mt-1">{{ uploadPreview.duplicateWarning }}</div>
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button
              @click="uploadPreview.show = false"
              class="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium"
            >
              ì·¨ì†Œ
            </button>
            <button
              @click="createFromUpload"
              :disabled="uploadPreview.duplicateWarning || !uploadPreview.data.carrier || !uploadPreview.data.product || !uploadPreview.data.docType"
              :class="(uploadPreview.duplicateWarning || !uploadPreview.data.carrier || !uploadPreview.data.product || !uploadPreview.data.docType) ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'"
              class="flex-1 py-2 text-white rounded-lg text-sm font-medium"
            >
              ë¬¸ì„œ ìƒì„±
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ì´ë™ í™•ì¸ ëª¨ë‹¬ (git conflict ë°©ì‹) -->
    <div
      v-if="moveModal.show"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      @click.self="moveModal.show = false"
    >
      <div class="bg-white rounded-xl shadow-2xl w-[600px] max-h-[80vh] overflow-y-auto p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
            <span class="text-lg">ğŸ“¦</span>
          </div>
          <div>
            <h3 class="text-lg font-bold text-gray-800">ë„ë©”ì¸ ì´ë™ í™•ì¸</h3>
            <p class="text-xs text-gray-500">ê´€ê³„ ì˜í–¥ì„ ê²€í† í•˜ê³  í•´ê²° ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”</p>
          </div>
        </div>

        <!-- ì´ë™ ìš”ì•½ -->
        <div class="bg-gray-50 rounded-lg p-3 mb-4 text-sm">
          <div class="font-medium text-gray-700">{{ moveModal.docName }}</div>
          <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
            <span class="px-2 py-0.5 bg-red-100 text-red-700 rounded">{{ moveModal.oldDomain }}</span>
            <span>â†’</span>
            <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded">{{ moveModal.newDomain }}</span>
          </div>
        </div>

        <!-- ìë™ ì²˜ë¦¬ (Auto-resolved) -->
        <div v-if="moveModal.impact.autoResolved.length > 0" class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="w-5 h-5 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs font-bold">âœ“</span>
            <span class="text-sm font-medium text-green-700">ìë™ ì²˜ë¦¬ ({{ moveModal.impact.autoResolved.length }}ê±´)</span>
          </div>
          <div class="space-y-1 ml-7">
            <div
              v-for="(item, idx) in moveModal.impact.autoResolved"
              :key="'auto-'+idx"
              class="text-xs text-gray-600 flex items-center gap-2 py-1"
            >
              <span>{{ item.icon }}</span>
              <span>{{ item.message }}</span>
            </div>
          </div>
        </div>

        <!-- ë³´ì¡´ë¨ (Preserved) -->
        <div v-if="moveModal.impact.preserved.length > 0" class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="w-5 h-5 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">â•</span>
            <span class="text-sm font-medium text-blue-700">ìœ ì§€ë¨ ({{ moveModal.impact.preserved.length }}ê±´)</span>
          </div>
          <div class="space-y-1 ml-7">
            <div
              v-for="(item, idx) in moveModal.impact.preserved"
              :key="'keep-'+idx"
              class="text-xs text-gray-600 flex items-center gap-2 py-1"
            >
              <span>{{ item.icon }}</span>
              <span>{{ item.message }}</span>
            </div>
          </div>
        </div>

        <!-- ì»¨í”Œë¦­íŠ¸ (ê´€ë¦¬ì ê²°ì • í•„ìš”) -->
        <div v-if="moveModal.impact.conflicts.length > 0" class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="w-5 h-5 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-bold">!</span>
            <span class="text-sm font-medium text-orange-700">ê´€ë¦¬ì ê²°ì • í•„ìš” ({{ moveModal.impact.conflicts.length }}ê±´)</span>
          </div>
          <div class="space-y-2 ml-7">
            <div
              v-for="(conflict, idx) in moveModal.impact.conflicts"
              :key="'conflict-'+idx"
              class="border rounded-lg p-3"
              :class="moveModal.resolutions[conflict.relType+':'+conflict.targetId] === 'sever' ? 'border-red-200 bg-red-50' : 'border-green-200 bg-green-50'"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-xs text-gray-700">
                  <span>{{ conflict.icon }}</span>
                  <span>{{ conflict.message }}</span>
                </div>
                <div class="flex gap-1 ml-2 flex-shrink-0">
                  <button
                    @click="moveModal.resolutions[conflict.relType+':'+conflict.targetId] = 'keep'"
                    :class="moveModal.resolutions[conflict.relType+':'+conflict.targetId] === 'keep' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                    class="px-2 py-1 text-xs rounded font-medium transition"
                  >
                    ìœ ì§€
                  </button>
                  <button
                    @click="moveModal.resolutions[conflict.relType+':'+conflict.targetId] = 'sever'"
                    :class="moveModal.resolutions[conflict.relType+':'+conflict.targetId] === 'sever' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                    class="px-2 py-1 text-xs rounded font-medium transition"
                  >
                    í•´ì œ
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ì»¨í”Œë¦­íŠ¸ ì—†ìœ¼ë©´ ì•ˆë‚´ -->
        <div
          v-if="moveModal.impact.conflicts.length === 0 && moveModal.impact.autoResolved.length === 0 && moveModal.impact.preserved.length === 0"
          class="text-center py-6 text-sm text-gray-500"
        >
          ì´ ë¬¸ì„œì—ëŠ” ì—°ê²°ëœ ê´€ê³„ê°€ ì—†ìŠµë‹ˆë‹¤. ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="flex gap-2 mt-6 pt-4 border-t border-gray-100">
          <button
            @click="moveModal.show = false"
            class="flex-1 py-2.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition"
          >
            ì·¨ì†Œ
          </button>
          <button
            @click="executeMoveWithResolution()"
            class="flex-1 py-2.5 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg text-sm font-medium transition"
          >
            ì´ë™ ì‹¤í–‰
          </button>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

      // ê¸°ë³¸ ë°ì´í„° êµ¬ì¡° v3.0
      const DEFAULT_DATA = {
        version: '3.0',
        lastModified: new Date().toISOString(),
        system: {
          lifecycleStates: ['DRAFT', 'REVIEW', 'ACTIVE', 'STALE', 'DEPRECATED', 'ARCHIVED'],
          lifecycleTransitions: {
            DRAFT: ['REVIEW'],
            REVIEW: ['ACTIVE', 'REJECTED'],
            REJECTED: ['DRAFT'],
            ACTIVE: ['STALE', 'DEPRECATED'],
            STALE: ['ACTIVE', 'DEPRECATED'],
            DEPRECATED: ['ARCHIVED'],
            ARCHIVED: [],
          },
          freshnessDefaults: { HOT: 30, WARM: 90, COLD: 365 },
          freshnessThresholds: { FRESH: 0.7, WARNING: 1.0 },
          relationshipTypes: ['PARENT_OF', 'CHILD_OF', 'SIBLING', 'REFERENCE', 'SUPERSEDES'],
        },
        businesses: {
          GA: { name: 'GA ë³´í—˜ì˜ì—…', description: 'ë³´í—˜ëŒ€ë¦¬ì  ì˜ì—…/ê³„ì•½/ì •ì‚°' },
          MEDI: { name: 'ë©”ë””ì½”ë“œ', description: 'AI ë³´í—˜ì„¤ê³„ ì„œë¹„ìŠ¤' },
          COMMON: { name: 'ê³µí†µ', description: 'ì „ì‚¬ ê³µí†µ ê·œì œ/ì‹œìŠ¤í…œ' },
        },
        domains: {
          'GA-SALES': {
            business: 'GA', function: 'SALES', name: 'GA ì˜ì—…/ìƒë‹´',
            ssotKey: ['carrier', 'product', 'docType'],
            facets: [
              { id: 'carrier', name: 'ë³´í—˜ì‚¬', required: true },
              { id: 'product', name: 'ìƒí’ˆ', required: true },
              { id: 'docType', name: 'ë¬¸ì„œìœ í˜•', required: true },
            ],
          },
          'GA-COMM': {
            business: 'GA', function: 'COMM', name: 'GA ìˆ˜ìˆ˜ë£Œ/ì •ì‚°',
            ssotKey: ['carrier', 'product', 'docType'],
            facets: [
              { id: 'carrier', name: 'ë³´í—˜ì‚¬', required: true },
              { id: 'product', name: 'ìƒí’ˆ', required: true },
              { id: 'docType', name: 'ë¬¸ì„œìœ í˜•', required: true },
            ],
          },
          'GA-CONTRACT': {
            business: 'GA', function: 'CONTRACT', name: 'GA ê³„ì•½ê´€ë¦¬',
            ssotKey: ['carrier', 'product', 'docType'],
            facets: [
              { id: 'carrier', name: 'ë³´í—˜ì‚¬', required: true },
              { id: 'product', name: 'ìƒí’ˆ', required: true },
              { id: 'docType', name: 'ë¬¸ì„œìœ í˜•', required: true },
            ],
          },
          'GA-COMP': {
            business: 'GA', function: 'COMP', name: 'GA ì»´í”Œë¼ì´ì–¸ìŠ¤',
            ssotKey: ['carrier', 'docType'],
            facets: [
              { id: 'carrier', name: 'ë³´í—˜ì‚¬', required: true },
              { id: 'docType', name: 'ë¬¸ì„œìœ í˜•', required: true },
            ],
          },
          'GA-EDU': {
            business: 'GA', function: 'EDU', name: 'GA êµìœ¡/ì—­ëŸ‰',
            ssotKey: ['docType'],
            facets: [
              { id: 'docType', name: 'ë¬¸ì„œìœ í˜•', required: true },
            ],
          },
          'COMMON-COMP': {
            business: 'COMMON', function: 'COMP', name: 'ê³µí†µ ê·œì œ/ë²•ë¥ ',
            ssotKey: ['docType'],
            facets: [
              { id: 'docType', name: 'ë¬¸ì„œìœ í˜•', required: true },
            ],
          },
        },
        docTypeDomainMap: {
          'DOC-TERMS': 'GA-SALES', 'DOC-TERMS-SPECIAL': 'GA-SALES', 'DOC-GUIDE': 'GA-SALES',
          'DOC-RATE-TABLE': 'GA-SALES', 'DOC-BROCHURE': 'GA-SALES', 'DOC-PRODUCT-SUMMARY': 'GA-SALES',
          'DOC-SCRIPT': 'GA-SALES', 'DOC-COMPARISON': 'GA-SALES', 'DOC-PROPOSAL': 'GA-SALES',
          'DOC-INCENTIVE': 'GA-COMM', 'DOC-COMMISSION': 'GA-COMM', 'DOC-COMMISSION-CALC': 'GA-COMM',
          'DOC-SETTLEMENT': 'GA-COMM', 'DOC-PERFORMANCE': 'GA-COMM', 'DOC-CHARGEBACK': 'GA-COMM',
          'DOC-APPLICATION': 'GA-CONTRACT', 'DOC-DISCLOSURE': 'GA-CONTRACT', 'DOC-CONFIRMATION': 'GA-CONTRACT',
          'DOC-COMPLIANCE-GUIDE': 'GA-COMP',
          'DOC-TRAINING': 'GA-EDU', 'DOC-ONBOARDING': 'GA-EDU', 'DOC-COMPLIANCE': 'GA-EDU', 'DOC-CERTIFICATION': 'GA-EDU',
          'DOC-LAW-INSURANCE': 'COMMON-COMP', 'DOC-LAW-CONSUMER': 'COMMON-COMP', 'DOC-REGULATION': 'COMMON-COMP',
        },
        taxonomy: {
          carriers: {
            'INS-COMMON': { name: 'ê³µí†µ', alias: ['ì „ì²´', 'ALL'], type: 'common', tier: 'common' },
          },
          products: {
            'PRD-COMMON': { name: 'ê³µí†µ', category: 'COMMON', alias: ['ì „ì²´', 'ALL'] },
          },
          productCategories: {
            LIFE: { name: 'ìƒëª…ë³´í—˜', order: 1 },
            HEALTH: { name: 'ê±´ê°•/ì œ3ë³´í—˜', order: 2 },
            'NON-LIFE': { name: 'ì†í•´ë³´í—˜', order: 3 },
            ANNUITY: { name: 'ì—°ê¸ˆ/ì €ì¶•', order: 4 },
            COMMON: { name: 'ê³µí†µ', order: 99 },
          },
          docTypes: {},
          processes: {
            'BIZ-COMMON': { name: 'ê³µí†µ', order: 99 },
          },
          audiences: {
            'AUD-ALL': { name: 'ì „ì²´', level: 0 },
          },
          certifications: {},
          regulationTimeline: [],
          defaultRelations: {},
        },
        documents: {},
      };

      // v2.1/v3.0 JSON ë§ˆì´ê·¸ë ˆì´ì…˜
      function migrateFromTaxonomyV21(taxData) {
        const data = JSON.parse(JSON.stringify(DEFAULT_DATA));

        if (taxData.carriers) data.taxonomy.carriers = { ...data.taxonomy.carriers, ...taxData.carriers };
        if (taxData.products) data.taxonomy.products = { ...data.taxonomy.products, ...taxData.products };
        if (taxData.product_categories) data.taxonomy.productCategories = taxData.product_categories;
        if (taxData.doc_types) data.taxonomy.docTypes = taxData.doc_types;
        if (taxData.processes) data.taxonomy.processes = { ...data.taxonomy.processes, ...taxData.processes };
        if (taxData.audiences) data.taxonomy.audiences = { ...data.taxonomy.audiences, ...taxData.audiences };
        if (taxData.certifications) data.taxonomy.certifications = taxData.certifications;
        if (taxData.regulation_timeline) data.taxonomy.regulationTimeline = taxData.regulation_timeline;
        if (taxData.default_relations) data.taxonomy.defaultRelations = taxData.default_relations;
        // v3.0 ì‹œìŠ¤í…œ í•„ë“œ
        if (taxData.system) data.system = { ...data.system, ...taxData.system };
        if (taxData.businesses) data.businesses = { ...data.businesses, ...taxData.businesses };
        if (taxData.domains) data.domains = { ...data.domains, ...taxData.domains };
        if (taxData.doc_type_domain_map) data.docTypeDomainMap = { ...data.docTypeDomainMap, ...taxData.doc_type_domain_map };

        return data;
      }

      // knowledge-graph.json ë§ˆì´ê·¸ë ˆì´ì…˜
      function migrateFromKnowledgeGraphV21(graphData) {
        const data = JSON.parse(JSON.stringify(DEFAULT_DATA));
        const nodes = graphData.graph_data?.nodes || [];
        const edges = graphData.graph_data?.edges || [];

        // taxonomy ë³‘í•©
        if (graphData.taxonomy) {
          Object.assign(data.taxonomy, migrateFromTaxonomyV21(graphData.taxonomy).taxonomy);
        }

        // ê´€ê³„ ë§µ êµ¬ì„±
        const relatedTo = {};
        const references = {};
        const childOf = {}; // source CHILD_OF target â†’ sourceì˜ parent = target
        const parentOf = {}; // targetì˜ childrenì— source ì¶”ê°€
        edges.forEach((e) => {
          const rel = e.type || e.relationship;
          if (rel === 'SIBLINGS' || rel === 'RELATED_TO') {
            if (!relatedTo[e.source]) relatedTo[e.source] = [];
            relatedTo[e.source].push(e.target);
          }
          if (rel === 'REFERENCES') {
            if (!references[e.source]) references[e.source] = [];
            references[e.source].push(e.target);
          }
          if (rel === 'CHILD_OF') {
            childOf[e.source] = e.target;
            if (!parentOf[e.target]) parentOf[e.target] = [];
            parentOf[e.target].push(e.source);
          }
        });

        // ë¬¸ì„œ ë…¸ë“œ ì²˜ë¦¬
        nodes.forEach((n) => {
          if (!n.labels.includes('Document')) return;
          const props = n.properties;
          const docType = props.doc_type || n.labels.find((l) => l.startsWith('DOC-'));
          const tier = n.labels.find((l) => ['HOT', 'WARM', 'COLD'].includes(l)) || props.tier || 'COLD';

          // v3.0 classification/meta êµ¬ì¡° ì§€ì›
          const carrier = props.classification?.carrier || props.carrier;
          const product = props.classification?.product || props.product;
          const dt = props.classification?.docType || docType;
          const process = props.meta?.process || (props.processes && props.processes[0]) || props.process || '';
          const audience = props.meta?.audience || (props.audiences && props.audiences[0]) || props.audience || '';
          const lifecycle = props.lifecycle || 'ACTIVE';
          const version = props.version || { major: 1, minor: 0 };
          const domain = props.domain || data.docTypeDomainMap?.[dt] || 'GA-SALES';

          data.documents[n.id] = {
            id: n.id,
            name: props.name,
            domain: domain,
            lifecycle: lifecycle,
            version: typeof version === 'object' ? version : { major: parseInt(version) || 1, minor: 0 },
            classification: { carrier: carrier, product: product, docType: dt },
            meta: { process: process, audience: audience },
            tier: tier,
            content: props.content || '',
            relations: {
              parent: childOf[n.id] || null,
              children: parentOf[n.id] || [],
              siblings: relatedTo[n.id] || [],
              references: references[n.id] || [],
              supersedes: props.relations?.supersedes || null,
              supersededBy: props.relations?.supersededBy || null,
            },
            createdAt: props.createdAt || new Date().toISOString(),
            updatedAt: props.updatedAt || new Date().toISOString(),
            reviewedAt: props.reviewedAt || null,
          };
        });

        return data;
      }

      createApp({
        setup() {
          let network = null;

          const store = reactive(JSON.parse(JSON.stringify(DEFAULT_DATA)));
          const activeTab = ref('carriers');
          const viewMode = ref('graph');
          const graphMode = ref('overview');
          const searchQuery = ref('');
          const appliedSearch = ref('');
          const selectedDocId = ref(null);
          const selectedTaxonomy = reactive({ type: null, id: null });
          const modal = reactive({ show: false, type: '', title: '', data: {} });
          const docModal = reactive({ show: false, data: {}, duplicateWarning: null });
          const uploadPreview = reactive({
            show: false,
            filename: '',
            data: {},
            confidence: {},
            duplicateWarning: null,
          });
          const highlightedDocs = ref([]);

          // ì´ë™ í™•ì¸ ëª¨ë‹¬ (git conflict ë°©ì‹)
          const moveModal = reactive({
            show: false,
            docId: null,
            docName: '',
            oldDomain: '',
            newDomain: '',
            impact: {
              autoResolved: [],  // ìë™ ì²˜ë¦¬ë¨
              preserved: [],     // ìœ ì§€ë¨ (ID ë¶ˆë³€)
              conflicts: [],     // ê´€ë¦¬ì ê²€í†  í•„ìš”
            },
            resolutions: {},     // { 'siblings:DOC-ID': 'keep'|'sever' }
          });
          const toasts = ref([]);

          // ë¼ì´í”„ì‚¬ì´í´ í•„í„°
          const filterLifecycle = ref('');

          // ì‹œì‘ ì¶• ì„ íƒ (ë‹¤ë©´ ë¶„ë¥˜)
          const startAxis = ref('carrier');
          const AXIS_OPTIONS = [
            { id: 'carrier', label: 'ë³´í—˜ì‚¬' },
            { id: 'product', label: 'ìƒí’ˆ' },
            { id: 'docType', label: 'ë¬¸ì„œìœ í˜•' },
            { id: 'process', label: 'í”„ë¡œì„¸ìŠ¤' },
            { id: 'audience', label: 'ì—­í• ' },
          ];

          // === v3.0 í˜¸í™˜ í—¬í¼: classification/meta ë˜ëŠ” flat í•„ë“œ ì½ê¸° ===
          function getDocCarrier(doc) { return doc?.classification?.carrier || doc?.carrier || ''; }
          function getDocProduct(doc) { return doc?.classification?.product || doc?.product || ''; }
          function getDocDocType(doc) { return doc?.classification?.docType || doc?.docType || ''; }
          function getDocMeta(doc, key) { return doc?.meta?.[key] || doc?.[key] || ''; }
          function setDocClassification(doc, key, val) {
            if (!doc.classification) doc.classification = {};
            doc.classification[key] = val;
            // í•˜ìœ„í˜¸í™˜ì„ ìœ„í•´ flat í•„ë“œë„ ìœ ì§€
            doc[key] = val;
          }
          function setDocMeta(doc, key, val) {
            if (!doc.meta) doc.meta = {};
            doc.meta[key] = val;
            doc[key] = val;
          }

          // === ë„ë©”ì¸ facets í—¬í¼ ===
          function getDomainFacetIds(domain) {
            const domainDef = store.domains[domain];
            return new Set((domainDef?.facets || []).map(f => f.id));
          }
          function domainHasFacet(domain, facetId) {
            return getDomainFacetIds(domain).has(facetId);
          }

          // === ìë™ ì±„ë²ˆ ===
          function generateDocId() {
            store._docSeq = (store._docSeq || 0) + 1;
            return `PG-${String(store._docSeq).padStart(6, '0')}`;
          }
          function initDocSeq() {
            let maxSeq = Object.keys(store.documents).length;
            Object.keys(store.documents).forEach(id => {
              const match = id.match(/^PG-(\d+)$/);
              if (match) maxSeq = Math.max(maxSeq, parseInt(match[1]));
            });
            store._docSeq = maxSeq;
          }

          // === ë„ë©”ì¸ë³„ SSOT ê²€ì¦ ===
          function checkSsotViolation(domain, classification, excludeId = null) {
            const domainDef = store.domains[domain];
            const ssotKey = domainDef?.ssotKey || ['carrier', 'product', 'docType'];
            const myPath = ssotKey.map(k => classification[k] || '').join('|');
            const dup = Object.entries(store.documents).find(([id, d]) => {
              if (excludeId && id === excludeId) return false;
              if ((d.lifecycle || 'ACTIVE') !== 'ACTIVE') return false;
              if ((d.domain || 'GA-SALES') !== domain) return false;
              const cls = d.classification || d;
              const otherPath = ssotKey.map(k => cls[k] || d[k] || '').join('|');
              return myPath === otherPath;
            });
            return dup ? dup[1] : null;
          }

          // === ì‹ ì„ ë„ ê³„ì‚° ===
          function calcFreshness(doc) {
            if (!doc) return { daysSince: 0, maxDays: 90, pct: 0, status: 'FRESH' };
            const lastDate = new Date(Math.max(
              new Date(doc.updatedAt || doc.createdAt || Date.now()).getTime(),
              new Date(doc.reviewedAt || 0).getTime()
            ));
            const daysSince = Math.max(0, Math.floor((Date.now() - lastDate.getTime()) / 86400000));
            const tier = doc.tier || 'WARM';
            const defaults = store.system?.freshnessDefaults || { HOT: 30, WARM: 90, COLD: 365 };
            const maxDays = defaults[tier] || 90;
            const pct = Math.round((daysSince / maxDays) * 100);
            let status = 'FRESH';
            if (daysSince >= maxDays) status = 'EXPIRED';
            else if (daysSince >= maxDays * 0.7) status = 'WARNING';
            return { daysSince, maxDays, pct, status };
          }

          // === ë¼ì´í”„ì‚¬ì´í´ ì „í™˜ ===
          function getNextLifecycleStates(current) {
            const transitions = store.system?.lifecycleTransitions || DEFAULT_DATA.system.lifecycleTransitions;
            return transitions[current] || [];
          }
          function transitionLifecycle(docId, nextState) {
            const doc = store.documents[docId];
            if (!doc) return;
            const oldState = doc.lifecycle || 'ACTIVE';
            doc.lifecycle = nextState;
            if (nextState === 'ACTIVE') doc.reviewedAt = new Date().toISOString();
            doc.updatedAt = new Date().toISOString();
            // SSOT: ACTIVE ì „í™˜ ì‹œ ë™ì¼ ê²½ë¡œì˜ ë‹¤ë¥¸ ACTIVE â†’ DEPRECATED
            if (nextState === 'ACTIVE') {
              const domain = doc.domain || 'GA-SALES';
              const domainDef = store.domains[domain];
              const ssotKey = domainDef?.ssotKey || ['carrier', 'product', 'docType'];
              const cls = doc.classification || doc;
              const myPath = ssotKey.map(k => cls[k] || doc[k] || '').join('|');
              Object.entries(store.documents).forEach(([id, d]) => {
                if (id === docId) return;
                if ((d.domain || 'GA-SALES') !== domain) return;
                if (d.lifecycle !== 'ACTIVE') return;
                const dCls = d.classification || d;
                const otherPath = ssotKey.map(k => dCls[k] || d[k] || '').join('|');
                if (myPath === otherPath) {
                  d.lifecycle = 'DEPRECATED';
                  d.updatedAt = new Date().toISOString();
                }
              });
            }
            saveStore();
            showToast(`${oldState} â†’ ${nextState}`, 'success');
          }

          function getLifecycleClass(state) {
            const map = {
              DRAFT: 'bg-gray-200 text-gray-700',
              REVIEW: 'bg-blue-100 text-blue-700',
              ACTIVE: 'bg-green-100 text-green-700',
              STALE: 'bg-orange-100 text-orange-700',
              DEPRECATED: 'bg-red-100 text-red-700',
              ARCHIVED: 'bg-gray-300 text-gray-600',
              REJECTED: 'bg-red-200 text-red-800',
            };
            return map[state] || 'bg-gray-100 text-gray-600';
          }
          function getFreshnessClass(status) {
            const map = { FRESH: 'text-green-600', WARNING: 'text-orange-600', EXPIRED: 'text-red-600' };
            return map[status] || 'text-gray-600';
          }

          // ë¼ì´í”„ì‚¬ì´í´ ì¹´ìš´íŠ¸
          const lifecycleCounts = computed(() => {
            const counts = {};
            Object.values(store.documents).forEach(d => {
              const s = d.lifecycle || 'ACTIVE';
              counts[s] = (counts[s] || 0) + 1;
            });
            return counts;
          });

          // v2.1 â†’ v3.0 ë§ˆì´ê·¸ë ˆì´ì…˜ (localStorage ë°ì´í„°)
          function migrateDocToV3(doc) {
            if (doc.classification) return doc; // ì´ë¯¸ v3
            const docType = doc.docType || '';
            return {
              ...doc,
              domain: doc.domain || store.docTypeDomainMap?.[docType] || DEFAULT_DATA.docTypeDomainMap[docType] || 'GA-SALES',
              lifecycle: doc.lifecycle || doc.status || 'ACTIVE',
              version: typeof doc.version === 'object' ? doc.version : { major: parseInt(doc.version) || 1, minor: 0 },
              classification: { carrier: doc.carrier || '', product: doc.product || '', docType: docType },
              meta: { process: doc.process || '', audience: doc.audience || '' },
              reviewedAt: doc.reviewedAt || doc.updatedAt || null,
              relations: {
                ...doc.relations,
                supersedes: doc.relations?.supersedes || null,
                supersededBy: doc.relations?.supersededBy || null,
              },
            };
          }

          function getDrillOrder() {
            const base = ['carrier', 'product', 'docType'];
            const start = startAxis.value;
            if (base.includes(start)) return [start, ...base.filter(a => a !== start)];
            return [start, ...base];
          }

          function setStartAxis(axis) {
            startAxis.value = axis;
            clearSelection();
          }

          // ë¦¬ìŠ¤íŠ¸ë·° ë“œë¦´ë‹¤ìš´ ê²½ë¡œ [{type: 'carrier', id: 'INS-SAMSUNG'}, {type: 'product', id: 'PRD-LIFE'}]
          const listDrillPath = reactive([]);

          // v2.1 í•„í„°
          const carrierTypeFilter = ref('all');
          const productCategoryFilter = ref('all');
          const docTypeTierFilter = ref('all');
          const filterProcess = ref('');
          const filterAudience = ref('');

          const selectedDoc = computed(() => (selectedDocId.value ? store.documents[selectedDocId.value] : null));

          // í•„í„°ëœ ë³´í—˜ì‚¬
          const filteredCarriers = computed(() => {
            const result = {};
            Object.entries(store.taxonomy.carriers).forEach(([id, carrier]) => {
              if (id === 'INS-COMMON') return;
              if (carrierTypeFilter.value === 'all' || carrier.type === carrierTypeFilter.value) {
                result[id] = carrier;
              }
            });
            return result;
          });

          // í•„í„°ëœ ìƒí’ˆ
          const filteredProducts = computed(() => {
            const result = {};
            Object.entries(store.taxonomy.products).forEach(([id, product]) => {
              if (id === 'PRD-COMMON') return;
              if (productCategoryFilter.value === 'all' || product.category === productCategoryFilter.value) {
                result[id] = product;
              }
            });
            return result;
          });

          // í•„í„°ëœ ë¬¸ì„œìœ í˜•
          const filteredDocTypes = computed(() => {
            const result = {};
            Object.entries(store.taxonomy.docTypes).forEach(([id, docType]) => {
              if (docTypeTierFilter.value === 'all' || docType.tier === docTypeTierFilter.value) {
                result[id] = docType;
              }
            });
            return result;
          });

          // ì •ë ¬ëœ í”„ë¡œì„¸ìŠ¤
          const sortedProcesses = computed(() => {
            const entries = Object.entries(store.taxonomy.processes)
              .filter(([id]) => id !== 'BIZ-COMMON')
              .sort((a, b) => (a[1].order || 99) - (b[1].order || 99));
            return Object.fromEntries(entries);
          });

          // ì •ë ¬ëœ ì—­í• 
          const sortedAudiences = computed(() => {
            const entries = Object.entries(store.taxonomy.audiences)
              .filter(([id]) => id !== 'AUD-ALL')
              .sort((a, b) => (a[1].level || 0) - (b[1].level || 0));
            return Object.fromEntries(entries);
          });

          // ê²€ìƒ‰ì–´ ë§¤ì¹­ (ë¬¸ì„œëª…, ID, ë³´í—˜ì‚¬ëª…, ìƒí’ˆëª…, ë¬¸ì„œìœ í˜•ëª…, alias í¬í•¨)
          function matchesSearch(doc, id, q) {
            if (!q) return true;
            if (doc.name.toLowerCase().includes(q)) return true;
            if (id.toLowerCase().includes(q)) return true;
            const carrierId = getDocCarrier(doc);
            const carrier = store.taxonomy.carriers[carrierId];
            if (carrier) {
              if (carrier.name.toLowerCase().includes(q)) return true;
              if ((carrier.alias || []).some((a) => a.toLowerCase().includes(q))) return true;
            }
            const productId = getDocProduct(doc);
            const product = store.taxonomy.products[productId];
            if (product) {
              if (product.name.toLowerCase().includes(q)) return true;
              if ((product.alias || []).some((a) => a.toLowerCase().includes(q))) return true;
            }
            const dtId = getDocDocType(doc);
            const docType = store.taxonomy.docTypes[dtId];
            if (docType && docType.name.toLowerCase().includes(q)) return true;
            return false;
          }

          // í•„í„°ëœ ë¬¸ì„œ
          const filteredDocuments = computed(() => {
            const q = appliedSearch.value.toLowerCase();
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              if (!matchesSearch(doc, id, q)) return;
              if (filterLifecycle.value && (doc.lifecycle || 'ACTIVE') !== filterLifecycle.value) return;
              if (filterProcess.value && getDocMeta(doc, 'process') !== filterProcess.value) return;
              if (filterAudience.value && getDocMeta(doc, 'audience') !== filterAudience.value) return;
              docs[id] = doc;
            });
            return docs;
          });

          // ê°™ì€ ë³´í—˜ì‚¬+ìƒí’ˆ ë¬¸ì„œ (ë¶€ëª¨/ìì‹/í˜•ì œ í›„ë³´)
          const samePathDocuments = computed(() => {
            if (!selectedDoc.value) return {};
            const carrier = getDocCarrier(selectedDoc.value);
            const product = getDocProduct(selectedDoc.value);
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              if (id !== selectedDocId.value && getDocCarrier(doc) === carrier && getDocProduct(doc) === product) {
                docs[id] = doc;
              }
            });
            return docs;
          });

          // ë¶€ëª¨ í›„ë³´: ê°™ì€ ë³´í—˜ì‚¬+ìƒí’ˆ, ìì‹ ì˜ ìì‹ ì œì™¸
          const availableParents = computed(() => {
            if (!selectedDoc.value) return {};
            const children = selectedDoc.value.relations?.children || [];
            const docs = {};
            Object.entries(samePathDocuments.value).forEach(([id, doc]) => {
              if (!children.includes(id)) docs[id] = doc;
            });
            return docs;
          });

          // ìì‹ í›„ë³´: ê°™ì€ ë³´í—˜ì‚¬+ìƒí’ˆ, ì´ë¯¸ ìì‹/ë¶€ëª¨ ì œì™¸
          const availableChildren = computed(() => {
            if (!selectedDoc.value) return {};
            const existing = selectedDoc.value.relations?.children || [];
            const parentId = selectedDoc.value.relations?.parent;
            const docs = {};
            Object.entries(samePathDocuments.value).forEach(([id, doc]) => {
              if (!existing.includes(id) && id !== parentId) docs[id] = doc;
            });
            return docs;
          });

          // í˜•ì œ í›„ë³´: ê°™ì€ ë³´í—˜ì‚¬+ìƒí’ˆ, ì´ë¯¸ í˜•ì œ ì œì™¸
          const availableSiblings = computed(() => {
            if (!selectedDoc.value) return {};
            const existing = selectedDoc.value.relations?.siblings || [];
            const docs = {};
            Object.entries(samePathDocuments.value).forEach(([id, doc]) => {
              if (!existing.includes(id)) docs[id] = doc;
            });
            return docs;
          });

          // ì°¸ì¡° í›„ë³´: ì „ì²´ ë¬¸ì„œ (ê°ì£¼/í•˜ì´í¼ë§í¬ ê°œë… - ê²½ê³„ ë¬´ê´€), ì´ë¯¸ ì°¸ì¡° ì œì™¸
          const availableReferences = computed(() => {
            if (!selectedDoc.value) return {};
            const existing = selectedDoc.value.relations?.references || [];
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              if (id !== selectedDocId.value && !existing.includes(id)) docs[id] = doc;
            });
            return docs;
          });

          const duplicateGroups = computed(() => {
            const groups = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              // SSOT: ë™ì¼ ê²½ë¡œì— ACTIVE 2ê°œ ì´ìƒ â†’ ìœ„ë°˜
              if ((doc.lifecycle || 'ACTIVE') !== 'ACTIVE') return;
              const domain = doc.domain || 'GA-SALES';
              const domainDef = store.domains[domain];
              const ssotKey = domainDef?.ssotKey || ['carrier', 'product', 'docType'];
              const cls = doc.classification || doc;
              const key = domain + '|' + ssotKey.map(k => cls[k] || doc[k] || '').join('|');
              if (!groups[key]) groups[key] = [];
              groups[key].push({ id, name: doc.name });
            });
            return Object.entries(groups)
              .filter(([_, docs]) => docs.length > 1)
              .map(([key, docs]) => {
                const [carrier, product, docType] = key.split('|');
                return {
                  key: `${getCarrierName(carrier)} > ${getProductName(product)} > ${getDocTypeName(docType)}`,
                  docs,
                };
              });
          });

          // ëŒ€ì‹œë³´ë“œ ë°ì´í„°
          const dashboard = computed(() => {
            const docs = Object.entries(store.documents);
            const totalDocs = docs.length;
            if (totalDocs === 0) return {
              score: 0, totalDocs: 0, orphanCount: 0, duplicateCount: 0, brokenRefCount: 0,
              relationHealth: [], tierDist: [], carrierDist: [], docTypeDist: [],
              supersedesChains: [], metaCompleteness: [], contentFillPct: 0, contentFilledCount: 0,
              avgRelations: '0', issues: [], lifecycleDist: [], freshnessDist: [], ssotViolations: 0,
              expiringDocs: [], domainDist: [],
            };

            const issues = [];

            // ê³ ì•„ ë¬¸ì„œ
            const orphans = docs.filter(([, d]) => {
              const r = d.relations || {};
              return !r.parent && (r.children || []).length === 0 && (r.siblings || []).length === 0 && (r.references || []).length === 0;
            });

            // SSOT ìœ„ë°˜ (ë™ì¼ ê²½ë¡œì— ACTIVE 2ê°œ ì´ìƒ)
            const uniqueMap = {};
            docs.forEach(([id, d]) => {
              if ((d.lifecycle || 'ACTIVE') !== 'ACTIVE') return;
              const key = `${getDocCarrier(d)}|${getDocProduct(d)}|${getDocDocType(d)}`;
              if (!uniqueMap[key]) uniqueMap[key] = [];
              uniqueMap[key].push(id);
            });
            const dupes = Object.entries(uniqueMap).filter(([, ids]) => ids.length > 1);

            // ëŠì–´ì§„ ì°¸ì¡°
            let brokenRefs = 0;
            docs.forEach(([, d]) => {
              const r = d.relations || {};
              if (r.parent && !store.documents[r.parent]) { brokenRefs++; issues.push({ severity: 'error', message: `"${d.name}" ë¶€ëª¨ ì°¸ì¡° ëŠê¹€: ${r.parent}` }); }
              (r.children || []).forEach(c => { if (!store.documents[c]) { brokenRefs++; issues.push({ severity: 'error', message: `"${d.name}" ìì‹ ì°¸ì¡° ëŠê¹€: ${c}` }); } });
              (r.siblings || []).forEach(s => { if (!store.documents[s]) { brokenRefs++; issues.push({ severity: 'error', message: `"${d.name}" í˜•ì œ ì°¸ì¡° ëŠê¹€: ${s}` }); } });
              (r.references || []).forEach(ref => { if (!store.documents[ref]) { brokenRefs++; issues.push({ severity: 'error', message: `"${d.name}" ì°¸ì¡° ëŠê¹€: ${ref}` }); } });
            });

            // ê´€ê³„ ê±´ê°•ë„
            const withParent = docs.filter(([, d]) => d.relations?.parent).length;
            const withChildren = docs.filter(([, d]) => (d.relations?.children || []).length > 0).length;
            const withSiblings = docs.filter(([, d]) => (d.relations?.siblings || []).length > 0).length;
            const withRefs = docs.filter(([, d]) => (d.relations?.references || []).length > 0).length;
            const pct = (n) => totalDocs > 0 ? Math.round(n / totalDocs * 100) : 0;
            const relationHealth = [
              { label: 'ë¶€ëª¨ ìˆìŒ', count: withParent, pct: pct(withParent) },
              { label: 'ìì‹ ìˆìŒ', count: withChildren, pct: pct(withChildren) },
              { label: 'í˜•ì œ ìˆìŒ', count: withSiblings, pct: pct(withSiblings) },
              { label: 'ì°¸ì¡° ìˆìŒ', count: withRefs, pct: pct(withRefs) },
            ];

            // í‰ê·  ê´€ê³„ ìˆ˜
            let totalRels = 0;
            docs.forEach(([, d]) => {
              const r = d.relations || {};
              totalRels += (r.parent ? 1 : 0) + (r.children || []).length + (r.siblings || []).length + (r.references || []).length;
            });

            // Tier ë¶„í¬
            const tierMap = { HOT: 0, WARM: 0, COLD: 0 };
            docs.forEach(([, d]) => { if (tierMap[d.tier] !== undefined) tierMap[d.tier]++; });
            const tierDist = Object.entries(tierMap).map(([name, count]) => ({ name, count, pct: pct(count) }));

            // ë¼ì´í”„ì‚¬ì´í´ ë¶„í¬
            const lcMap = {};
            docs.forEach(([, d]) => { const s = d.lifecycle || 'ACTIVE'; lcMap[s] = (lcMap[s] || 0) + 1; });
            const lifecycleDist = Object.entries(lcMap).sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({ name, count, pct: pct(count) }));

            // ì‹ ì„ ë„ ë¶„í¬
            const freshMap = { FRESH: 0, WARNING: 0, EXPIRED: 0 };
            docs.forEach(([, d]) => { const f = calcFreshness(d); freshMap[f.status]++; });
            const freshnessDist = Object.entries(freshMap).map(([name, count]) => ({ name, count, pct: pct(count) }));

            // ë§Œë£Œ ì„ë°• ë¬¸ì„œ (7ì¼ ë‚´)
            const expiringDocs = docs.filter(([, d]) => {
              const f = calcFreshness(d);
              return f.status === 'WARNING' && (f.maxDays - f.daysSince) <= 7;
            }).map(([id, d]) => ({ id, name: d.name, daysLeft: calcFreshness(d).maxDays - calcFreshness(d).daysSince }))
              .sort((a, b) => a.daysLeft - b.daysLeft).slice(0, 10);

            // ë„ë©”ì¸ë³„ ë¬¸ì„œ ìˆ˜
            const domainMap = {};
            docs.forEach(([, d]) => { const dm = d.domain || 'GA-SALES'; domainMap[dm] = (domainMap[dm] || 0) + 1; });
            const domainDist = Object.entries(domainMap).sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({ name, count, pct: pct(count) }));

            // ë³´í—˜ì‚¬ë³„ ë¶„í¬
            const carrierMap = {};
            docs.forEach(([, d]) => { const c = getDocCarrier(d); carrierMap[c] = (carrierMap[c] || 0) + 1; });
            const maxCarrier = Math.max(...Object.values(carrierMap));
            const carrierDist = Object.entries(carrierMap)
              .sort((a, b) => b[1] - a[1])
              .map(([id, count]) => ({ id, name: store.taxonomy.carriers[id]?.name || id, count, pct: Math.round(count / maxCarrier * 100) }));

            // ë¬¸ì„œìœ í˜•ë³„ ë¶„í¬
            const dtMap = {};
            docs.forEach(([, d]) => { const dt = getDocDocType(d); dtMap[dt] = (dtMap[dt] || 0) + 1; });
            const maxDt = Math.max(...Object.values(dtMap));
            const docTypeDist = Object.entries(dtMap)
              .sort((a, b) => b[1] - a[1])
              .map(([id, count]) => ({ id, name: store.taxonomy.docTypes[id]?.name || id, count, pct: Math.round(count / maxDt * 100) }));

            // SUPERSEDES ì²´ì¸
            const supersedesChains = [];
            const visited = new Set();
            Object.entries(store.taxonomy.products).forEach(([pid, p]) => {
              if (visited.has(pid) || !p.supersedes) return;
              const chain = [pid];
              let cur = p.supersedes;
              while (cur && !visited.has(cur)) {
                chain.push(cur);
                visited.add(cur);
                cur = store.taxonomy.products[cur]?.supersedes;
              }
              visited.add(pid);
              supersedesChains.push(chain);
            });

            // ë©”íƒ€ë°ì´í„° ì™„ì„±ë„
            const withProcess = docs.filter(([, d]) => { const p = getDocMeta(d, 'process'); return p && p !== 'BIZ-COMMON'; }).length;
            const withAudience = docs.filter(([, d]) => { const a = getDocMeta(d, 'audience'); return a && a !== 'AUD-ALL'; }).length;
            const withContent = docs.filter(([, d]) => d.content && d.content.trim().length > 0).length;
            const metaCompleteness = [
              { label: 'í”„ë¡œì„¸ìŠ¤', pct: pct(withProcess) },
              { label: 'ì—­í• ', pct: pct(withAudience) },
              { label: 'ë³¸ë¬¸', pct: pct(withContent) },
            ];

            // ì´ìŠˆ ì¶”ê°€
            if (dupes.length > 0) issues.push({ severity: 'error', message: `ìœ ë‹ˆí¬ ìœ„ë°˜ ${dupes.length}ê±´ (ë™ì¼ ë³´í—˜ì‚¬+ìƒí’ˆ+ë¬¸ì„œìœ í˜•)` });
            if (orphans.length > totalDocs * 0.5) issues.push({ severity: 'warning', message: `ê³ ì•„ ë¬¸ì„œ ${orphans.length}ê±´ (${pct(orphans.length)}%) - ê´€ê³„ ì„¤ì • í•„ìš”` });
            if (withContent < totalDocs * 0.1) issues.push({ severity: 'warning', message: `ë³¸ë¬¸ ìˆëŠ” ë¬¸ì„œ ${withContent}ê±´ (${pct(withContent)}%) - ë³¸ë¬¸ ì…ë ¥ í•„ìš”` });

            // ë³´í—˜ì‚¬ ê· í˜• ê²€ì‚¬
            if (carrierDist.length > 1) {
              const minC = carrierDist[carrierDist.length - 1];
              const maxC = carrierDist[0];
              if (maxC.count > minC.count * 5) issues.push({ severity: 'info', message: `ë³´í—˜ì‚¬ ë¶ˆê· í˜•: ${maxC.name}(${maxC.count}ê±´) vs ${minC.name}(${minC.count}ê±´)` });
            }

            // ì ìˆ˜ ê³„ì‚° (100ì  ë§Œì )
            let score = 100;
            score -= dupes.length * 10;                      // ìœ ë‹ˆí¬ ìœ„ë°˜ -10ì /ê±´
            score -= brokenRefs * 5;                          // ëŠì–´ì§„ ì°¸ì¡° -5ì /ê±´
            score -= Math.max(0, pct(orphans.length) - 80);   // ê³ ì•„ 80% ì´ˆê³¼ ì‹œ ê°ì 
            if (withContent < totalDocs * 0.05) score -= 10;  // ë³¸ë¬¸ 5% ë¯¸ë§Œ -10ì 
            score = Math.max(0, Math.min(100, Math.round(score)));

            return {
              score, totalDocs,
              orphanCount: orphans.length,
              duplicateCount: dupes.length,
              brokenRefCount: brokenRefs,
              ssotViolations: dupes.length,
              relationHealth, tierDist, carrierDist, docTypeDist,
              lifecycleDist, freshnessDist, expiringDocs, domainDist,
              supersedesChains, metaCompleteness,
              avgRelations: (totalRels / totalDocs).toFixed(1),
              contentFillPct: pct(withContent),
              contentFilledCount: withContent,
              issues,
            };
          });

          // ë‹¤ê°€ì˜¤ëŠ” ê·œì œ
          const upcomingRegulation = computed(() => {
            const upcoming = store.taxonomy.regulationTimeline
              .filter((r) => r.status === 'upcoming')
              .sort((a, b) => new Date(a.date) - new Date(b.date));
            return upcoming[0] || null;
          });

          // ì´ˆê¸°í™”
          onMounted(() => {
            loadStore();
            initDocSeq();
            nextTick(() => {
              initGraph();
            });
          });

          function loadStore() {
            const saved = localStorage.getItem('kms_data_v2');
            if (saved) {
              const parsed = JSON.parse(saved);
              // v3 ì‹œìŠ¤í…œ í•„ë“œê°€ ì—†ìœ¼ë©´ ì¶”ê°€
              if (!parsed.system) parsed.system = DEFAULT_DATA.system;
              if (!parsed.businesses) parsed.businesses = DEFAULT_DATA.businesses;
              if (!parsed.domains) parsed.domains = DEFAULT_DATA.domains;
              if (!parsed.docTypeDomainMap) parsed.docTypeDomainMap = DEFAULT_DATA.docTypeDomainMap;
              Object.assign(store, parsed);
              // ë¬¸ì„œ v2.1â†’v3 ë§ˆì´ê·¸ë ˆì´ì…˜
              let migrated = false;
              Object.entries(store.documents).forEach(([id, doc]) => {
                if (!doc.classification) {
                  store.documents[id] = migrateDocToV3(doc);
                  migrated = true;
                }
              });
              if (migrated) saveStore();
              initDocSeq();
            } else {
              // data/taxonomy.json ë˜ëŠ” data/knowledge-graph.json ë¡œë“œ ì‹œë„
              Promise.all([
                fetch('../data/taxonomy.json')
                  .then((r) => (r.ok ? r.json() : null))
                  .catch(() => null),
                fetch('../data/knowledge-graph.json')
                  .then((r) => (r.ok ? r.json() : null))
                  .catch(() => null),
              ]).then(([taxData, graphData]) => {
                // taxonomy.jsonìœ¼ë¡œ ë¶„ë¥˜ì²´ê³„ ë¡œë“œ
                if (taxData) {
                  Object.assign(store, migrateFromTaxonomyV21(taxData));
                }
                // knowledge-graph.jsonìœ¼ë¡œ ë¬¸ì„œ+ê´€ê³„ ë³‘í•©
                if (graphData) {
                  const graphMigrated = migrateFromKnowledgeGraphV21(graphData);
                  // ë¬¸ì„œ ë°ì´í„°ë§Œ ë³‘í•© (taxonomyëŠ” ì´ë¯¸ ë¡œë“œë¨)
                  Object.assign(store.documents, graphMigrated.documents);
                }
                saveStore();
                initDocSeq();
                rebuildGraph();
              });
            }
          }

          function saveStore() {
            store.lastModified = new Date().toISOString();
            localStorage.setItem('kms_data_v2', JSON.stringify(store));
            rebuildGraph();
          }

          function showToast(message, type = 'success') {
            toasts.value.push({ message, type });
            setTimeout(() => toasts.value.shift(), 3000);
          }

          function removeToast(idx) {
            toasts.value.splice(idx, 1);
          }

          function initGraph() {
            const container = document.getElementById('network');
            if (!container) return;

            const options = {
              layout: {
                hierarchical: {
                  enabled: true,
                  direction: 'LR',
                  sortMethod: 'directed',
                  nodeSpacing: 80,
                  levelSeparation: 200,
                },
              },
              physics: { enabled: false },
              interaction: {
                hover: false,
                selectConnectedEdges: true,
                zoomView: true,
                dragView: true,
                navigationButtons: false,
              },
              nodes: { font: { size: 12 } },
              edges: {
                arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                smooth: { type: 'cubicBezier', forceDirection: 'horizontal' },
              },
            };

            network = new vis.Network(container, { nodes: [], edges: [] }, options);
            network.on('click', (params) => {
              if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                if (store.documents[nodeId]) {
                  selectDocument(nodeId);
                } else if (store.taxonomy.carriers[nodeId]) {
                  selectTaxonomy('carrier', nodeId);
                } else if (store.taxonomy.products[nodeId]) {
                  selectTaxonomy('product', nodeId);
                } else if (store.taxonomy.docTypes[nodeId]) {
                  selectTaxonomy('docType', nodeId);
                } else if (store.taxonomy.processes[nodeId]) {
                  selectTaxonomy('process', nodeId);
                } else if (store.taxonomy.audiences[nodeId]) {
                  selectTaxonomy('audience', nodeId);
                }
              }
            });

            rebuildGraph();
          }

          function rebuildGraph() {
            if (!network) return;

            if (graphMode.value === 'overview') {
              rebuildOverviewGraph();
            } else {
              rebuildDetailGraph();
            }
          }

          // ë¶„ë¥˜ í•­ëª© ì„ íƒ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ë¬¸ì„œë“¤ì„ í•„í„°ë§ (ë“œë¦´ ê²½ë¡œ ì „ì²´ ë°˜ì˜)
          function getDocsByTaxonomySelection() {
            if (listDrillPath.length === 0) return null;

            const getterMap = {
              carrier: getDocCarrier,
              product: getDocProduct,
              docType: getDocDocType,
              process: (d) => getDocMeta(d, 'process'),
              audience: (d) => getDocMeta(d, 'audience'),
            };

            return Object.entries(store.documents)
              .filter(([_, doc]) => {
                return listDrillPath.every((step) => {
                  const getter = getterMap[step.type];
                  return getter ? getter(doc) === step.id : true;
                });
              })
              .map(([docId]) => docId);
          }

          function rebuildOverviewGraph() {
            const nodes = [];
            const edges = [];
            const selType = selectedTaxonomy.type;
            const selId = selectedTaxonomy.id;
            const tierColors = { HOT: '#e74c3c', WARM: '#f39c12', COLD: '#95a5a6' };

            // ë¶„ë¥˜ í•­ëª©ì´ ì„ íƒë˜ì—ˆìœ¼ë©´ ë“œë¦´ë‹¤ìš´ ë·° (listDrillPath ì „ì²´ ê²½ë¡œ ë°˜ì˜)
            if (selType && selId) {
              const selectedDocs = getDocsByTaxonomySelection() || [];
              const itemName = getTaxonomyItemName(selType, selId);

              // ê²½ë¡œì˜ ê° ë‹¨ê³„ë¥¼ ë³„ë„ ë…¸ë“œë¡œ í‘œì‹œ
              const docCount = selectedDocs.length;
              const colorByType = {
                carrier: { bg: '#e1bee7', border: '#8e44ad', font: '#4a148c' },
                product: { bg: '#bbdefb', border: '#1976d2', font: '#0d47a1' },
                docType: { bg: '#c8e6c9', border: '#27ae60', font: '#1b5e20' },
                process: { bg: '#ffe0b2', border: '#e67e22', font: '#e65100' },
                audience: { bg: '#b2ebf2', border: '#00bcd4', font: '#006064' },
              };

              let prevNodeId = null;
              listDrillPath.forEach((step, idx) => {
                const stepName = getTaxonomyItemName(step.type, step.id);
                const isLast = idx === listDrillPath.length - 1;
                const cm = colorByType[step.type] || colorByType.carrier;
                const label = isLast ? `${stepName}\n(${docCount}ê±´)` : stepName;
                nodes.push({
                  id: step.id,
                  label,
                  level: idx,
                  shape: 'dot',
                  size: isLast ? 35 : 25,
                  borderWidth: isLast ? 4 : 2,
                  color: { background: isLast ? '#e3f2fd' : cm.bg, border: isLast ? '#1565c0' : cm.border },
                  font: { color: isLast ? '#0d47a1' : cm.font, size: isLast ? 14 : 12, bold: isLast },
                });
                if (prevNodeId) {
                  edges.push({ from: prevNodeId, to: step.id, color: '#bdc3c7', width: 2 });
                }
                prevNodeId = step.id;
              });

              // ë¬¸ì„œ ë¼ë²¨ ìƒì„± (ì´ë¯¸ ì‚¬ìš©í•œ ì¶• ì œì™¸)
              const usedTypes = new Set(listDrillPath.map((p) => p.type));
              const nameGetters = { carrier: getCarrierName, product: getProductName, docType: getDocTypeName, process: getProcessName, audience: getAudienceName };
              const docGetters = { carrier: getDocCarrier, product: getDocProduct, docType: getDocDocType, process: (d) => getDocMeta(d, 'process'), audience: (d) => getDocMeta(d, 'audience') };
              function docLabel(doc) {
                const parts = [];
                ['carrier', 'product', 'docType'].forEach(t => {
                  if (!usedTypes.has(t)) parts.push(nameGetters[t](docGetters[t](doc)));
                });
                return (parts.length > 0 ? parts.join(' / ') + '\n' : '') + '[' + doc.tier + ']';
              }

              // ë‹¤ìŒ ê·¸ë£¹í•‘ ì¶• ê²°ì • (ë™ì  ë“œë¦´ ìˆœì„œ)
              const baseLevel = listDrillPath.length;
              const drillOrder = getDrillOrder();
              const nextGroupAxis = drillOrder.find((t) => !usedTypes.has(t));
              const colorMap = {
                carrier: { bg: '#e1bee7', border: '#8e44ad', font: '#4a148c' },
                product: { bg: '#bbdefb', border: '#1976d2', font: '#0d47a1' },
                docType: { bg: '#c8e6c9', border: '#27ae60', font: '#1b5e20' },
                process: { bg: '#ffe0b2', border: '#e67e22', font: '#e65100' },
                audience: { bg: '#b2ebf2', border: '#00bcd4', font: '#006064' },
              };

              if (nextGroupAxis) {
                const getter = docGetters[nextGroupAxis];
                const groups = {};
                selectedDocs.forEach((docId) => {
                  const doc = store.documents[docId];
                  if (!doc) return;
                  const key = getter(doc);
                  if (!groups[key]) groups[key] = [];
                  groups[key].push({ docId, doc });
                });

                const cm = colorMap[nextGroupAxis] || colorMap.carrier;
                Object.entries(groups).forEach(([groupId, docs]) => {
                  const groupName = nameGetters[nextGroupAxis](groupId);
                  nodes.push({
                    id: groupId,
                    label: `${groupName}\n(${docs.length}ê±´)`,
                    level: baseLevel,
                    color: { background: cm.bg, border: cm.border },
                    shape: 'dot',
                    size: Math.max(12, Math.min(25, 10 + docs.length * 0.5)),
                    font: { color: cm.font, size: 11 },
                    borderWidth: 2,
                  });
                  edges.push({ from: selId, to: groupId, color: '#bdc3c7', width: 2 });

                  docs.forEach(({ docId, doc }) => {
                    nodes.push({
                      id: docId,
                      label: docLabel(doc),
                      level: baseLevel + 1,
                      color: tierColors[doc.tier] || '#95a5a6',
                      shape: 'dot',
                      size: 14,
                      font: { size: 9 },
                    });
                    edges.push({ from: groupId, to: docId, color: '#bdc3c7' });
                  });
                });
              } else {
                // ëª¨ë“  ì¶•ì´ ì‚¬ìš©ë¨ â†’ ë¬¸ì„œë§Œ ë‚˜ì—´
                selectedDocs.forEach((docId) => {
                  const doc = store.documents[docId];
                  if (!doc) return;
                  nodes.push({
                    id: docId,
                    label: `${doc.name}\n[${doc.tier}]`,
                    level: baseLevel,
                    color: tierColors[doc.tier] || '#95a5a6',
                    shape: 'dot',
                    size: 14,
                    font: { size: 9 },
                  });
                  edges.push({ from: selId, to: docId, color: '#bdc3c7' });
                });
              }

              network.setData({ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) });
              network.fit();
              return;
            }

            // === ë¬¸ì„œ ì„ íƒ: ì „ì²´ ë©”íƒ€ ê²½ë¡œ í‘œì‹œ ===
            // ë³´í—˜ì‚¬ â†’ ìƒí’ˆ â†’ ë¬¸ì„œìœ í˜• â†’ ë¬¸ì„œ â† í”„ë¡œì„¸ìŠ¤, ì—­í• 
            if (selectedDocId.value) {
              const doc = store.documents[selectedDocId.value];
              if (doc) {
                const _carrier = getDocCarrier(doc);
                const _product = getDocProduct(doc);
                const _docType = getDocDocType(doc);
                // ë³´í—˜ì‚¬ (level 0)
                nodes.push({
                  id: _carrier,
                  label: getCarrierName(_carrier),
                  level: 0,
                  shape: 'dot',
                  size: 30,
                  borderWidth: 3,
                  color: { background: '#e1bee7', border: '#8e44ad' },
                  font: { color: '#4a148c', size: 13, bold: true },
                });

                // ìƒí’ˆ (level 1)
                nodes.push({
                  id: _product,
                  label: getProductName(_product),
                  level: 1,
                  color: { background: '#bbdefb', border: '#1976d2' },
                  shape: 'dot',
                  size: 25,
                  font: { color: '#0d47a1', size: 12 },
                  borderWidth: 2,
                });
                edges.push({ from: _carrier, to: _product, color: '#85c1e9', width: 2 });

                // ë¬¸ì„œìœ í˜• (level 2)
                const dt = store.taxonomy.docTypes[_docType];
                nodes.push({
                  id: _docType,
                  label: getDocTypeName(_docType),
                  level: 2,
                  color: { background: '#c8e6c9', border: '#27ae60' },
                  shape: 'dot',
                  size: 22,
                  font: { color: '#1b5e20', size: 11 },
                  borderWidth: 2,
                });
                edges.push({ from: _product, to: _docType, color: '#a9dfbf', width: 2 });

                // ì„ íƒëœ ë¬¸ì„œ (level 3, ê°•ì¡°)
                nodes.push({
                  id: selectedDocId.value,
                  label: `${doc.name}\n[${doc.tier}]`,
                  level: 3,
                  color: '#2563eb',
                  shape: 'dot',
                  size: 22,
                  borderWidth: 4,
                  font: { color: '#1e3a5f', size: 11, bold: true },
                });
                edges.push({ from: _docType, to: selectedDocId.value, color: '#2563eb', width: 2 });

                // í”„ë¡œì„¸ìŠ¤ (level 4, ë¬¸ì„œì—ì„œ ë¶„ê¸°)
                const _process = getDocMeta(doc, 'process');
                if (_process && store.taxonomy.processes[_process]) {
                  nodes.push({
                    id: _process,
                    label: getProcessName(_process),
                    level: 4,
                    color: { background: '#ffe0b2', border: '#e67e22' },
                    shape: 'dot',
                    size: 18,
                    font: { color: '#e65100', size: 10 },
                    borderWidth: 2,
                  });
                  edges.push({ from: selectedDocId.value, to: _process, color: '#f5cba7', width: 1, dashes: true });
                }

                // ì—­í•  (level 4, ë¬¸ì„œì—ì„œ ë¶„ê¸°)
                const _audience = getDocMeta(doc, 'audience');
                if (_audience && store.taxonomy.audiences[_audience]) {
                  nodes.push({
                    id: _audience,
                    label: getAudienceName(_audience),
                    level: 4,
                    color: { background: '#b2ebf2', border: '#00bcd4' },
                    shape: 'dot',
                    size: 18,
                    font: { color: '#006064', size: 10 },
                    borderWidth: 2,
                  });
                  edges.push({ from: selectedDocId.value, to: _audience, color: '#80deea', width: 1, dashes: true });
                }

                // ì—°ê´€ ë¬¸ì„œ (relations)
                const related = getRelatedDocIds(selectedDocId.value);
                related.forEach((relId) => {
                  const relDoc = store.documents[relId];
                  if (!relDoc || nodes.find((n) => n.id === relId)) return;
                  nodes.push({
                    id: relId,
                    label: `${relDoc.name}`,
                    level: 4,
                    color: '#3b82f6',
                    shape: 'dot',
                    size: 14,
                    borderWidth: 2,
                    font: { size: 9 },
                  });
                  edges.push({ from: selectedDocId.value, to: relId, color: '#6366f1', width: 1, dashes: [5, 5] });
                });

                network.setData({ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) });
                network.fit();
                return;
              }
            }

            // === ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ê²°ê³¼ ê·¸ë˜í”„ ===
            const sq = appliedSearch.value.toLowerCase();
            if (sq) {
              const matchedDocs = Object.entries(store.documents).filter(([id, doc]) => matchesSearch(doc, id, sq));
              nodes.push({
                id: 'SEARCH-ROOT',
                label: `"${appliedSearch.value}" ê²€ìƒ‰ ê²°ê³¼\n(${matchedDocs.length}ê±´)`,
                level: 0,
                shape: 'dot',
                size: 40,
                borderWidth: 3,
                color: { background: '#fff3e0', border: '#f57c00' },
                font: { color: '#e65100', size: 14, bold: true },
              });

              // ë³´í—˜ì‚¬ë³„ ê·¸ë£¹
              const carrierGroups = {};
              matchedDocs.forEach(([docId, doc]) => {
                const c = getDocCarrier(doc);
                if (!carrierGroups[c]) carrierGroups[c] = [];
                carrierGroups[c].push({ docId, doc });
              });

              Object.entries(carrierGroups).forEach(([cId, docs]) => {
                const cName = getCarrierName(cId);
                nodes.push({
                  id: cId,
                  label: `${cName}\n(${docs.length}ê±´)`,
                  level: 1,
                  color: { background: '#e1bee7', border: '#8e44ad' },
                  shape: 'dot',
                  size: Math.max(12, Math.min(28, 10 + docs.length * 0.3)),
                  font: { color: '#4a148c', size: 11 },
                  borderWidth: 2,
                });
                edges.push({ from: 'SEARCH-ROOT', to: cId, color: '#bdc3c7', width: 2 });

                // ìƒí’ˆë³„ í•˜ìœ„ ê·¸ë£¹
                const prodGroups = {};
                docs.forEach(({ docId, doc }) => {
                  const p = getDocProduct(doc);
                  if (!prodGroups[p]) prodGroups[p] = [];
                  prodGroups[p].push({ docId, doc });
                });

                Object.entries(prodGroups).forEach(([pId, pDocs]) => {
                  const pNodeId = `${cId}-${pId}`;
                  nodes.push({
                    id: pNodeId,
                    label: `${getProductName(pId)}\n(${pDocs.length}ê±´)`,
                    level: 2,
                    color: { background: '#bbdefb', border: '#1976d2' },
                    shape: 'dot',
                    size: Math.max(10, Math.min(22, 8 + pDocs.length * 0.5)),
                    font: { color: '#0d47a1', size: 10 },
                    borderWidth: 1,
                  });
                  edges.push({ from: cId, to: pNodeId, color: '#85c1e9' });

                  pDocs.forEach(({ docId, doc }) => {
                    nodes.push({
                      id: docId,
                      label: `${getDocTypeName(getDocDocType(doc))}\n[${doc.tier}]`,
                      level: 3,
                      color: tierColors[doc.tier] || '#95a5a6',
                      shape: 'dot',
                      size: 12,
                      font: { size: 9 },
                    });
                    edges.push({ from: pNodeId, to: docId, color: '#bdc3c7' });
                  });
                });
              });

              network.setData({ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) });
              network.fit();
              return;
            }

            // === ì„ íƒ ì—†ìŒ: ì „ì²´ êµ¬ì¡° í‘œì‹œ ===
            const totalDocs = Object.keys(store.documents).length;
            nodes.push({
              id: 'ROOT',
              label: `GA ì§€ì‹ê´€ë¦¬ì²´ê³„\n(${totalDocs}ê±´)`,
              level: 0,
              shape: 'dot',
              size: 45,
              font: { color: '#1a1a2e', size: 16, bold: true },
              borderWidth: 3,
              color: { background: '#e8eaf6', border: '#3949ab' },
            });

            // ë³´í—˜ì‚¬ (level 1)
            Object.entries(store.taxonomy.carriers || {}).forEach(([id, c]) => {
              if (id === 'INS-COMMON') return;
              const docCount = Object.values(store.documents).filter((d) => getDocCarrier(d) === id).length;
              nodes.push({
                id,
                label: `${c.name}\n(${docCount})`,
                level: 1,
                color: { background: '#e1bee7', border: '#8e44ad' },
                shape: 'dot',
                size: Math.max(15, Math.min(30, 10 + docCount * 0.3)),
                font: { color: '#4a148c', size: 12 },
                borderWidth: 2,
              });
              edges.push({ from: 'ROOT', to: id, color: '#bdc3c7' });
            });

            // ìƒí’ˆ ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹
            const categories = store.taxonomy.productCategories || {};
            Object.entries(categories).forEach(([catId, cat]) => {
              const catNodeId = `CAT-${catId}`;
              nodes.push({
                id: catNodeId,
                label: cat.name,
                level: 2,
                color: { background: '#bbdefb', border: '#1976d2' },
                shape: 'box',
                size: 20,
                font: { color: '#0d47a1', size: 11, bold: true },
                borderWidth: 1,
              });
              edges.push({ from: 'ROOT', to: catNodeId, color: '#85c1e9', dashes: true });

              Object.entries(store.taxonomy.products || {}).forEach(([prdId, prd]) => {
                if (prdId === 'PRD-COMMON' || prd.category !== catId) return;
                const prdDocCount = Object.values(store.documents).filter((d) => getDocProduct(d) === prdId).length;
                nodes.push({
                  id: prdId,
                  label: `${prd.name}\n(${prdDocCount})`,
                  level: 3,
                  color: '#2980b9',
                  shape: 'dot',
                  size: Math.max(10, Math.min(22, 8 + prdDocCount * 0.3)),
                  font: { size: 10 },
                });
                edges.push({ from: catNodeId, to: prdId, color: '#85c1e9' });
              });
            });

            // ë¬¸ì„œìœ í˜•
            const dtGroupId = 'GROUP-DOCTYPE';
            nodes.push({
              id: dtGroupId,
              label: 'ë¬¸ì„œìœ í˜•',
              level: 1,
              color: { background: '#c8e6c9', border: '#27ae60' },
              shape: 'box',
              font: { color: '#1b5e20', size: 12, bold: true },
              borderWidth: 2,
            });
            edges.push({ from: 'ROOT', to: dtGroupId, color: '#bdc3c7' });

            Object.entries(store.taxonomy.docTypes || {}).forEach(([dtId, dt]) => {
              const dtDocCount = Object.values(store.documents).filter((d) => getDocDocType(d) === dtId).length;
              if (dtDocCount === 0) return;
              nodes.push({
                id: dtId,
                label: `${dt.name}\n(${dtDocCount})`,
                level: 2,
                color: tierColors[dt.tier] || '#27ae60',
                shape: 'dot',
                size: Math.max(8, Math.min(20, 6 + dtDocCount * 0.2)),
                font: { size: 9 },
              });
              edges.push({ from: dtGroupId, to: dtId, color: '#a9dfbf' });
            });

            // í”„ë¡œì„¸ìŠ¤
            const procGroupId = 'GROUP-PROCESS';
            nodes.push({
              id: procGroupId,
              label: 'í”„ë¡œì„¸ìŠ¤',
              level: 1,
              color: { background: '#ffe0b2', border: '#e67e22' },
              shape: 'box',
              font: { color: '#e65100', size: 12, bold: true },
              borderWidth: 2,
            });
            edges.push({ from: 'ROOT', to: procGroupId, color: '#bdc3c7' });

            const sortedProcs = Object.entries(store.taxonomy.processes || {})
              .filter(([id]) => id !== 'PRC-COMMON')
              .sort((a, b) => (a[1].order || 0) - (b[1].order || 0));
            let prevProcId = null;
            sortedProcs.forEach(([procId, proc]) => {
              nodes.push({
                id: procId,
                label: proc.name,
                level: 2,
                color: '#e67e22',
                shape: 'dot',
                size: 12,
                font: { size: 10 },
              });
              edges.push({ from: procGroupId, to: procId, color: '#f5cba7' });
              if (prevProcId) {
                edges.push({ from: prevProcId, to: procId, color: '#e67e22', width: 2, arrows: 'to' });
              }
              prevProcId = procId;
            });

            // ì—­í• 
            const audGroupId = 'GROUP-AUDIENCE';
            nodes.push({
              id: audGroupId,
              label: 'ì—­í• ',
              level: 1,
              color: { background: '#b2ebf2', border: '#00bcd4' },
              shape: 'box',
              font: { color: '#006064', size: 12, bold: true },
              borderWidth: 2,
            });
            edges.push({ from: 'ROOT', to: audGroupId, color: '#bdc3c7' });

            Object.entries(store.taxonomy.audiences || {}).forEach(([audId, aud]) => {
              if (audId === 'AUD-COMMON') return;
              nodes.push({
                id: audId,
                label: aud.name,
                level: 2,
                color: '#00bcd4',
                shape: 'dot',
                size: 12,
                font: { size: 10 },
              });
              edges.push({ from: audGroupId, to: audId, color: '#80deea' });
            });

            network.setData({ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) });
            network.fit();
          }

          function rebuildDetailGraph() {
            const nodes = [];
            const edges = [];
            const addedNodes = new Set();
            const tierColors = { HOT: '#e74c3c', WARM: '#f39c12', COLD: '#95a5a6' };

            // ë¶„ë¥˜ í•­ëª© ì„ íƒ ì‹œ í•´ë‹¹ ë¬¸ì„œë“¤ í‘œì‹œ
            let docIdsToShow;
            if (highlightedDocs.value.length > 0) {
              docIdsToShow = new Set(highlightedDocs.value);
            } else if (selectedDocId.value) {
              const related = getRelatedDocIds(selectedDocId.value);
              docIdsToShow = new Set([selectedDocId.value, ...related]);
            } else if (selectedTaxonomy.type) {
              const taxDocs = getDocsByTaxonomySelection() || [];
              docIdsToShow = new Set(taxDocs);
            } else {
              docIdsToShow = new Set(Object.keys(store.documents).slice(0, 30));
            }

            nodes.push({
              id: 'ROOT',
              label: `GA ì§€ì‹ê´€ë¦¬ì²´ê³„\n(${Object.keys(store.documents).length}ê±´)`,
              level: 0,
              color: { background: '#e8eaf6', border: '#3949ab' },
              shape: 'dot',
              size: 35,
              font: { color: '#1a1a2e', size: 14, bold: true },
              borderWidth: 3,
            });
            addedNodes.add('ROOT');

            const usedCarriers = new Set();
            docIdsToShow.forEach((docId) => {
              const doc = store.documents[docId];
              const c = doc ? getDocCarrier(doc) : '';
              if (c) usedCarriers.add(c);
            });

            usedCarriers.forEach((carrierId) => {
              const c = store.taxonomy.carriers[carrierId];
              if (!c || carrierId === 'INS-COMMON') return;
              nodes.push({
                id: carrierId,
                label: c.name,
                level: 1,
                color: { background: '#e1bee7', border: '#8e44ad' },
                shape: 'dot',
                size: 25,
                font: { color: '#4a148c', size: 12 },
                borderWidth: 2,
              });
              edges.push({ from: 'ROOT', to: carrierId, color: '#bdc3c7' });
              addedNodes.add(carrierId);
            });

            docIdsToShow.forEach((id) => {
              const doc = store.documents[id];
              if (!doc) return;

              const isHighlighted = highlightedDocs.value.includes(id);
              const isSelected = id === selectedDocId.value;

              nodes.push({
                id,
                label: getDocTypeName(getDocDocType(doc)),
                level: 2,
                color: isSelected ? '#2563eb' : isHighlighted ? '#3b82f6' : tierColors[doc.tier] || '#95a5a6',
                shape: 'dot',
                size: isSelected ? 22 : isHighlighted ? 18 : 15,
                borderWidth: isSelected ? 4 : isHighlighted ? 3 : 1,
              });
              addedNodes.add(id);

              const docC = getDocCarrier(doc);
              if (docC && addedNodes.has(docC)) {
                edges.push({ from: docC, to: id, color: '#bdc3c7' });
              }

              if (doc.relations?.parent && addedNodes.has(doc.relations.parent)) {
                edges.push({ from: doc.relations.parent, to: id, color: '#6366f1', width: 2 });
              }
              (doc.relations?.children || []).forEach((childId) => {
                if (addedNodes.has(childId)) edges.push({ from: id, to: childId, color: '#6366f1', width: 2 });
              });
              (doc.relations?.siblings || []).forEach((sibId) => {
                if (addedNodes.has(sibId)) edges.push({ from: id, to: sibId, color: '#27ae60', dashes: true });
              });
              (doc.relations?.references || []).forEach((refId) => {
                if (addedNodes.has(refId)) edges.push({ from: id, to: refId, color: '#9b59b6', dashes: [5, 5] });
              });
            });

            network.setData({ nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) });
          }

          function fitGraph() {
            network?.fit({ animation: true });
          }

          function highlightRelatedDocs() {
            if (!selectedDocId.value) return;
            const relatedIds = getRelatedDocIds(selectedDocId.value);
            highlightedDocs.value = [selectedDocId.value, ...relatedIds];
            rebuildGraph();
            showToast(`${relatedIds.length}ê°œ ì—°ê´€ ë¬¸ì„œ ì „íŒŒë¨`, 'success');
          }

          function getRelatedDocIds(docId, visited = new Set()) {
            if (visited.has(docId)) return [];
            visited.add(docId);

            const doc = store.documents[docId];
            if (!doc) return [];

            let related = [];

            // ë¶€ëª¨
            if (doc.relations?.parent && !visited.has(doc.relations.parent)) {
              related.push(doc.relations.parent);
              visited.add(doc.relations.parent);
            }

            // ìì‹
            (doc.relations?.children || []).forEach((childId) => {
              if (!visited.has(childId)) {
                related.push(childId);
                visited.add(childId);
              }
            });

            // í˜•ì œ (ì¬ê·€ ì „íŒŒ)
            (doc.relations?.siblings || []).forEach((sibId) => {
              if (!visited.has(sibId)) {
                related.push(sibId);
                related = related.concat(getRelatedDocIds(sibId, visited));
              }
            });

            // ì°¸ì¡°
            (doc.relations?.references || []).forEach((refId) => {
              if (!visited.has(refId)) {
                related.push(refId);
              }
            });

            return [...new Set(related)];
          }

          function applySearch() {
            appliedSearch.value = searchQuery.value.trim();
            // ê²€ìƒ‰ ì‹œ ì„ íƒ ì´ˆê¸°í™”í•˜ê³  ê·¸ë˜í”„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            selectedDocId.value = null;
            selectedTaxonomy.type = null;
            selectedTaxonomy.id = null;
            highlightedDocs.value = [];
            listDrillPath.splice(0);
            setTimeout(() => rebuildGraph(), 0);
          }

          function clearSearch() {
            searchQuery.value = '';
            appliedSearch.value = '';
            setTimeout(() => rebuildGraph(), 0);
          }

          function clearSelection() {
            selectedDocId.value = null;
            selectedTaxonomy.type = null;
            selectedTaxonomy.id = null;
            highlightedDocs.value = [];
            listDrillPath.splice(0);
            setTimeout(() => rebuildGraph(), 0);
          }

          function selectDocument(id) {
            selectedTaxonomy.type = null;
            selectedTaxonomy.id = null;
            selectedDocId.value = id;
            highlightedDocs.value = [];
            // ë“œë¦´ ê²½ë¡œì— ë¬¸ì„œì˜ ë³´í—˜ì‚¬/ìƒí’ˆ ì¶”ê°€
            const doc = store.documents[id];
            if (doc) {
              listDrillPath.splice(0);
              listDrillPath.push({ type: 'carrier', id: getDocCarrier(doc) });
              listDrillPath.push({ type: 'product', id: getDocProduct(doc) });
            }
            setTimeout(() => rebuildGraph(), 0);
          }

          function selectTaxonomy(type, id) {
            selectedDocId.value = null;
            highlightedDocs.value = [];
            selectedTaxonomy.type = type;
            selectedTaxonomy.id = id;
            // ë“œë¦´ ê²½ë¡œ ì—…ë°ì´íŠ¸
            const existingIdx = listDrillPath.findIndex((p) => p.type === type);
            if (existingIdx >= 0) {
              listDrillPath.splice(existingIdx);
            }
            listDrillPath.push({ type, id });
            setTimeout(() => rebuildGraph(), 0);
          }

          // ë“œë¦´ ê²½ë¡œì˜ íŠ¹ì • ë ˆë²¨ë¡œ ì´ë™
          function drillTo(index) {
            if (index < 0) {
              clearSelection();
              return;
            }
            const target = listDrillPath[index];
            listDrillPath.splice(index + 1);
            selectedDocId.value = null;
            highlightedDocs.value = [];
            selectedTaxonomy.type = target.type;
            selectedTaxonomy.id = target.id;
            setTimeout(() => rebuildGraph(), 0);
          }

          // ë¦¬ìŠ¤íŠ¸ë·°ì—ì„œ í˜„ì¬ í•„í„° ì¡°ê±´ì— ë§ëŠ” ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
          function getFilteredDocsForDrill() {
            let docs = Object.entries(store.documents);
            const getterMap = {
              carrier: getDocCarrier,
              product: getDocProduct,
              docType: getDocDocType,
              process: (d) => getDocMeta(d, 'process'),
              audience: (d) => getDocMeta(d, 'audience'),
            };
            listDrillPath.forEach((step) => {
              const getter = getterMap[step.type];
              if (getter) {
                docs = docs.filter(([_, d]) => getter(d) === step.id);
              }
            });
            return docs;
          }

          // ë¦¬ìŠ¤íŠ¸ë·°ì—ì„œ ë‹¤ìŒ ë“œë¦´ ë‹¨ê³„ì˜ í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
          function getSubCategoriesForDrill() {
            const docs = getFilteredDocsForDrill();

            // ë™ì  ë“œë¦´ ìˆœì„œ (ì‹œì‘ ì¶• ê¸°ì¤€)
            const drillOrder = getDrillOrder();
            const usedTypes = new Set(listDrillPath.map((p) => p.type));
            const nextTypes = drillOrder.filter((t) => !usedTypes.has(t));

            if (nextTypes.length === 0) return [];

            const nextType = nextTypes[0];
            const getterMap = {
              carrier: getDocCarrier,
              product: getDocProduct,
              docType: getDocDocType,
              process: (d) => getDocMeta(d, 'process'),
              audience: (d) => getDocMeta(d, 'audience'),
            };
            const getter = getterMap[nextType];
            if (!getter) return [];

            const groups = {};
            docs.forEach(([docId, doc]) => {
              const key = getter(doc);
              if (!key) return;
              if (!groups[key]) groups[key] = { id: key, type: nextType, count: 0 };
              groups[key].count++;
            });

            return Object.values(groups).sort((a, b) => b.count - a.count);
          }

          // í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
          function getDrillCategoryName(type, id) {
            const nameMap = { carrier: getCarrierName, product: getProductName, docType: getDocTypeName, process: getProcessName, audience: getAudienceName };
            return nameMap[type] ? nameMap[type](id) : id;
          }

          const TAXONOMY_STORE_MAP = {
            carrier: 'carriers',
            product: 'products',
            docType: 'docTypes',
            process: 'processes',
            audience: 'audiences',
            certification: 'certifications',
          };
          const TAXONOMY_TYPE_LABELS = {
            carrier: 'ë³´í—˜ì‚¬',
            product: 'ìƒí’ˆ',
            docType: 'ë¬¸ì„œìœ í˜•',
            process: 'í”„ë¡œì„¸ìŠ¤',
            audience: 'ì—­í• ',
            certification: 'ìê²©ì¦',
          };

          function getTaxonomyItem(type, id) {
            const storeKey = TAXONOMY_STORE_MAP[type];
            return storeKey ? store.taxonomy[storeKey]?.[id] : null;
          }

          function getTaxonomyItemName(type, id) {
            return getTaxonomyItem(type, id)?.name || id;
          }

          function getTaxonomyTypeLabel(type) {
            return TAXONOMY_TYPE_LABELS[type] || type;
          }

          function setTaxonomyField(type, id, field, value) {
            const item = getTaxonomyItem(type, id);
            if (item) item[field] = value;
          }

          function checkDuplicate(carrier, product, docType, excludeId = null) {
            const found = Object.entries(store.documents).find(([id, doc]) => {
              if (excludeId && id === excludeId) return false;
              return getDocCarrier(doc) === carrier && getDocProduct(doc) === product && getDocDocType(doc) === docType;
            });
            return found ? found[1] : null;
          }

          function checkDocModalDuplicate() {
            const { domain, carrier, product, docType } = docModal.data;
            const domainDef = store.domains[domain];
            const ssotKey = domainDef?.ssotKey || ['carrier', 'product', 'docType'];
            const vals = { carrier, product, docType };
            // ssotKeyì˜ ëª¨ë“  í•„ë“œê°€ ì±„ì›Œì ¸ì•¼ ê²€ì¦
            if (!ssotKey.every(k => vals[k])) {
              docModal.duplicateWarning = null;
              return;
            }
            const classification = {};
            ssotKey.forEach(k => { classification[k] = vals[k]; });
            const dup = checkSsotViolation(domain, classification);
            docModal.duplicateWarning = dup ? `SSOT ìœ„ë°˜: ${dup.name} (ACTIVE)` : null;
          }

          function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const filename = file.name;
            const normalized = filename
              .toLowerCase()
              .replace(/[_\-\.]/g, ' ')
              .replace(/\s+/g, ' ');

            let carrier = '',
              product = '',
              docType = '';
            let carrierConf = 0,
              productConf = 0,
              docTypeConf = 0;
            let version = '';

            // ë³´í—˜ì‚¬ ë§¤ì¹­
            for (const [id, c] of Object.entries(store.taxonomy.carriers)) {
              if (id === 'INS-COMMON') continue;
              const names = [c.name.toLowerCase(), ...(c.alias || []).map((a) => a.toLowerCase())];
              for (const name of names) {
                if (name && normalized.includes(name)) {
                  carrier = id;
                  carrierConf = name.length > 2 ? 0.9 : 0.7;
                  break;
                }
              }
              if (carrier) break;
            }

            // ìƒí’ˆ ë§¤ì¹­
            for (const [id, p] of Object.entries(store.taxonomy.products)) {
              if (id === 'PRD-COMMON') continue;
              const names = [p.name.toLowerCase(), ...(p.alias || []).map((a) => a.toLowerCase())];
              for (const name of names) {
                if (name && name.length > 1 && normalized.includes(name)) {
                  product = id;
                  productConf = name.length > 2 ? 0.85 : 0.6;
                  break;
                }
              }
              if (product) break;
            }

            // ë¬¸ì„œìœ í˜• ë§¤ì¹­ (í‚¤ì›Œë“œ ê¸°ë°˜)
            const DOC_TYPE_KEYWORDS = {
              'DOC-TERMS': ['ì•½ê´€', 'ë³´í†µì•½ê´€'],
              'DOC-TERMS-SPECIAL': ['íŠ¹ë³„ì•½ê´€', 'íŠ¹ì•½'],
              'DOC-GUIDE': ['ìƒí’ˆì„¤ëª…ì„œ', 'ìƒí’ˆì„¤ëª…', 'ì„¤ëª…ì„œ'],
              'DOC-RATE-TABLE': ['ë³´í—˜ë£Œí‘œ', 'ìš”ìœ¨í‘œ', 'ë³´í—˜ë£Œ'],
              'DOC-BROCHURE': ['ë¸Œë¡œìŠˆì–´', 'brochure', 'ë¦¬í”Œë ›'],
              'DOC-PRODUCT-SUMMARY': ['ìƒí’ˆìš”ì•½', 'ìš”ì•½ì„œ', 'ìš”ì•½ë³¸', 'ìš”ì•½'],
              'DOC-SCRIPT': ['ìŠ¤í¬ë¦½íŠ¸', 'í™”ë²•', 'íŒë§¤ìŠ¤í¬ë¦½íŠ¸'],
              'DOC-COMPARISON': ['ë¹„êµí‘œ', 'ë¹„êµ', 'ìƒí’ˆë¹„êµ'],
              'DOC-PROPOSAL': ['ê°€ì…ì„¤ê³„', 'ì„¤ê³„ì„œ'],
              'DOC-INCENTIVE': ['ì‹œì±…', 'ì¸ì„¼í‹°ë¸Œ'],
              'DOC-COMMISSION': ['ìˆ˜ìˆ˜ë£Œ', 'ì»¤ë¯¸ì…˜'],
              'DOC-COMMISSION-CALC': ['ìˆ˜ìˆ˜ë£Œê³„ì‚°', '1200'],
              'DOC-APPLICATION': ['ì²­ì•½ì„œ', 'ì²­ì•½'],
              'DOC-DISCLOSURE': ['ê³ ì§€', 'ê³ ì§€ì‚¬í•­'],
              'DOC-TRAINING': ['êµìœ¡ìë£Œ', 'êµìœ¡', 'ì—°ìˆ˜'],
              'DOC-ONBOARDING': ['ì‹ ì…êµìœ¡', 'ì˜¨ë³´ë”©', 'ì‹ ì…'],
              'DOC-UW-GUIDE': ['ì‹¬ì‚¬ê°€ì´ë“œ', 'ì‹¬ì‚¬'],
              'DOC-UW-DISEASE': ['ì§ˆë³‘ì‹¬ì‚¬', 'ì§ˆë³‘ë³„'],
              'DOC-REGULATION': ['ê°ë…ê·œì •', 'ê·œì •'],
              'DOC-COMPLIANCE': ['ì»´í”Œë¼ì´ì–¸ìŠ¤', 'ì¤€ë²•'],
              'DOC-SETTLEMENT': ['ì •ì‚°', 'ì •ì‚°ìë£Œ'],
              'DOC-CHARGEBACK': ['í™˜ìˆ˜', 'í™˜ìˆ˜ê¸°ì¤€'],
              'DOC-FAQ': ['faq', 'ìì£¼ë¬»ëŠ”', 'ì§ˆë¬¸'],
            };

            for (const [dtId, keywords] of Object.entries(DOC_TYPE_KEYWORDS)) {
              for (const kw of keywords) {
                if (normalized.includes(kw.toLowerCase())) {
                  docType = dtId;
                  docTypeConf = kw.length > 2 ? 0.85 : 0.65;
                  break;
                }
              }
              if (docType) break;
            }

            // ë‚ ì§œ/ë²„ì „ ì¶”ì¶œ
            const dateMatch = filename.match(/(\d{4})[\-_]?(\d{2})/);
            if (dateMatch) {
              version = `${dateMatch[1]}ë…„ ${dateMatch[2]}ì›”`;
            }
            const verMatch = filename.match(/[vV](?:er\.?)?(\d+(?:\.\d+)?)/);
            if (verMatch) {
              version = (version ? version + ', ' : '') + `ë²„ì „ ${verMatch[1]}`;
            }

            // ì¤‘ë³µ ì²´í¬
            let dupWarning = null;
            if (carrier && product && docType) {
              const dup = checkDuplicate(carrier, product, docType);
              if (dup) dupWarning = `ì´ë¯¸ ì¡´ì¬: ${dup.name}`;
            }

            uploadPreview.show = true;
            uploadPreview.filename = filename;
            uploadPreview.data = { carrier, product, docType, version };
            uploadPreview.confidence = { carrier: carrierConf, product: productConf, docType: docTypeConf };
            uploadPreview.duplicateWarning = dupWarning;

            event.target.value = '';
          }

          function checkUploadDuplicate() {
            const { carrier, product, docType } = uploadPreview.data;
            if (!carrier || !product || !docType) {
              uploadPreview.duplicateWarning = null;
              return;
            }
            const dup = checkDuplicate(carrier, product, docType);
            uploadPreview.duplicateWarning = dup ? `ì´ë¯¸ ì¡´ì¬: ${dup.name}` : null;
          }

          function createFromUpload() {
            const { carrier, product, docType } = uploadPreview.data;
            if (!docType) return;
            if (uploadPreview.duplicateWarning) return;

            // ìë™ ì±„ë²ˆ + ë„ë©”ì¸ ìë™ ë§¤í•‘
            const id = generateDocId();
            const carrierObj = store.taxonomy.carriers[carrier];
            const productObj = store.taxonomy.products[product];
            const docTypeObj = store.taxonomy.docTypes[docType];
            const domain = store.docTypeDomainMap?.[docType] || 'GA-SALES';
            const facetIds = getDomainFacetIds(domain);

            // ë„ë©”ì¸ facetsì— ë§ëŠ” classificationë§Œ êµ¬ì„±
            const classification = { docType };
            if (facetIds.has('carrier') && carrier) classification.carrier = carrier;
            if (facetIds.has('product') && product) classification.product = product;

            const nameParts = [];
            if (classification.carrier) nameParts.push(carrierObj?.name || carrier);
            if (classification.product) nameParts.push(productObj?.name || product);
            nameParts.push(docTypeObj?.name || docType);
            const docName = nameParts.join(' ');

            store.documents[id] = {
              id,
              name: docName,
              domain: domain,
              lifecycle: 'DRAFT',
              version: { major: 1, minor: 0 },
              classification,
              meta: { process: '', audience: '' },
              tier: docTypeObj?.tier || 'COLD',
              content: '',
              relations: { parent: null, children: [], siblings: [], references: [], supersedes: null, supersededBy: null },
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              reviewedAt: null,
            };

            saveStore();
            selectDocument(id);
            uploadPreview.show = false;
            showToast(`ë¬¸ì„œ ìƒì„± (${id}): ${docName}`, 'success');
          }

          function showAddModal(type) {
            const titles = { carrier: 'ë³´í—˜ì‚¬ ì¶”ê°€', product: 'ìƒí’ˆ ì¶”ê°€' };
            modal.show = true;
            modal.type = type;
            modal.title = titles[type];
            modal.data = { id: '', name: '', alias: '', category: 'LIFE', insurerType: 'life', supersedes: '' };
          }

          function addTaxonomy() {
            const { type, data } = modal;
            if (!data.id || !data.name) return showToast('IDì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');

            if (type === 'carrier') {
              store.taxonomy.carriers[data.id] = {
                name: data.name,
                alias: [],
                type: data.insurerType,
                tier: 'mid',
              };
            } else if (type === 'product') {
              const newProduct = {
                name: data.name,
                category: data.category || 'LIFE',
                alias: [],
              };
              if (data.supersedes) {
                newProduct.supersedes = data.supersedes;
              }
              store.taxonomy.products[data.id] = newProduct;
            }

            saveStore();
            modal.show = false;
            showToast(`${type === 'carrier' ? 'ë³´í—˜ì‚¬' : 'ìƒí’ˆ'}ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
          }

          function showAddDocModal() {
            docModal.show = true;
            docModal.data = { domain: 'GA-SALES', carrier: '', product: '', docType: '', process: '', audience: '', name: '' };
            docModal.duplicateWarning = null;
          }

          function onDocModalDomainChange() {
            // ë„ë©”ì¸ ë³€ê²½ ì‹œ í•´ë‹¹ ë„ë©”ì¸ì— ì—†ëŠ” facet ê°’ ì´ˆê¸°í™”
            const domain = docModal.data.domain;
            if (!domainHasFacet(domain, 'carrier')) docModal.data.carrier = '';
            if (!domainHasFacet(domain, 'product')) docModal.data.product = '';
            // docType ê¸°ë°˜ ë„ë©”ì¸ ìë™ ë§¤í•‘ (ì—­ë°©í–¥)
            if (docModal.data.docType) {
              const mappedDomain = store.docTypeDomainMap?.[docModal.data.docType];
              if (mappedDomain && mappedDomain !== domain) {
                docModal.data.docType = '';
              }
            }
            checkDocModalDuplicate();
          }

          function createDocument() {
            const { domain, carrier, product, docType, process, audience, name } = docModal.data;
            const domainDef = store.domains[domain];
            const facetIds = getDomainFacetIds(domain);

            // í•„ìˆ˜ facet ê²€ì¦
            if (facetIds.has('carrier') && !carrier) return showToast('ë³´í—˜ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
            if (facetIds.has('product') && !product) return showToast('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”', 'error');
            if (!docType) return showToast('ë¬¸ì„œìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”', 'error');

            if (docModal.duplicateWarning) {
              return showToast('ì¤‘ë³µ ë¬¸ì„œê°€ ì¡´ì¬í•©ë‹ˆë‹¤', 'error');
            }

            // ìë™ ì±„ë²ˆ (ìœ„ì¹˜ ë¬´ê´€ ID)
            const id = generateDocId();
            const docTypeObj = store.taxonomy.docTypes[docType];
            const carrierObj = store.taxonomy.carriers[carrier];
            const productObj = store.taxonomy.products[product];

            // ë„ë©”ì¸ facetsì— ë§ëŠ” classificationë§Œ êµ¬ì„±
            const classification = { docType };
            if (facetIds.has('carrier')) classification.carrier = carrier;
            if (facetIds.has('product')) classification.product = product;

            // ë¬¸ì„œëª… ìë™ ìƒì„±
            const nameParts = [];
            if (classification.carrier) nameParts.push(carrierObj?.name || carrier);
            if (classification.product) nameParts.push(productObj?.name || product);
            nameParts.push(docTypeObj?.name || docType);
            const docName = name || nameParts.join(' ');

            store.documents[id] = {
              id,
              name: docName,
              domain: domain,
              lifecycle: 'DRAFT',
              version: { major: 1, minor: 0 },
              classification,
              meta: { process: process || '', audience: audience || '' },
              tier: docTypeObj?.tier || 'COLD',
              content: '',
              relations: { parent: null, children: [], siblings: [], references: [], supersedes: null, supersededBy: null },
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              reviewedAt: null,
            };

            saveStore();
            selectDocument(id);
            docModal.show = false;
            showToast(`ë¬¸ì„œ ìƒì„± (${id})`, 'success');
          }

          // === ì´ë™ ì˜í–¥ ë¶„ì„ (git conflict ë°©ì‹) ===
          function analyzeMoveImpact(docId, newDomain) {
            const doc = store.documents[docId];
            if (!doc) return null;
            const oldDomain = doc.domain || 'GA-SALES';
            const relations = doc.relations || {};
            const newFacets = getDomainFacetIds(newDomain);
            const oldFacets = getDomainFacetIds(oldDomain);

            const autoResolved = [];
            const preserved = [];
            const conflicts = [];

            // ì œê±°ë  classification í•„ë“œ
            const removedFields = [];
            Object.keys(doc.classification || {}).forEach(k => {
              if (!newFacets.has(k)) removedFields.push(k);
            });
            if (removedFields.length > 0) {
              autoResolved.push({
                type: 'classification',
                icon: 'ğŸ”„',
                message: `classification í•„ë“œ ì œê±°: ${removedFields.join(', ')} (${newDomain} facetsì— ì—†ìŒ)`,
              });
            }

            // ë¶€ëª¨ ê´€ê³„
            if (relations.parent) {
              const parentDoc = store.documents[relations.parent];
              const parentDomain = parentDoc?.domain || 'GA-SALES';
              if (parentDomain !== newDomain) {
                conflicts.push({
                  type: 'parent',
                  relType: 'parent',
                  targetId: relations.parent,
                  targetName: parentDoc?.name || relations.parent,
                  targetDomain: parentDomain,
                  icon: 'â¬†ï¸',
                  message: `ë¶€ëª¨ "${parentDoc?.name}" (${parentDomain}) â€” ë„ë©”ì¸ì´ ë‹¬ë¼ì§`,
                  defaultAction: 'sever',
                });
              } else {
                preserved.push({
                  type: 'parent',
                  icon: 'â¬†ï¸',
                  message: `ë¶€ëª¨ "${parentDoc?.name}" â€” ê°™ì€ ë„ë©”ì¸, ìœ ì§€`,
                });
              }
            }

            // ìì‹ ê´€ê³„
            const children = relations.children || [];
            if (children.length > 0) {
              const childNames = children.map(cid => store.documents[cid]?.name || cid).slice(0, 3);
              const more = children.length > 3 ? ` ì™¸ ${children.length - 3}ê±´` : '';
              autoResolved.push({
                type: 'children',
                icon: 'â¬‡ï¸',
                message: `ìì‹ ${children.length}ê±´ í•¨ê»˜ ì´ë™: ${childNames.join(', ')}${more}`,
              });
            }

            // í˜•ì œ ê´€ê³„ â†’ ì»¨í”Œë¦­íŠ¸
            const siblings = relations.siblings || [];
            siblings.forEach(sibId => {
              const sibDoc = store.documents[sibId];
              if (!sibDoc) return;
              const sibDomain = sibDoc.domain || 'GA-SALES';
              conflicts.push({
                type: 'sibling',
                relType: 'siblings',
                targetId: sibId,
                targetName: sibDoc.name || sibId,
                targetDomain: sibDomain,
                icon: 'â†”ï¸',
                message: `í˜•ì œ "${sibDoc.name}" (${sibDomain})`,
                defaultAction: sibDomain === newDomain ? 'keep' : 'sever',
              });
            });

            // ë‚˜ê°€ëŠ” ì°¸ì¡° â†’ ë³´ì¡´ (ID ë¶ˆë³€ì´ë¯€ë¡œ)
            const refs = relations.references || [];
            if (refs.length > 0) {
              preserved.push({
                type: 'references_out',
                icon: 'â†’',
                message: `ë‚˜ê°€ëŠ” ì°¸ì¡° ${refs.length}ê±´ â€” ID ë¶ˆë³€, ìœ ì§€`,
              });
            }

            // ë“¤ì–´ì˜¤ëŠ” ì°¸ì¡° â†’ ì»¨í”Œë¦­íŠ¸ (ì°¸ì¡°ìì—ê²Œ ì•Œë¦¼ í•„ìš”)
            const incomingRefs = [];
            Object.entries(store.documents).forEach(([id, d]) => {
              if (id === docId) return;
              if ((d.relations?.references || []).includes(docId)) {
                incomingRefs.push({ id, name: d.name, domain: d.domain || 'GA-SALES' });
              }
            });
            incomingRefs.forEach(ref => {
              conflicts.push({
                type: 'reference_in',
                relType: 'reference_in',
                targetId: ref.id,
                targetName: ref.name,
                targetDomain: ref.domain,
                icon: 'â†',
                message: `"${ref.name}" (${ref.domain})ê°€ ì´ ë¬¸ì„œë¥¼ ì°¸ì¡° ì¤‘`,
                defaultAction: 'keep',
              });
            });

            // SUPERSEDES â†’ ë³´ì¡´
            if (relations.supersedes) {
              preserved.push({
                type: 'supersedes',
                icon: 'ğŸ”—',
                message: `ë²„ì „ ì´ë ¥ (SUPERSEDES) â€” ìœ ì§€`,
              });
            }

            return { autoResolved, preserved, conflicts };
          }

          function showMoveConfirm(docId, newDomain) {
            const doc = store.documents[docId];
            if (!doc) return;
            const oldDomain = doc.domain || 'GA-SALES';
            if (oldDomain === newDomain) return;

            const impact = analyzeMoveImpact(docId, newDomain);
            moveModal.docId = docId;
            moveModal.docName = doc.name;
            moveModal.oldDomain = oldDomain;
            moveModal.newDomain = newDomain;
            moveModal.impact = impact;
            // ê¸°ë³¸ í•´ê²°ì±… ì„¤ì •
            moveModal.resolutions = {};
            impact.conflicts.forEach((c, i) => {
              moveModal.resolutions[`${c.relType}:${c.targetId}`] = c.defaultAction;
            });
            moveModal.show = true;
          }

          function executeMoveWithResolution() {
            const { docId, newDomain, resolutions, impact } = moveModal;
            const doc = store.documents[docId];
            if (!doc) return;
            const oldDomain = doc.domain || 'GA-SALES';

            // 1. ë„ë©”ì¸ + classification ë³€ê²½
            const newFacets = getDomainFacetIds(newDomain);
            doc.domain = newDomain;
            const cls = doc.classification || {};
            const newCls = {};
            Object.entries(cls).forEach(([k, v]) => {
              if (newFacets.has(k)) newCls[k] = v;
            });
            doc.classification = newCls;
            doc.updatedAt = new Date().toISOString();
            if (typeof doc.version === 'object') doc.version.minor += 1;

            // 2. ì»¨í”Œë¦­íŠ¸ í•´ê²° ì ìš©
            let severedCount = 0;
            let keptCount = 0;
            impact.conflicts.forEach(c => {
              const key = `${c.relType}:${c.targetId}`;
              const action = resolutions[key] || c.defaultAction;

              if (action === 'sever') {
                severedCount++;
                if (c.relType === 'parent') {
                  // ë¶€ëª¨ ê´€ê³„ í•´ì œ
                  doc.relations.parent = null;
                  const parentDoc = store.documents[c.targetId];
                  if (parentDoc?.relations?.children) {
                    parentDoc.relations.children = parentDoc.relations.children.filter(id => id !== docId);
                  }
                } else if (c.relType === 'siblings') {
                  // í˜•ì œ ê´€ê³„ ì–‘ë°©í–¥ í•´ì œ
                  doc.relations.siblings = (doc.relations.siblings || []).filter(id => id !== c.targetId);
                  const sibDoc = store.documents[c.targetId];
                  if (sibDoc?.relations?.siblings) {
                    sibDoc.relations.siblings = sibDoc.relations.siblings.filter(id => id !== docId);
                  }
                } else if (c.relType === 'reference_in') {
                  // ë“¤ì–´ì˜¤ëŠ” ì°¸ì¡° í•´ì œ
                  const refDoc = store.documents[c.targetId];
                  if (refDoc?.relations?.references) {
                    refDoc.relations.references = refDoc.relations.references.filter(id => id !== docId);
                  }
                }
              } else {
                keptCount++;
              }
            });

            // 3. ìì‹ ë¬¸ì„œë„ ë„ë©”ì¸ ì´ë™ (ìë™)
            const children = doc.relations?.children || [];
            children.forEach(childId => {
              const childDoc = store.documents[childId];
              if (childDoc) {
                childDoc.domain = newDomain;
                const childCls = childDoc.classification || {};
                const childNewCls = {};
                Object.entries(childCls).forEach(([k, v]) => {
                  if (newFacets.has(k)) childNewCls[k] = v;
                });
                childDoc.classification = childNewCls;
                childDoc.updatedAt = new Date().toISOString();
              }
            });

            saveStore();
            moveModal.show = false;

            const msg = `ì´ë™ ì™„ë£Œ: ${oldDomain} â†’ ${newDomain}` +
              (severedCount > 0 ? ` (ê´€ê³„ í•´ì œ ${severedCount}ê±´)` : '') +
              (keptCount > 0 ? ` (ê´€ê³„ ìœ ì§€ ${keptCount}ê±´)` : '');
            showToast(msg, 'success');
          }

          function deleteDocument(id) {
            if (!confirm(`"${store.documents[id]?.name}" ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            Object.values(store.documents).forEach((doc) => {
              if (doc.relations?.parent === id) doc.relations.parent = null;
              if (doc.relations?.children) doc.relations.children = doc.relations.children.filter((c) => c !== id);
              if (doc.relations?.siblings) doc.relations.siblings = doc.relations.siblings.filter((s) => s !== id);
              if (doc.relations?.references)
                doc.relations.references = doc.relations.references.filter((r) => r !== id);
            });

            delete store.documents[id];
            if (selectedDocId.value === id) {
              selectedDocId.value = null;
              highlightedDocs.value = [];
            }
            saveStore();
            showToast('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          }

          function addSiblingRelation(event) {
            const sibId = event.target.value;
            if (!sibId || !selectedDoc.value) return;

            if (!selectedDoc.value.relations) selectedDoc.value.relations = { siblings: [], references: [] };
            if (!selectedDoc.value.relations.siblings) selectedDoc.value.relations.siblings = [];

            if (!selectedDoc.value.relations.siblings.includes(sibId)) {
              selectedDoc.value.relations.siblings.push(sibId);
            }
            if (store.documents[sibId]) {
              if (!store.documents[sibId].relations)
                store.documents[sibId].relations = { siblings: [], references: [] };
              if (!store.documents[sibId].relations.siblings) store.documents[sibId].relations.siblings = [];
              if (!store.documents[sibId].relations.siblings.includes(selectedDocId.value)) {
                store.documents[sibId].relations.siblings.push(selectedDocId.value);
              }
            }

            event.target.value = '';
            saveStore();
            showToast('í˜•ì œ ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          }

          function removeSiblingRelation(sibId) {
            if (!selectedDoc.value?.relations?.siblings) return;
            selectedDoc.value.relations.siblings = selectedDoc.value.relations.siblings.filter((s) => s !== sibId);

            if (store.documents[sibId]?.relations?.siblings) {
              store.documents[sibId].relations.siblings = store.documents[sibId].relations.siblings.filter(
                (s) => s !== selectedDocId.value,
              );
            }

            saveStore();
          }

          function addReference(event) {
            const refId = event.target.value;
            if (!refId || !selectedDoc.value) return;

            if (!selectedDoc.value.relations) selectedDoc.value.relations = { siblings: [], references: [] };
            if (!selectedDoc.value.relations.references) selectedDoc.value.relations.references = [];

            if (!selectedDoc.value.relations.references.includes(refId)) {
              selectedDoc.value.relations.references.push(refId);
            }

            event.target.value = '';
            saveStore();
            showToast('ì°¸ì¡° ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          }

          function removeReference(refId) {
            if (!selectedDoc.value?.relations?.references) return;
            selectedDoc.value.relations.references = selectedDoc.value.relations.references.filter((r) => r !== refId);
            saveStore();
          }

          function setParent(event) {
            const parentId = event.target.value;
            if (!parentId || !selectedDoc.value) return;

            // ê¸°ì¡´ ë¶€ëª¨ì—ì„œ ìì‹ ì œê±°
            if (selectedDoc.value.relations?.parent) {
              const oldParent = store.documents[selectedDoc.value.relations.parent];
              if (oldParent?.relations?.children) {
                oldParent.relations.children = oldParent.relations.children.filter((c) => c !== selectedDocId.value);
              }
            }

            if (!selectedDoc.value.relations)
              selectedDoc.value.relations = { parent: null, children: [], siblings: [], references: [] };
            selectedDoc.value.relations.parent = parentId;

            // ìƒˆ ë¶€ëª¨ì— ìì‹ ì¶”ê°€
            const newParent = store.documents[parentId];
            if (newParent) {
              if (!newParent.relations)
                newParent.relations = { parent: null, children: [], siblings: [], references: [] };
              if (!newParent.relations.children) newParent.relations.children = [];
              if (!newParent.relations.children.includes(selectedDocId.value)) {
                newParent.relations.children.push(selectedDocId.value);
              }
            }

            event.target.value = '';
            saveStore();
            showToast('ë¶€ëª¨ ê´€ê³„ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          }

          function removeParent() {
            if (!selectedDoc.value?.relations?.parent) return;
            const parentId = selectedDoc.value.relations.parent;

            const parent = store.documents[parentId];
            if (parent?.relations?.children) {
              parent.relations.children = parent.relations.children.filter((c) => c !== selectedDocId.value);
            }

            selectedDoc.value.relations.parent = null;
            saveStore();
          }

          function addChild(event) {
            const childId = event.target.value;
            if (!childId || !selectedDoc.value) return;

            if (!selectedDoc.value.relations)
              selectedDoc.value.relations = { parent: null, children: [], siblings: [], references: [] };
            if (!selectedDoc.value.relations.children) selectedDoc.value.relations.children = [];

            if (!selectedDoc.value.relations.children.includes(childId)) {
              selectedDoc.value.relations.children.push(childId);
            }

            // ìì‹ ìª½ì— ë¶€ëª¨ ì„¤ì •
            const child = store.documents[childId];
            if (child) {
              if (!child.relations) child.relations = { parent: null, children: [], siblings: [], references: [] };
              child.relations.parent = selectedDocId.value;
            }

            event.target.value = '';
            saveStore();
            showToast('ìì‹ ê´€ê³„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          }

          function removeChild(childId) {
            if (!selectedDoc.value?.relations?.children) return;
            selectedDoc.value.relations.children = selectedDoc.value.relations.children.filter((c) => c !== childId);

            const child = store.documents[childId];
            if (child?.relations?.parent === selectedDocId.value) {
              child.relations.parent = null;
            }

            saveStore();
          }

          function setSupersedes(event) {
            const oldProductId = event.target.value;
            if (!oldProductId) return;
            const product = store.taxonomy.products[selectedTaxonomy.id];
            if (product) {
              product.supersedes = oldProductId;
              saveStore();
              showToast('ì´ì „ ìƒí’ˆ ê´€ê³„ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
            event.target.value = '';
          }

          function removeSupersedes() {
            const product = store.taxonomy.products[selectedTaxonomy.id];
            if (product) {
              delete product.supersedes;
              saveStore();
            }
          }

          function getSupersededBy(productId) {
            return Object.entries(store.taxonomy.products)
              .filter(([id, p]) => p.supersedes === productId)
              .map(([id]) => id);
          }

          function getDocCountByProduct(productId) {
            return Object.values(store.documents).filter((d) => getDocProduct(d) === productId).length;
          }

          function getDocsByProduct(productId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              if (getDocProduct(doc) === productId) docs[id] = doc;
            });
            return docs;
          }

          function exportData() {
            const blob = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kms_data_v3.0_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
          }

          function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                if (data.graph_data) {
                  Object.assign(store, migrateFromKnowledgeGraphV21(data));
                } else if (data.carriers && data.doc_types) {
                  Object.assign(store, migrateFromTaxonomyV21(data));
                } else if (data.taxonomy && data.documents) {
                  Object.assign(store, data);
                } else {
                  throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” í˜•ì‹');
                }
                saveStore();
                showToast('ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
              } catch (err) {
                showToast('ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜: ' + err.message, 'error');
              }
            };
            reader.readAsText(file);
            event.target.value = '';
          }

          // Helper functions
          function getCarrierName(id) {
            return store.taxonomy.carriers[id]?.name || id;
          }
          function getProductName(id) {
            return store.taxonomy.products[id]?.name || id;
          }
          function getDocTypeName(id) {
            return store.taxonomy.docTypes[id]?.name || id;
          }
          function getProcessName(id) {
            return store.taxonomy.processes[id]?.name || id || '-';
          }
          function getAudienceName(id) {
            return store.taxonomy.audiences[id]?.name || id || '-';
          }
          function getDocName(id) {
            return store.documents[id]?.name || id;
          }

          function getDocCountByCarrier(carrierId) {
            return Object.values(store.documents).filter((d) => getDocCarrier(d) === carrierId).length;
          }

          function getDocCountByCarrierTier(carrierId, tier) {
            return Object.values(store.documents).filter((d) => getDocCarrier(d) === carrierId && d.tier === tier).length;
          }

          function getDocCountByProcess(processId) {
            return Object.values(store.documents).filter((d) => getDocMeta(d, 'process') === processId).length;
          }

          function getDocCountByAudience(audienceId) {
            return Object.values(store.documents).filter((d) => getDocMeta(d, 'audience') === audienceId).length;
          }

          function getDocsByProcess(processId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              if (getDocMeta(doc, 'process') === processId) docs[id] = doc;
            });
            return docs;
          }

          function getDocsByAudience(audienceId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              if (getDocMeta(doc, 'audience') === audienceId) docs[id] = doc;
            });
            return docs;
          }

          function getDocCountByDocType(docTypeId) {
            return Object.values(store.documents).filter((d) => getDocDocType(d) === docTypeId).length;
          }

          function getDocsByDocType(docTypeId) {
            const docs = {};
            Object.entries(store.documents).forEach(([id, doc]) => {
              if (getDocDocType(doc) === docTypeId) docs[id] = doc;
            });
            return docs;
          }

          function getProductsByCertification(certId) {
            const prds = {};
            Object.entries(store.taxonomy.products || {}).forEach(([id, prd]) => {
              if (prd.requires_license === certId) prds[id] = prd;
            });
            return prds;
          }

          function getTierClass(tier) {
            const classes = {
              HOT: 'bg-red-100 text-red-700',
              WARM: 'bg-yellow-100 text-yellow-700',
              COLD: 'bg-gray-100 text-gray-700',
            };
            return classes[tier] || 'bg-gray-100 text-gray-600';
          }

          function formatDate(isoString) {
            if (!isoString) return '-';
            return new Date(isoString).toLocaleString('ko-KR', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
            });
          }

          function getDaysUntil(dateStr) {
            const target = new Date(dateStr);
            const today = new Date();
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            return diff > 0 ? diff : 0;
          }

          function getRegulationStatusClass(status) {
            return status === 'active' ? 'bg-green-500 border-green-500' : 'bg-white border-yellow-500';
          }

          function getRegulationBorderClass(impact) {
            if (impact === 'critical') return 'border-red-500';
            if (impact === 'high') return 'border-orange-500';
            return 'border-blue-500';
          }

          return {
            store,
            activeTab,
            viewMode,
            graphMode,
            searchQuery,
            appliedSearch,
            selectedDocId,
            selectedDoc,
            selectedTaxonomy,
            modal,
            docModal,
            uploadPreview,
            highlightedDocs,
            toasts,
            carrierTypeFilter,
            productCategoryFilter,
            docTypeTierFilter,
            filterProcess,
            filterAudience,
            filteredCarriers,
            filteredProducts,
            filteredDocTypes,
            sortedProcesses,
            sortedAudiences,
            filteredDocuments,
            availableParents,
            availableChildren,
            availableSiblings,
            availableReferences,
            duplicateGroups,
            dashboard,
            upcomingRegulation,
            removeToast,
            showToast,
            saveStore,
            rebuildGraph,
            fitGraph,
            highlightRelatedDocs,
            getRelatedDocIds,
            applySearch,
            clearSearch,
            clearSelection,
            selectDocument,
            selectTaxonomy,
            checkDocModalDuplicate,
            handleFileUpload,
            showAddModal,
            addTaxonomy,
            showAddDocModal,
            onDocModalDomainChange,
            createDocument,
            moveModal,
            showMoveConfirm,
            executeMoveWithResolution,
            deleteDocument,
            domainHasFacet,
            addSiblingRelation,
            removeSiblingRelation,
            addReference,
            removeReference,
            setParent,
            removeParent,
            addChild,
            removeChild,
            setSupersedes,
            removeSupersedes,
            getSupersededBy,
            getDocCountByProduct,
            getDocsByProduct,
            checkUploadDuplicate,
            createFromUpload,
            exportData,
            importData,
            getCarrierName,
            getProductName,
            getDocTypeName,
            getProcessName,
            getAudienceName,
            getDocName,
            getDocCountByCarrier,
            getDocCountByCarrierTier,
            getDocCountByProcess,
            getDocCountByAudience,
            getDocsByProcess,
            getDocsByAudience,
            getDocCountByDocType,
            getDocsByDocType,
            getProductsByCertification,
            getTierClass,
            formatDate,
            getDaysUntil,
            getRegulationStatusClass,
            getRegulationBorderClass,
            getTaxonomyItem,
            getTaxonomyItemName,
            getTaxonomyTypeLabel,
            setTaxonomyField,
            filterLifecycle,
            lifecycleCounts,
            getDocCarrier,
            getDocProduct,
            getDocDocType,
            getDocMeta,
            setDocClassification,
            setDocMeta,
            calcFreshness,
            getNextLifecycleStates,
            transitionLifecycle,
            getLifecycleClass,
            getFreshnessClass,
            startAxis,
            AXIS_OPTIONS,
            setStartAxis,
            listDrillPath,
            drillTo,
            getFilteredDocsForDrill,
            getSubCategoriesForDrill,
            getDrillCategoryName,
          };
        },
      }).mount('#app');
    </script>
  </body>
</html>
